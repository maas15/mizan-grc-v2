{% extends "base.html" %}
{% block content %}
<div class="app-layout {{ 'rtl-layout' if is_rtl else '' }}">
    <aside class="sidebar {{ 'sidebar-right' if is_rtl else 'sidebar-left' }}">
        <div class="sidebar-brand"><a href="{{ url_for('dashboard', lang=lang) }}"><img src="{{ url_for('static', filename='images/logo.png') }}" alt="Mizan Logo" class="sidebar-logo"></a></div>
        <div class="sidebar-controls">
            <div class="sidebar-lang">
                <a href="{{ url_for('domain_page', domain_name=domain_name, lang='en') }}" class="lang-btn {{ 'active' if lang == 'en' else '' }}">EN</a>
                <a href="{{ url_for('domain_page', domain_name=domain_name, lang='ar') }}" class="lang-btn {{ 'active' if lang == 'ar' else '' }}">Ø¹</a>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"><i class="fas fa-sun"></i></button>
        </div>
        <a href="{{ url_for('dashboard', lang=lang) }}" class="back-btn"><i class="fas fa-arrow-{{ 'right' if is_rtl else 'left' }}"></i> {% if is_rtl %}Ø§Ù„Ø¹ÙˆØ¯Ø©{% else %}Back{% endif %}</a>
        <a href="{{ url_for('document_history', lang=lang) }}" class="history-link"><i class="fas fa-folder-open"></i> {{ txt.my_documents }}</a>
        <div class="user-info">
            <div class="user-avatar"><i class="fas fa-user"></i></div>
            <div class="user-details">
                <span class="user-label">{{ txt.logged_in_as }}</span>
                <span class="user-name">{{ username }}</span>
                {% if session.get('role') == 'admin' %}<a href="{{ url_for('admin_dashboard') }}" class="admin-link"><i class="fas fa-crown"></i></a>{% endif %}
            </div>
        </div>
        <div class="ai-status {{ 'connected' if ai_available else 'disconnected' }}"><div class="status-dot"></div><span>{{ txt.ai_connected if ai_available else txt.ai_disconnected }}</span></div>
        <a href="{{ url_for('logout') }}" class="logout-btn"><i class="fas fa-sign-out-alt"></i> {{ txt.logout }}</a>
        <div class="sidebar-footer"><p class="created-by">{{ txt.created_by }}</p><p class="creator-name">{{ config.CREATOR_NAME_AR if is_rtl else config.CREATOR_NAME }}</p><p class="copyright">Â© {{ config.COPYRIGHT_YEAR }}</p></div>
    </aside>
    <main class="main-content">
        <header class="domain-header">
            <h1>{{ domain_name }}</h1>
            <div class="usage-limits-bar">
                <div class="usage-item"><span class="usage-label">{{ 'Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©' if is_rtl else 'Strategy' }}</span><span class="usage-count {{ 'limit-reached' if usage_info.strategies.remaining == 0 else '' }}">{{ usage_info.strategies.used }}/{{ usage_info.strategies.limit }}</span></div>
                <div class="usage-item"><span class="usage-label">{{ 'Ø³ÙŠØ§Ø³Ø§Øª' if is_rtl else 'Policies' }}</span><span class="usage-count {{ 'limit-reached' if usage_info.policies.remaining == 0 else '' }}">{{ usage_info.policies.used }}/{{ usage_info.policies.limit }}</span></div>
                <div class="usage-item"><span class="usage-label">{{ 'ØªØ¯Ù‚ÙŠÙ‚' if is_rtl else 'Audits' }}</span><span class="usage-count {{ 'limit-reached' if usage_info.audits.remaining == 0 else '' }}">{{ usage_info.audits.used }}/{{ usage_info.audits.limit }}</span></div>
                <div class="usage-item"><span class="usage-label">{{ 'Ù…Ø®Ø§Ø·Ø±' if is_rtl else 'Risks' }}</span><span class="usage-count {{ 'limit-reached' if usage_info.risks.remaining == 0 else '' }}">{{ usage_info.risks.used }}/{{ usage_info.risks.limit }}</span></div>
            </div>
        </header>
        <!-- Tabs -->
        <div class="tabs" {% if is_rtl %}style="display: flex; flex-direction: row-reverse;"{% endif %}>
            {% if is_rtl %}
            <button class="tab" data-tab="awareness" style="flex-direction: row-reverse;"><i class="fas fa-graduation-cap"></i> {% if is_rtl %}Ø§Ù„ØªÙˆØ¹ÙŠØ©{% else %}Awareness{% endif %}</button>
            {% if domain_code == 'erm' %}<button class="tab" data-tab="register" style="flex-direction: row-reverse;"><i class="fas fa-th-list"></i> {% if is_rtl %}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Register{% endif %}</button>{% endif %}
            <button class="tab" data-tab="risk" style="flex-direction: row-reverse;"><i class="fas fa-exclamation-triangle"></i> {{ txt.tabs[3] }}</button>
            <button class="tab" data-tab="audit" style="flex-direction: row-reverse;"><i class="fas fa-clipboard-check"></i> {{ txt.tabs[2] }}</button>
            <button class="tab" data-tab="policy" style="flex-direction: row-reverse;"><i class="fas fa-file-alt"></i> {{ txt.tabs[1] }}</button>
            <button class="tab active" data-tab="strategy" style="flex-direction: row-reverse;"><i class="fas fa-chess"></i> {{ txt.tabs[0] }}</button>
            {% else %}
            <button class="tab active" data-tab="strategy"><i class="fas fa-chess"></i> {{ txt.tabs[0] }}</button>
            <button class="tab" data-tab="policy"><i class="fas fa-file-alt"></i> {{ txt.tabs[1] }}</button>
            <button class="tab" data-tab="audit"><i class="fas fa-clipboard-check"></i> {{ txt.tabs[2] }}</button>
            <button class="tab" data-tab="risk"><i class="fas fa-exclamation-triangle"></i> {{ txt.tabs[3] }}</button>
            {% if domain_code == 'erm' %}<button class="tab" data-tab="register"><i class="fas fa-th-list"></i> {% if is_rtl %}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Register{% endif %}</button>{% endif %}
            <button class="tab" data-tab="awareness"><i class="fas fa-graduation-cap"></i> {% if is_rtl %}Ø§Ù„ØªÙˆØ¹ÙŠØ©{% else %}Awareness{% endif %}</button>
            {% endif %}
        </div>
        <!-- Strategy Tab -->
        <div class="tab-content active" id="strategy-tab">
            <form id="strategy-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                <div class="form-row">
                    <div class="form-group"><label>{{ txt.org_name }}</label><input type="text" name="org_name" value="{% if is_rtl %}Ù…Ù†Ø¸Ù…ØªÙŠ{% else %}My Organization{% endif %}" required></div>
                    <div class="form-group"><label>{{ txt.sector }}</label><select name="sector" required>{% for sector in txt.sectors %}<option value="{{ sector }}">{{ sector }}</option>{% endfor %}</select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>{{ txt.size }}</label><select name="size" required>{% for size in txt.sizes %}<option value="{{ size }}">{{ size }}</option>{% endfor %}</select></div>
                    <div class="form-group"><label>{{ txt.budget }}</label><select name="budget" required>{% for budget in txt.budgets %}<option value="{{ budget }}">{{ budget }}</option>{% endfor %}</select></div>
                </div>
                <div class="form-group">
                    <label>{{ txt.frameworks }}</label>
                    <div class="frameworks-container">
                        {% if frameworks is mapping %}
                        {% for region, region_frameworks in frameworks.items() %}
                        <div class="framework-region">
                            <div class="region-header" onclick="toggleRegion(this)">
                                <i class="fas fa-chevron-right region-chevron"></i>
                                <strong>{% if is_rtl %}{% if region == 'KSA' %}ğŸ‡¸ğŸ‡¦ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©{% elif region == 'GCC' %}ğŸŒ Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¹Ø±Ø¨ÙŠ{% elif region == 'EU' %}ğŸ‡ªğŸ‡º Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ{% elif region == 'US' %}ğŸ‡ºğŸ‡¸ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©{% elif region == 'International' %}ğŸŒ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©{% elif region == 'Quality & Management' %}ğŸ“‹ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©{% elif region == 'Business Continuity' %}ğŸ”„ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„{% elif region == 'Audit & Assurance' %}âœ… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯{% elif region == 'Governance' %}ğŸ›ï¸ Ø§Ù„Ø­ÙˆÙƒÙ…Ø©{% elif region == 'Sector-Specific' %}ğŸ¢ Ù‚Ø·Ø§Ø¹ÙŠ{% elif region == 'International Standards' %}ğŸŒ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©{% elif region == 'Financial Risk' %}ğŸ’° Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø§Ù„ÙŠØ©{% elif region == 'Operational Risk' %}âš™ï¸ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©{% elif region == 'Regional' %}ğŸ—ºï¸ Ø¥Ù‚Ù„ÙŠÙ…ÙŠ{% else %}{{ region }}{% endif %}{% else %}{% if region == 'KSA' %}ğŸ‡¸ğŸ‡¦ Saudi Arabia (KSA){% elif region == 'GCC' %}ğŸŒ Gulf Cooperation Council (GCC){% elif region == 'EU' %}ğŸ‡ªğŸ‡º European Union (EU){% elif region == 'US' %}ğŸ‡ºğŸ‡¸ United States (US){% elif region == 'International' %}ğŸŒ International Standards{% elif region == 'Quality & Management' %}ğŸ“‹ Quality & Management{% elif region == 'Business Continuity' %}ğŸ”„ Business Continuity{% elif region == 'Audit & Assurance' %}âœ… Audit & Assurance{% elif region == 'Governance' %}ğŸ›ï¸ Governance{% elif region == 'Sector-Specific' %}ğŸ¢ Sector-Specific{% elif region == 'International Standards' %}ğŸŒ International Standards{% elif region == 'Financial Risk' %}ğŸ’° Financial Risk{% elif region == 'Operational Risk' %}âš™ï¸ Operational Risk{% elif region == 'Regional' %}ğŸ—ºï¸ Regional{% else %}{{ region }}{% endif %}{% endif %}</strong>
                                <span class="framework-count">({{ region_frameworks|length }})</span>
                            </div>
                            <div class="region-frameworks" style="display: none;">{% for framework in region_frameworks %}<label class="checkbox-label"><input type="checkbox" name="frameworks" value="{{ framework }}"><span>{{ framework }}</span></label>{% endfor %}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="checkbox-group">{% for framework in frameworks_flat %}<label class="checkbox-label"><input type="checkbox" name="frameworks" value="{{ framework }}"><span>{{ framework }}</span></label>{% endfor %}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fas fa-building"></i> {% if is_rtl %}ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ{% else %}Current State Assessment{% endif %}</h3>
                    <div class="form-group"><label>{% if is_rtl %}Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ{% else %}Current Organizational Structure{% endif %}</label>
                        <select name="org_structure">{% if is_rtl %}<option value="centralized">Ù…Ø±ÙƒØ²ÙŠ - ÙØ±ÙŠÙ‚ Ù…Ø±ÙƒØ²ÙŠ</option><option value="distributed">Ù…ÙˆØ²Ø¹ - ÙØ±Ù‚ ÙÙŠ ÙƒÙ„ Ù‚Ø³Ù…</option><option value="hybrid">Ù‡Ø¬ÙŠÙ† - Ù…Ø±ÙƒØ²ÙŠ Ù…Ø¹ Ù…Ù†Ø³Ù‚ÙŠÙ†</option><option value="outsourced">Ø®Ø§Ø±Ø¬ÙŠ - Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø§Øª</option><option value="none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡ÙŠÙƒÙ„ Ù…Ø­Ø¯Ø¯</option>{% else %}<option value="centralized">Centralized - Central Team</option><option value="distributed">Distributed - Teams in Each Department</option><option value="hybrid">Hybrid - Central with Coordinators</option><option value="outsourced">Outsourced - Managed Service Provider</option><option value="none">No Defined Structure</option>{% endif %}</select>
                    </div>
                    <div class="form-group"><label><i class="fas fa-cogs"></i> {% if is_rtl %}Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª ÙˆØ§Ù„Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹{% else %}Currently Implemented Technologies & Controls{% endif %}</label>
                        {% for category, techs in technologies.items() %}<div class="tech-category"><h4 class="tech-category-title">{{ category }}</h4><div class="checkbox-group tech-group">{% for tech in techs %}<label class="checkbox-label"><input type="checkbox" name="technologies" value="{{ tech }}"><span>{{ tech }}</span></label>{% endfor %}</div></div>{% endfor %}
                    </div>
                    <div class="form-group"><label>{% if is_rtl %}ØªÙ‚Ù†ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©{% else %}Additional Technologies{% endif %}</label><textarea name="additional_tech" rows="2" placeholder="{% if is_rtl %}Ø£Ø¯Ø®Ù„ Ø£ÙŠ ØªÙ‚Ù†ÙŠØ§Øª Ø£Ø®Ø±Ù‰...{% else %}Enter any other technologies...{% endif %}"></textarea></div>
                    <div class="form-group"><label>{% if is_rtl %}Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø¶Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ{% else %}Current Maturity Level{% endif %}</label>
                        <select name="maturity_level">{% if is_rtl %}<option value="initial">Ù…Ø¨Ø¯Ø¦ÙŠ (1)</option><option value="developing">Ù†Ø§Ù…Ù (2)</option><option value="defined">Ù…Ø­Ø¯Ø¯ (3)</option><option value="managed">Ù…ÙØ¯Ø§Ø± (4)</option><option value="optimized">Ù…Ø­Ø³Ù‘Ù† (5)</option>{% else %}<option value="initial">Initial (1) - Ad-hoc</option><option value="developing">Developing (2)</option><option value="defined">Defined (3)</option><option value="managed">Managed (4)</option><option value="optimized">Optimized (5)</option>{% endif %}</select>
                    </div>
                </div>
                <div class="form-group"><label>{{ txt.challenges }}</label><textarea name="challenges" rows="3" placeholder="{% if is_rtl %}ØµÙ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...{% else %}Describe key challenges...{% endif %}"></textarea></div>
                <div class="form-actions-row" style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                    <button type="submit" class="btn btn-primary" style="flex:1;"><i class="fas fa-magic"></i> {{ txt.generate }}</button>
                    <button type="button" class="btn btn-secondary" onclick="saveDraft('strategy')" title="{% if is_rtl %}Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©{% else %}Save Draft{% endif %}"><i class="fas fa-save"></i> {% if is_rtl %}Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©{% else %}Save Draft{% endif %}</button>
                    <button type="button" class="btn btn-outline draft-load-btn" onclick="loadDraft('strategy')" title="{% if is_rtl %}Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©{% else %}Load Draft{% endif %}" style="display:none;" id="strategy-load-draft-btn"><i class="fas fa-folder-open"></i> {% if is_rtl %}Ø§Ø³ØªØ¹Ø§Ø¯Ø©{% else %}Load{% endif %}</button>
                </div>
            </form>
            <!-- â•â•â• ENHANCEMENT 1: Strategy Enhancement Banner â•â•â• -->
            <div id="strategy-enhancement-banner" class="enhancement-banner" style="display:none;">
                <div class="enh-banner-row">
                    <div class="enh-badge enh-badge-guidelines"><i class="fas fa-map-signs"></i> {% if is_rtl %}ÙŠØªØ¶Ù…Ù† Ø®Ø·ÙˆØ§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØ¬ÙˆØ§Øª{% else %}Includes Gap Remediation Steps{% endif %}</div>
                    <div class="enh-badge enh-badge-kpi"><i class="fas fa-chart-line"></i> {% if is_rtl %}ÙŠØªØ¶Ù…Ù† Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ù‚ÙŠØ§Ø³ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡{% else %}Includes KPI Measurement Guidelines{% endif %}</div>
                    {% if domain_code == 'erm' %}<div class="enh-badge enh-badge-erm"><i class="fas fa-exclamation-triangle"></i> {% if is_rtl %}Ù…Ø­Ø³Ù‘Ù† Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ©{% else %}Enhanced for ERM{% endif %}</div>{% endif %}
                </div>
            </div>
            <div id="strategy-output" class="output-container hidden">
                <div class="output-tabs" {% if is_rtl %}style="display: flex; flex-direction: row-reverse;"{% endif %}>
                    {% if is_rtl %}<button class="output-tab" data-section="confidence">{{ txt.strategy_sections.confidence }}</button><button class="output-tab" data-section="kpis">{{ txt.strategy_sections.kpis }}</button><button class="output-tab" data-section="roadmap">{{ txt.strategy_sections.roadmap }}</button><button class="output-tab" data-section="pillars">{{ txt.strategy_sections.pillars }}</button><button class="output-tab" data-section="gaps">{{ txt.strategy_sections.gaps }}</button><button class="output-tab active" data-section="vision">{{ txt.strategy_sections.vision }}</button>
                    {% else %}<button class="output-tab active" data-section="vision">{{ txt.strategy_sections.vision }}</button><button class="output-tab" data-section="gaps">{{ txt.strategy_sections.gaps }}</button><button class="output-tab" data-section="pillars">{{ txt.strategy_sections.pillars }}</button><button class="output-tab" data-section="roadmap">{{ txt.strategy_sections.roadmap }}</button><button class="output-tab" data-section="kpis">{{ txt.strategy_sections.kpis }}</button><button class="output-tab" data-section="confidence">{{ txt.strategy_sections.confidence }}</button>{% endif %}
                </div>
                <div class="output-content" id="strategy-content"></div>
                <div class="download-buttons" {% if is_rtl %}style="flex-direction: row-reverse;"{% endif %}><button class="btn btn-secondary" onclick="downloadStrategy('txt')"><i class="fas fa-file-alt"></i> TXT</button><button class="btn btn-primary" onclick="downloadStrategy('docx')"><i class="fas fa-file-word"></i> Word</button><button class="btn btn-danger" onclick="downloadStrategy('pdf')"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn btn-info" onclick="printDocument('strategy')"><i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}</button></div>
                <div class="chat-section"><h4><i class="fas fa-comments"></i> {{ txt.chat_document }}</h4><div class="chat-messages" id="strategy-chat-messages"></div><div class="chat-input-row"><input type="text" id="strategy-chat-input" placeholder="{{ txt.ask_question }}" onkeypress="if(event.key==='Enter')sendChat('strategy')"><button class="btn btn-primary" onclick="sendChat('strategy')"><i class="fas fa-paper-plane"></i></button></div></div>
            </div>
        </div>
        <!-- Policy Tab -->
        <div class="tab-content hidden" id="policy-tab">
            <form id="policy-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}"><input type="hidden" name="language" value="{{ lang }}">
                <div class="template-btn-row"><button type="button" class="btn btn-outline" onclick="openTemplateModal('policy')"><i class="fas fa-folder-open"></i> {{ txt.use_template }}</button></div>
                <div class="form-row">
                    <div class="form-group"><label>{{ txt.policy_name }}</label><input type="text" name="policy_name" id="policy-name-input" placeholder="{% if is_rtl %}Ø³ÙŠØ§Ø³Ø© Ø£Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª{% else %}Information Security Policy{% endif %}" required></div>
                    <div class="form-group"><label>{% if is_rtl %}Ø§Ù„Ù…Ù†Ø·Ù‚Ø©{% else %}Region{% endif %}</label><select name="region" id="policy-region-select" required onchange="updatePolicyFrameworks()"><option value="">{% if is_rtl %}-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© --{% else %}-- Select Region --{% endif %}</option>{% for region in frameworks.keys() %}{% if is_rtl %}<option value="{{ region }}">{% if region == 'KSA' %}Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©{% elif region == 'GCC' %}Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¹Ø±Ø¨ÙŠ{% elif region == 'EU' %}Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ{% elif region == 'US' %}Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©{% elif region == 'International' %}Ø¯ÙˆÙ„ÙŠ{% else %}{{ region }}{% endif %}</option>{% else %}<option value="{{ region }}">{{ region }}</option>{% endif %}{% endfor %}</select></div>
                    <div class="form-group"><label>{{ txt.policy_framework }}</label><select name="framework" id="policy-framework-select" required><option value="">{% if is_rtl %}-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ --{% else %}-- Select Region First --{% endif %}</option></select></div>
                </div>
                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-file-alt"></i> {{ txt.generate_policy }}</button>
            </form>
            <!-- â•â•â• ENHANCEMENT 2: Dual-Model Provider Indicator â•â•â• -->
            <div class="dual-model-indicator" id="policy-dual-model" style="display:none;">
                <div class="dmi-row">
                    <div class="dmi-chip dmi-gen"><div class="dmi-dot dmi-dot-gen"></div><span class="dmi-label">{% if is_rtl %}Ø§Ù„ØªÙˆÙ„ÙŠØ¯{% else %}Generation{% endif %}</span><span class="dmi-provider" id="dmi-gen-name">â€”</span></div>
                    <div class="dmi-arrow"><i class="fas fa-{{ 'arrow-left' if is_rtl else 'arrow-right' }}"></i></div>
                    <div class="dmi-chip dmi-rev"><div class="dmi-dot dmi-dot-rev"></div><span class="dmi-label">{% if is_rtl %}Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©{% else %}Review{% endif %}</span><span class="dmi-provider" id="dmi-rev-name">â€”</span></div>
                    <div class="dmi-check" id="dmi-check" style="display:none;"><i class="fas fa-check-circle"></i> {% if is_rtl %}Ù†Ù…ÙˆØ°Ø¬ Ù…Ø®ØªÙ„Ù{% else %}Different Model{% endif %}</div>
                </div>
            </div>
            <div id="policy-output" class="output-container hidden">
                <div class="output-content policy-content" id="policy-content"></div>
                <div class="download-buttons"><button class="btn btn-secondary" onclick="downloadPolicy('txt')"><i class="fas fa-file-alt"></i> TXT</button><button class="btn btn-primary" onclick="downloadPolicy('docx')"><i class="fas fa-file-word"></i> Word</button><button class="btn btn-danger" onclick="downloadPolicy('pdf')"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn btn-info" onclick="printDocument('policy')"><i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}</button><button class="btn btn-warning" onclick="openReviewModal()"><i class="fas fa-search"></i> {{ txt.review_policy }}</button></div>
                <div id="policy-review-output" class="review-output hidden"><h4><i class="fas fa-clipboard-check"></i> {{ txt.review_policy }}</h4><div class="review-content" id="policy-review-content"></div><div style="margin-top:1rem;display:flex;gap:0.75rem;"><button class="btn btn-primary" onclick="applyReviewToPolicy()"><i class="fas fa-magic"></i> {% if is_rtl %}ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø­Ø³Ø¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©{% else %}Modify Policy Based on Review{% endif %}</button><button class="btn btn-secondary" onclick="document.getElementById('policy-review-output').classList.add('hidden')"><i class="fas fa-times"></i> {% if is_rtl %}Ø¥ØºÙ„Ø§Ù‚{% else %}Dismiss{% endif %}</button></div></div>
                <div class="chat-section"><h4><i class="fas fa-comments"></i> {{ txt.chat_document }}</h4><div class="chat-messages" id="policy-chat-messages"></div><div class="chat-input-row"><input type="text" id="policy-chat-input" placeholder="{{ txt.ask_question }}" onkeypress="if(event.key==='Enter')sendChat('policy')"><button class="btn btn-primary" onclick="sendChat('policy')"><i class="fas fa-paper-plane"></i></button></div></div>
            </div>
        </div>
        <!-- Audit Tab -->
        <div class="tab-content hidden" id="audit-tab">
            <form id="audit-form" class="grc-form" enctype="multipart/form-data">
                <input type="hidden" name="domain" value="{{ domain_name }}"><input type="hidden" name="language" value="{{ lang }}">
                <div class="template-btn-row"><button type="button" class="btn btn-outline" onclick="openTemplateModal('audit')"><i class="fas fa-folder-open"></i> {{ txt.use_template }}</button></div>
                <div class="form-row">
                    <div class="form-group"><label>{% if is_rtl %}Ø§Ù„Ù…Ù†Ø·Ù‚Ø©{% else %}Region{% endif %}</label><select name="audit_region" id="audit-region-select" required onchange="updateAuditFrameworks()"><option value="">{% if is_rtl %}-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© --{% else %}-- Select Region --{% endif %}</option>{% for region in frameworks.keys() %}{% if is_rtl %}<option value="{{ region }}">{% if region == 'KSA' %}Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©{% elif region == 'GCC' %}Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¹Ø±Ø¨ÙŠ{% elif region == 'EU' %}Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ{% elif region == 'US' %}Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©{% elif region == 'International' %}Ø¯ÙˆÙ„ÙŠ{% else %}{{ region }}{% endif %}</option>{% else %}<option value="{{ region }}">{{ region }}</option>{% endif %}{% endfor %}</select></div>
                    <div class="form-group"><label>{% if is_rtl %}Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚{% else %}Audit Standard{% endif %}</label><select name="framework" id="audit-framework-select" required onchange="updateFrameworkLock()"><option value="">{% if is_rtl %}-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ --{% else %}-- Select Region First --{% endif %}</option></select></div>
                </div>
                <div class="form-row"><div class="form-group"><label>{% if is_rtl %}Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚{% else %}Audit Topic{% endif %}</label><input type="text" name="audit_topic" id="audit-topic-input" placeholder="{% if is_rtl %}Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŒ Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØµÙˆÙ„{% else %}e.g. Email Policy, Access Controls{% endif %}"></div></div>
                <div class="form-row"><div class="form-group"><label>{% if is_rtl %}Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚{% else %}Audit Scope{% endif %}</label><select name="audit_scope" id="audit-scope-select">{% if is_rtl %}<option value="full">ØªØ¯Ù‚ÙŠÙ‚ Ø´Ø§Ù…Ù„</option><option value="controls">ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ÙˆØ§Ø¨Ø·</option><option value="compliance">ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</option>{% else %}<option value="full">Full Audit</option><option value="controls">Controls Audit</option><option value="compliance">Compliance Audit</option>{% endif %}</select></div></div>
                <!-- â•â•â• ENHANCEMENT 3: Framework Lock Banner â•â•â• -->
                <div class="framework-lock-banner" id="fw-lock-banner" style="display:none;">
                    <div class="fwl-icon"><i class="fas fa-lock"></i></div>
                    <div class="fwl-body"><div class="fwl-title"><span id="fwl-framework-name">â€”</span><span class="fwl-only">{% if is_rtl %}ÙÙ‚Ø·{% else %}ONLY{% endif %}</span></div><p class="fwl-desc">{% if is_rtl %}Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¬ÙˆØ§Øª ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª Ø³ØªØ´ÙŠØ± Ø­ØµØ±ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯.{% else %}All gaps and recommendations will reference this framework exclusively.{% endif %}</p></div>
                    <div class="fwl-badge"><i class="fas fa-shield-alt"></i> {% if is_rtl %}Ù…Ù‚ÙŠÙ‘Ø¯{% else %}Locked{% endif %}</div>
                </div>
                <div class="form-group"><label><i class="fas fa-upload"></i> {% if is_rtl %}Ø±ÙØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚ (PDF, Word, Ù†Øµ){% else %}Upload Document to Audit (PDF, Word, Text){% endif %}</label><div class="file-upload-area" id="file-upload-area"><input type="file" name="evidence" id="evidence-file" accept=".pdf,.docx,.doc,.txt,.md,.csv" multiple><div class="file-upload-content"><i class="fas fa-cloud-upload-alt"></i><p>{% if is_rtl %}Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø§Ù†Ù‚Ø±{% else %}Drag files or click{% endif %}</p></div></div><div id="uploaded-files" class="uploaded-files-list"></div></div>
                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-clipboard-check"></i> {% if is_rtl %}Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚{% else %}Generate Audit Report{% endif %}</button>
            </form>
            <div id="audit-output" class="output-container hidden">
                <div class="audit-output-header"><span class="audit-lock-tag" id="audit-lock-tag" style="display:none;"><i class="fas fa-lock"></i> <span id="audit-lock-tag-name">â€”</span> {% if is_rtl %}ÙÙ‚Ø·{% else %}only{% endif %}</span></div>
                <div class="output-content" id="audit-content"></div>
                <div class="audit-meta-bar" id="audit-meta-bar" style="display:none;"><div class="amb-item"><i class="fas fa-lock"></i> <span>{% if is_rtl %}Ø§Ù„Ø¥Ø·Ø§Ø±:{% else %}Framework:{% endif %}</span> <strong id="amb-framework">â€”</strong></div><div class="amb-item"><i class="fas fa-search"></i> <span>{% if is_rtl %}Ø§Ù„Ù†Ø·Ø§Ù‚:{% else %}Scope:{% endif %}</span> <strong id="amb-scope">â€”</strong></div><div class="amb-item"><i class="fas fa-globe"></i> <span>{% if is_rtl %}Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:{% else %}Region:{% endif %}</span> <strong id="amb-region">â€”</strong></div></div>
                <div class="download-buttons"><button class="btn btn-secondary" onclick="downloadAudit('txt')"><i class="fas fa-file-alt"></i> TXT</button><button class="btn btn-primary" onclick="downloadAudit('docx')"><i class="fas fa-file-word"></i> Word</button><button class="btn btn-danger" onclick="downloadAudit('pdf')"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn btn-info" onclick="printDocument('audit')"><i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}</button></div>
            </div>
        </div>

        <!-- Risk Tab -->
        <div class="tab-content hidden" id="risk-tab">
            <form id="risk-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}"><input type="hidden" name="language" value="{{ lang }}">
                <div class="template-btn-row"><button type="button" class="btn btn-outline" onclick="openTemplateModal('risk')"><i class="fas fa-folder-open"></i> {{ txt.use_template }}</button></div>
                <div class="form-row">
                    <div class="form-group"><label>{{ txt.risk_category }}</label><select name="category" id="risk-category" required>{% for cat, scenarios in risk_categories.items() %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}</select></div>
                    <div class="form-group"><label>{% if is_rtl %}Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ{% else %}Scenario{% endif %}</label><select name="scenario" id="risk-scenario"><option value="">{% if is_rtl %}Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ...{% else %}Select scenario...{% endif %}</option></select></div>
                </div>
                <div class="form-group"><label>{{ txt.asset_name }}</label><input type="text" name="asset" id="risk-asset-input" placeholder="{% if is_rtl %}Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡{% else %}Customer Database{% endif %}" required></div>
                <div class="form-group"><label>{% if is_rtl %}ÙˆØµÙ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªÙ‡Ø¯ÙŠØ¯{% else %}Additional Threat Description{% endif %}</label><textarea name="threat" id="risk-threat-input" rows="3" placeholder="{% if is_rtl %}ØµÙ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©...{% else %}Describe additional details...{% endif %}"></textarea></div>
                <div class="form-actions-row" style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                    <button type="submit" class="btn btn-primary" style="flex:1;"><i class="fas fa-search"></i> {{ txt.analyze_risk }}</button>
                    <button type="button" class="btn btn-secondary" onclick="saveDraft('risk')" title="{% if is_rtl %}Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©{% else %}Save Draft{% endif %}"><i class="fas fa-save"></i> {% if is_rtl %}Ø­ÙØ¸{% else %}Save{% endif %}</button>
                    <button type="button" class="btn btn-outline draft-load-btn" onclick="loadDraft('risk')" style="display:none;" id="risk-load-draft-btn"><i class="fas fa-folder-open"></i> {% if is_rtl %}Ø§Ø³ØªØ¹Ø§Ø¯Ø©{% else %}Load{% endif %}</button>
                </div>
            </form>
            <div id="risk-output" class="output-container hidden">
                <div class="output-content" id="risk-content"></div>
                <div class="download-buttons"><button class="btn btn-secondary" onclick="downloadRisk('txt')"><i class="fas fa-file-alt"></i> TXT</button><button class="btn btn-primary" onclick="downloadRisk('docx')"><i class="fas fa-file-word"></i> Word</button><button class="btn btn-danger" onclick="downloadRisk('pdf')"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn btn-info" onclick="printDocument('risk')"><i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}</button></div>
            </div>
        </div>
        {% if domain_code == 'erm' %}
        <!-- ERM Risk Register Tab -->
        <div class="tab-content hidden" id="register-tab">
            <div class="erm-workspace">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:0.75rem;">
                    <h3 style="margin:0;"><i class="fas fa-th-list"></i> {% if is_rtl %}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ©{% else %}Enterprise Risk Register{% endif %}</h3>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="openAddRiskModal()"><i class="fas fa-plus"></i> {% if is_rtl %}Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø±{% else %}Add Risk{% endif %}</button>
                        <button class="btn btn-info" onclick="toggleHeatMap()"><i class="fas fa-fire"></i> {% if is_rtl %}Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©{% else %}Heat Map{% endif %}</button>
                        <button class="btn btn-warning" onclick="generateRiskAppetite()"><i class="fas fa-balance-scale"></i> {% if is_rtl %}Ø´Ù‡ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Appetite{% endif %}</button>
                        <button class="btn btn-secondary" onclick="exportRiskRegister()"><i class="fas fa-download"></i> {% if is_rtl %}ØªØµØ¯ÙŠØ±{% else %}Export{% endif %}</button>
                    </div>
                </div>
                <div id="risk-heatmap" class="hidden" style="margin-bottom:1.5rem;background:var(--card-bg);border-radius:12px;padding:1.5rem;border:1px solid var(--border-color);">
                    <h4 style="margin-top:0;text-align:center;">{% if is_rtl %}Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Heat Map{% endif %}</h4>
                    <div id="heatmap-grid" style="display:grid;grid-template-columns:auto repeat(5,1fr);grid-template-rows:repeat(6,auto);gap:2px;max-width:600px;margin:0 auto;font-size:0.8rem;">
                        <div style="padding:8px;font-weight:700;text-align:center;"></div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ù†Ø§Ø¯Ø±{% else %}Rare{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ø¨Ø¹ÙŠØ¯{% else %}Unlikely{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ù…Ø­ØªÙ…Ù„{% else %}Possible{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ù…Ø±Ø¬Ø­{% else %}Likely{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ø´Ø¨Ù‡ Ù…Ø¤ÙƒØ¯{% else %}Almost Certain{% endif %}</div>
                    </div>
                </div>
                <div id="register-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:1.5rem;">
                    <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:1rem;border-radius:10px;text-align:center;"><div style="font-size:1.8rem;font-weight:700;" id="stat-critical">0</div><div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ø­Ø±Ø¬{% else %}Critical{% endif %}</div></div>
                    <div style="background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;padding:1rem;border-radius:10px;text-align:center;"><div style="font-size:1.8rem;font-weight:700;" id="stat-high">0</div><div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ø¹Ø§Ù„ÙŠ{% else %}High{% endif %}</div></div>
                    <div style="background:linear-gradient(135deg,#eab308,#ca8a04);color:#fff;padding:1rem;border-radius:10px;text-align:center;"><div style="font-size:1.8rem;font-weight:700;" id="stat-medium">0</div><div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ù…ØªÙˆØ³Ø·{% else %}Medium{% endif %}</div></div>
                    <div style="background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;padding:1rem;border-radius:10px;text-align:center;"><div style="font-size:1.8rem;font-weight:700;" id="stat-low">0</div><div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ù…Ù†Ø®ÙØ¶{% else %}Low{% endif %}</div></div>
                    <div style="background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;padding:1rem;border-radius:10px;text-align:center;"><div style="font-size:1.8rem;font-weight:700;" id="stat-total">0</div><div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total{% endif %}</div></div>
                </div>
                <div style="overflow-x:auto;background:var(--card-bg);border-radius:12px;border:1px solid var(--border-color);">
                    <table id="risk-register-table" style="width:100%;border-collapse:collapse;font-size:0.9rem;">
                        <thead><tr style="background:var(--primary-color);color:#fff;"><th style="padding:12px 8px;">#</th><th style="padding:12px 8px;">{% if is_rtl %}Ø§Ø³Ù… Ø§Ù„Ø®Ø·Ø±{% else %}Risk Name{% endif %}</th><th style="padding:12px 8px;">{% if is_rtl %}Ø§Ù„ÙØ¦Ø©{% else %}Category{% endif %}</th><th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©{% else %}Likelihood{% endif %}</th><th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø§Ù„Ø£Ø«Ø±{% else %}Impact{% endif %}</th><th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø§Ù„Ø¯Ø±Ø¬Ø©{% else %}Score{% endif %}</th><th style="padding:12px 8px;">{% if is_rtl %}Ø§Ù„Ù…Ø§Ù„Ùƒ{% else %}Owner{% endif %}</th><th style="padding:12px 8px;">{% if is_rtl %}Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Treatment{% endif %}</th><th style="padding:12px 8px;">{% if is_rtl %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</th><th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th></tr></thead>
                        <tbody id="risk-register-body"><tr><td colspan="10" style="text-align:center;padding:2rem;color:#888;"><i class="fas fa-info-circle"></i> {% if is_rtl %}Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø·Ø± Ù…Ø³Ø¬Ù„Ø©.{% else %}No risks registered.{% endif %}</td></tr></tbody>
                    </table>
                </div>
                <div id="risk-appetite-output" class="hidden" style="margin-top:1.5rem;background:var(--card-bg);border-radius:12px;padding:1.5rem;border:1px solid var(--border-color);"><h4><i class="fas fa-balance-scale"></i> {% if is_rtl %}Ø¨ÙŠØ§Ù† Ø´Ù‡ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Appetite Statement{% endif %}</h4><div id="risk-appetite-content" class="output-content"></div><div class="download-buttons" style="margin-top:1rem;"><button class="btn btn-primary" onclick="downloadRiskAppetite('docx')"><i class="fas fa-file-word"></i> Word</button><button class="btn btn-danger" onclick="downloadRiskAppetite('pdf')"><i class="fas fa-file-pdf"></i> PDF</button></div></div>
            </div>
        </div>
        {% endif %}
        <!-- Awareness Tab -->
        <div class="tab-content hidden" id="awareness-tab">
            <div id="awareness-modules-view">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                    <div><h2 style="margin:0;font-size:1.4rem;"><i class="fas fa-graduation-cap" style="color:var(--primary);"></i> {{ 'ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙˆØ¹ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨' if is_rtl else 'Awareness & Training Modules' }}</h2><p style="margin:0.3rem 0 0;color:var(--text-secondary);font-size:0.9rem;">{{ 'ØªØ¹Ù„Ù… ÙˆØ£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª' if is_rtl else 'Learn, take quizzes, and earn badges' }}</p></div>
                    <div id="awareness-progress-bar" style="display:flex;align-items:center;gap:0.8rem;background:var(--bg-elevated);padding:0.6rem 1rem;border-radius:var(--radius-sm);"><span style="font-size:0.85rem;color:var(--text-secondary);">{{ 'Ø§Ù„ØªÙ‚Ø¯Ù…' if is_rtl else 'Progress' }}:</span><div style="width:120px;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;"><div id="awareness-progress-fill" style="width:0%;height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:4px;transition:width 0.5s;"></div></div><span id="awareness-progress-text" style="font-size:0.85rem;font-weight:600;">0%</span></div>
                </div>
                <div id="awareness-modules-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.2rem;"></div>
                {% if grc_professional_modules %}
                <div style="margin-top:2.5rem;padding-top:2rem;border-top:2px solid var(--border-color);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;"><div><h2 style="margin:0;font-size:1.3rem;"><i class="fas fa-user-tie" style="color:var(--secondary);"></i> {{ 'ØªØ¯Ø±ÙŠØ¨ Ù…Ø­ØªØ±ÙÙŠ GRC' if is_rtl else 'GRC Professional Training' }}</h2></div><span class="badge" style="background:linear-gradient(135deg,var(--secondary),var(--primary));color:white;padding:0.4rem 1rem;font-size:0.8rem;"><i class="fas fa-star"></i> {{ 'Ù„Ù„Ù…Ø­ØªØ±ÙÙŠÙ†' if is_rtl else 'Professional' }}</span></div>
                    <div id="grc-professional-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.2rem;">{% for module in grc_professional_modules %}<div class="awareness-card" onclick="startAwarenessModule('{{ module.id }}')" style="cursor:pointer;background:var(--bg-elevated);border-radius:var(--radius-md);padding:1.2rem;border:1px solid var(--border-color);"><div style="display:flex;align-items:flex-start;gap:1rem;"><div style="width:50px;height:50px;background:linear-gradient(135deg,var(--secondary),var(--primary));border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><i class="{{ module.icon }}" style="color:white;font-size:1.3rem;"></i></div><div style="flex:1;min-width:0;"><h4 style="margin:0 0 0.3rem;font-size:1rem;">{{ module.title }}</h4><p style="margin:0;font-size:0.8rem;color:var(--text-secondary);">{{ module.description[:80] }}...</p></div></div><div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;padding-top:0.8rem;border-top:1px solid var(--border-color);"><div style="display:flex;gap:0.8rem;font-size:0.75rem;color:var(--text-secondary);"><span><i class="fas fa-signal"></i> {{ module.level }}</span><span><i class="fas fa-clock"></i> {{ module.duration }}</span></div><span style="font-size:0.75rem;padding:0.2rem 0.6rem;border-radius:4px;background:var(--bg-secondary);color:var(--text-secondary);">{{ 'Ø§Ø¨Ø¯Ø£' if is_rtl else 'Start' }} <i class="fas fa-arrow-{{ 'left' if is_rtl else 'right' }}"></i></span></div></div>{% endfor %}</div>
                </div>
                {% endif %}
            </div>
            <div id="awareness-learn-view" class="hidden"><button class="btn" onclick="showAwarenessModules()" style="margin-bottom:1rem;"><i class="fas fa-arrow-{{ 'right' if is_rtl else 'left' }}"></i> {{ 'Ø§Ù„Ø¹ÙˆØ¯Ø©' if is_rtl else 'Back' }}</button><div id="awareness-learn-content" style="background:var(--bg-elevated);border-radius:var(--radius-lg);padding:2rem;border:1px solid var(--border-color);"></div></div>
            <div id="awareness-quiz-view" class="hidden"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><button class="btn" onclick="showAwarenessModules()"><i class="fas fa-arrow-{{ 'right' if is_rtl else 'left' }}"></i> {{ 'Ø§Ù„Ø¹ÙˆØ¯Ø©' if is_rtl else 'Back' }}</button><div id="quiz-progress-indicator" style="font-size:0.9rem;color:var(--text-secondary);"></div></div><div id="awareness-quiz-content" style="background:var(--bg-elevated);border-radius:var(--radius-lg);padding:2rem;border:1px solid var(--border-color);"></div></div>
            <div id="awareness-results-view" class="hidden"><div id="awareness-results-content" style="text-align:center;padding:2rem;"></div></div>
        </div>
    </main>
</div>

<div class="loading-overlay hidden" id="loading"><div class="loading-spinner"></div><p>{{ txt.generating }}</p></div>

<!-- Template Modal -->
<div class="modal-overlay hidden" id="template-modal"><div class="modal-content template-modal"><div class="modal-header"><h3><i class="fas fa-folder-open"></i> {{ txt.select_template }}</h3><button class="modal-close" onclick="closeTemplateModal()">&times;</button></div><div class="modal-body"><div class="template-list" id="template-list"></div></div></div></div>

<!-- Policy Review Modal -->
<div class="modal-overlay hidden" id="review-modal"><div class="modal-content template-modal"><div class="modal-header"><h3><i class="fas fa-search"></i> {{ txt.review_policy }}</h3><button class="modal-close" onclick="closeReviewModal()">&times;</button></div><div class="modal-body">
    <div class="form-group"><label>{{ txt.review_type }}</label><select id="review-type-select"><option value="comprehensive">{{ txt.comprehensive_review }}</option><option value="compliance">{{ txt.compliance_review }}</option><option value="gaps">{{ txt.gap_analysis }}</option></select></div>
    <!-- â•â•â• ENHANCEMENT 2: Review Model Notice â•â•â• -->
    <div class="review-model-notice" id="review-model-notice"><i class="fas fa-info-circle"></i><span>{% if is_rtl %}Ø³ØªØªÙ… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø²ÙˆØ¯ Ù…Ø®ØªÙ„Ù (<strong id="review-modal-provider">â€”</strong>) Ø¹Ù† Ù…Ø²ÙˆØ¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ (<strong id="generate-modal-provider">â€”</strong>) Ù„Ø¶Ù…Ø§Ù† ØªÙ‚ÙŠÙŠÙ… Ù…Ø³ØªÙ‚Ù„.{% else %}Review will use a different provider (<strong id="review-modal-provider">â€”</strong>) than generation (<strong id="generate-modal-provider">â€”</strong>) for independent evaluation.{% endif %}</span></div>
    <button class="btn btn-primary btn-block" onclick="startPolicyReview()"><i class="fas fa-play"></i> {{ txt.start_review }}</button>
</div></div></div>

{% if domain_code == 'erm' %}
<!-- Add Risk Modal -->
<div class="modal-overlay hidden" id="add-risk-modal"><div class="modal-content template-modal" style="max-width:600px;"><div class="modal-header"><h3><i class="fas fa-plus-circle"></i> {% if is_rtl %}Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø± Ø¬Ø¯ÙŠØ¯{% else %}Add New Risk{% endif %}</h3><button class="modal-close" onclick="closeAddRiskModal()">&times;</button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto;">
    <div class="form-group"><label>{% if is_rtl %}Ø§Ø³Ù… Ø§Ù„Ø®Ø·Ø±{% else %}Risk Name{% endif %} *</label><input type="text" id="risk-reg-name" required></div>
    <div class="form-group"><label>{% if is_rtl %}Ø§Ù„ÙˆØµÙ{% else %}Description{% endif %}</label><textarea id="risk-reg-desc" rows="2"></textarea></div>
    <div class="form-group"><label>{% if is_rtl %}Ø§Ù„ÙØ¦Ø©{% else %}Category{% endif %}</label><select id="risk-reg-category">{% if is_rtl %}<option value="Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ">Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</option><option value="ØªØ´ØºÙŠÙ„ÙŠ">ØªØ´ØºÙŠÙ„ÙŠ</option><option value="Ù…Ø§Ù„ÙŠ">Ù…Ø§Ù„ÙŠ</option><option value="Ø§Ù…ØªØ«Ø§Ù„">Ø§Ù…ØªØ«Ø§Ù„</option><option value="ØªÙ‚Ù†ÙŠ">ØªÙ‚Ù†ÙŠ</option><option value="Ø³Ù…Ø¹Ø©">Ø³Ù…Ø¹Ø©</option><option value="Ø¨ÙŠØ¦ÙŠ">Ø¨ÙŠØ¦ÙŠ</option><option value="Ù‚Ø§Ù†ÙˆÙ†ÙŠ">Ù‚Ø§Ù†ÙˆÙ†ÙŠ</option>{% else %}<option value="Strategic">Strategic</option><option value="Operational">Operational</option><option value="Financial">Financial</option><option value="Compliance">Compliance</option><option value="Technology">Technology</option><option value="Reputational">Reputational</option><option value="Environmental">Environmental</option><option value="Legal">Legal</option>{% endif %}</select></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div class="form-group"><label>{% if is_rtl %}Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©{% else %}Likelihood{% endif %} (1-5)</label><select id="risk-reg-likelihood"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div>
        <div class="form-group"><label>{% if is_rtl %}Ø§Ù„Ø£Ø«Ø±{% else %}Impact{% endif %} (1-5)</label><select id="risk-reg-impact"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div>
    </div>
    <div class="form-group"><label>{% if is_rtl %}Ù…Ø§Ù„Ùƒ Ø§Ù„Ø®Ø·Ø±{% else %}Risk Owner{% endif %}</label><input type="text" id="risk-reg-owner"></div>
    <div class="form-group"><label>{% if is_rtl %}Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Treatment Strategy{% endif %}</label><select id="risk-reg-treatment">{% if is_rtl %}<option value="ØªØ®ÙÙŠÙ">ØªØ®ÙÙŠÙ</option><option value="Ù†Ù‚Ù„">Ù†Ù‚Ù„</option><option value="ØªØ¬Ù†Ø¨">ØªØ¬Ù†Ø¨</option><option value="Ù‚Ø¨ÙˆÙ„">Ù‚Ø¨ÙˆÙ„</option>{% else %}<option value="Mitigate">Mitigate</option><option value="Transfer">Transfer</option><option value="Avoid">Avoid</option><option value="Accept">Accept</option>{% endif %}</select></div>
    <div class="form-group"><label>{% if is_rtl %}Ø®Ø·Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Treatment Plan{% endif %}</label><textarea id="risk-reg-plan" rows="2"></textarea></div>
    <div class="form-group"><label>{% if is_rtl %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</label><select id="risk-reg-status">{% if is_rtl %}<option value="Ù…ÙØªÙˆØ­">Ù…ÙØªÙˆØ­</option><option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option><option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option><option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>{% else %}<option value="Open">Open</option><option value="In Treatment">In Treatment</option><option value="Closed">Closed</option><option value="Accepted">Accepted</option>{% endif %}</select></div>
    <input type="hidden" id="risk-reg-edit-id" value="">
    <button class="btn btn-primary btn-block" onclick="saveRiskEntry()"><i class="fas fa-save"></i> {% if is_rtl %}Ø­ÙØ¸{% else %}Save{% endif %}</button>
</div></div></div>
{% endif %}

<!-- Gap Remediation Modal -->
<div class="modal-overlay hidden" id="remediation-modal"><div class="modal-content template-modal"><div class="modal-header"><h3><i class="fas fa-tools"></i> {{ txt.gap_remediation }}</h3><button class="modal-close" onclick="closeRemediationModal()">&times;</button></div><div class="modal-body"><div class="form-group"><label>{{ txt.enter_gaps }}</label><textarea id="gaps-input" rows="5"></textarea></div><button class="btn btn-primary btn-block" onclick="generateRemediationPlan()"><i class="fas fa-cogs"></i> {{ txt.generate_plan }}</button><div id="remediation-output" class="remediation-output hidden"><h4>{% if is_rtl %}Ø®Ø·Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Remediation Plan{% endif %}</h4><div id="remediation-content"></div></div></div></div></div>

<style>
.template-btn-row{margin-bottom:15px}.btn-outline{background:transparent;border:2px dashed var(--primary);color:var(--primary);padding:10px 20px;border-radius:8px;cursor:pointer;transition:all .3s}.btn-outline:hover{background:rgba(102,126,234,.1);border-style:solid}
.chat-section{margin-top:20px;padding:15px;background:var(--bg-elevated);border-radius:10px;border:1px solid var(--border)}.chat-section h4{margin:0 0 15px 0;color:var(--primary)}.chat-messages{max-height:200px;overflow-y:auto;margin-bottom:10px;padding:10px;background:var(--bg-card);border-radius:8px;min-height:60px}.chat-message{margin-bottom:10px;padding:8px 12px;border-radius:8px}.chat-message.user{background:var(--primary);color:white;margin-{{ 'right' if is_rtl else 'left' }}:20%}.chat-message.assistant{background:var(--bg-elevated);border:1px solid var(--border);margin-{{ 'left' if is_rtl else 'right' }}:20%}.chat-input-row{display:flex;gap:10px}.chat-input-row input{flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--bg-card);color:var(--text-primary)}.chat-input-row button{padding:10px 15px}
.review-output{margin-top:20px;padding:15px;background:var(--bg-elevated);border-radius:10px;border:1px solid var(--border)}.review-output h4{margin:0 0 15px 0;color:var(--warning)}.review-content{line-height:1.6}
.remediation-output{margin-top:20px;padding:15px;background:var(--bg-card);border-radius:8px;max-height:300px;overflow-y:auto}#gaps-input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--bg-card);color:var(--text-primary);resize:vertical}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(5px)}.modal-overlay.hidden{display:none}.template-modal{background:var(--bg-card);border-radius:16px;width:90%;max-width:600px;max-height:80vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,.5)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white}.modal-header h3{margin:0;font-size:1.2rem}.modal-close{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;opacity:.8}.modal-close:hover{opacity:1}.modal-body{padding:20px;max-height:60vh;overflow-y:auto}.template-list{display:flex;flex-direction:column;gap:12px}.template-item{background:var(--bg-elevated);border-radius:10px;padding:15px;cursor:pointer;transition:all .3s;border:2px solid transparent}.template-item:hover{border-color:var(--primary);transform:translateX(5px)}.template-item h4{margin:0 0 8px 0;color:var(--text-primary);display:flex;align-items:center;gap:10px}.template-item h4 i{color:var(--primary)}.template-item p{margin:0;font-size:.85rem;color:var(--text-secondary)}.template-item .template-meta{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}.template-tag{background:rgba(102,126,234,.2);color:var(--primary);padding:3px 10px;border-radius:12px;font-size:.75rem}.no-templates{text-align:center;padding:40px;color:var(--text-secondary)}
{% if is_rtl %}.template-item:hover{transform:translateX(-5px)}{% endif %}
.frameworks-container{max-height:400px;overflow-y:auto;border:1px solid var(--border-color);border-radius:8px;padding:10px}.framework-region{margin-bottom:8px;border:1px solid var(--border-color);border-radius:6px;overflow:hidden}.region-header{display:flex;align-items:center;gap:10px;padding:12px 15px;background:var(--bg-secondary);cursor:pointer;user-select:none;transition:background .2s}.region-header:hover{background:var(--bg-hover)}.region-chevron{transition:transform .2s;color:var(--primary);font-size:12px}.region-header.expanded .region-chevron{transform:rotate(90deg)}.framework-count{color:var(--text-secondary);font-size:12px;margin-{{ 'right' if is_rtl else 'left' }}:auto}.region-frameworks{padding:10px 15px;background:var(--bg-primary);border-top:1px solid var(--border-color)}.region-frameworks .checkbox-label{display:flex;align-items:center;gap:8px;padding:8px 10px;margin:4px 0;border-radius:4px;cursor:pointer;transition:background .2s}.region-frameworks .checkbox-label:hover{background:var(--bg-hover)}.region-frameworks input[type="checkbox"]{width:16px;height:16px;accent-color:var(--primary)}

/* â•â•â• ENHANCEMENT 1: Strategy Badges â•â•â• */
.enhancement-banner{margin:12px 0;padding:10px 14px;background:linear-gradient(135deg,rgba(99,102,241,.06),rgba(16,185,129,.04));border:1px solid rgba(99,102,241,.15);border-radius:10px}.enh-banner-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.enh-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;font-size:.78rem;font-weight:600}.enh-badge-guidelines{background:rgba(16,185,129,.1);color:#10b981;border:1px solid rgba(16,185,129,.2)}.enh-badge-kpi{background:rgba(59,130,246,.1);color:#3b82f6;border:1px solid rgba(59,130,246,.2)}.enh-badge-erm{background:rgba(245,158,11,.1);color:#f59e0b;border:1px solid rgba(245,158,11,.2)}

/* â•â•â• ENHANCEMENT 2: Dual-Model Indicator â•â•â• */
.dual-model-indicator{margin:10px 0 15px;padding:10px 14px;background:rgba(30,41,59,.4);border:1px solid rgba(99,102,241,.12);border-radius:10px}.dmi-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}.dmi-chip{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:8px;font-size:.8rem}.dmi-gen{background:rgba(14,165,233,.08);border:1px solid rgba(14,165,233,.18)}.dmi-rev{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.18)}.dmi-dot{width:8px;height:8px;border-radius:50%}.dmi-dot-gen{background:#0ea5e9}.dmi-dot-rev{background:#f59e0b}.dmi-label{color:var(--text-muted,#94a3b8);font-size:.75rem}.dmi-provider{font-weight:700;color:var(--text-primary,#e2e8f0)}.dmi-arrow{color:var(--text-muted,#64748b);font-size:.7rem}.dmi-check{display:flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:.73rem;font-weight:600;background:rgba(34,197,94,.08);color:#22c55e;border:1px solid rgba(34,197,94,.18)}
.review-model-notice{display:flex;align-items:flex-start;gap:8px;padding:10px 14px;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.15);border-radius:9px;margin:10px 0;font-size:.83rem;color:var(--text-secondary,#64748b);line-height:1.5}.review-model-notice i{color:#f59e0b}.review-model-notice strong{color:var(--primary-color,#667eea);font-weight:700}

/* â•â•â• ENHANCEMENT 3: Framework Lock â•â•â• */
.framework-lock-banner{display:flex;align-items:center;gap:12px;padding:12px 16px;margin:12px 0;background:linear-gradient(135deg,rgba(14,165,233,.06),rgba(99,102,241,.04));border:1px solid rgba(14,165,233,.2);border-radius:11px;animation:fwlFadeIn .3s ease}@keyframes fwlFadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}.fwl-icon{width:40px;height:40px;border-radius:10px;flex-shrink:0;background:linear-gradient(135deg,rgba(14,165,233,.2),rgba(14,165,233,.05));display:flex;align-items:center;justify-content:center;color:#38bdf8;font-size:1.1rem}.fwl-body{flex:1}.fwl-title{display:flex;align-items:center;gap:8px;font-size:1rem;font-weight:700;color:var(--text-primary,#e2e8f0)}.fwl-only{padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:800;background:rgba(14,165,233,.15);color:#38bdf8;letter-spacing:.5px}.fwl-desc{margin:4px 0 0;font-size:.8rem;color:var(--text-muted,#94a3b8);line-height:1.4}.fwl-badge{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:8px;font-size:.78rem;font-weight:700;background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2);white-space:nowrap}
.audit-output-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}.audit-lock-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:.75rem;font-weight:600;background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.18)}
.audit-meta-bar{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px;padding:10px 14px;border-radius:9px;background:rgba(15,23,42,.3);border:1px solid rgba(56,189,248,.06)}.amb-item{display:flex;align-items:center;gap:5px;font-size:.8rem;color:var(--text-muted,#94a3b8)}.amb-item i{font-size:.75rem;color:var(--primary-color,#667eea)}.amb-item strong{color:var(--text-primary,#e2e8f0)}
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
/* â•â•â• CSRF PROTECTION â€” self-contained, no base.html dependency â•â•â• */
const CSRF_TOKEN='{{ csrf_token() }}';
(function(){
    if(window._csrfPatched)return;
    var _f=window.fetch;
    window.fetch=function(url,opts){
        opts=opts||{};
        var m=(opts.method||'GET').toUpperCase();
        if(m!=='GET'&&m!=='HEAD'){
            if(opts.headers instanceof Headers){
                if(!opts.headers.has('X-CSRFToken'))opts.headers.set('X-CSRFToken',CSRF_TOKEN);
            }else{
                opts.headers=Object.assign({'X-CSRFToken':CSRF_TOKEN},opts.headers||{});
            }
        }
        return _f.call(this,url,opts);
    };
    window._csrfPatched=true;
})();

const lang='{{ lang }}';const isRtl={{ 'true' if is_rtl else 'false' }};
const AI_PROVIDER_GENERATE='{{ ai_provider_generate | default("claude") }}';
const AI_PROVIDER_REVIEW='{{ ai_provider_review | default("gpt") }}';
const providerDisplayNames={claude:'Claude',gpt:'GPT',gemini:'Gemini',groq:'Groq'};

function toggleRegion(header){const r=header.parentElement;const f=r.querySelector('.region-frameworks');const e=f.style.display!=='none';f.style.display=e?'none':'block';header.classList.toggle('expanded',!e)}
const frameworksByRegion={{ frameworks | tojson | safe }};

function updatePolicyFrameworks(){const r=document.getElementById('policy-region-select');const f=document.getElementById('policy-framework-select');const s=r.value;f.innerHTML='';if(!s){f.innerHTML='<option value="">'+(isRtl?'-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ --':'-- Select Region First --')+'</option>';return}const fw=frameworksByRegion[s]||[];if(!fw.length){f.innerHTML='<option value="">'+(isRtl?'-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø± --':'-- No frameworks --')+'</option>';return}f.innerHTML='<option value="">'+(isRtl?'-- Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø·Ø§Ø± --':'-- Select Framework --')+'</option>';fw.forEach(function(x){const o=document.createElement('option');o.value=x;o.textContent=x;f.appendChild(o)})}

function updateAuditFrameworks(){const r=document.getElementById('audit-region-select');const f=document.getElementById('audit-framework-select');const s=r.value;f.innerHTML='';if(!s){f.innerHTML='<option value="">'+(isRtl?'-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ --':'-- Select Region First --')+'</option>';return}const fw=frameworksByRegion[s]||[];if(!fw.length){f.innerHTML='<option value="">'+(isRtl?'-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø± --':'-- No frameworks --')+'</option>';return}f.innerHTML='<option value="">'+(isRtl?'-- Ø§Ø®ØªØ± Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ --':'-- Select Audit Standard --')+'</option>';fw.forEach(function(x){const o=document.createElement('option');o.value=x;o.textContent=x;f.appendChild(o)});updateFrameworkLock()}

/* â•â•â• ENHANCEMENT 2: Dual-model indicator â•â•â• */
function showDualModelIndicator(){var gn=providerDisplayNames[AI_PROVIDER_GENERATE]||AI_PROVIDER_GENERATE;var rn=providerDisplayNames[AI_PROVIDER_REVIEW]||AI_PROVIDER_REVIEW;var el=document.getElementById('policy-dual-model');if(el){el.style.display='block';document.getElementById('dmi-gen-name').textContent=gn;document.getElementById('dmi-rev-name').textContent=rn;var ck=document.getElementById('dmi-check');if(ck)ck.style.display=(AI_PROVIDER_GENERATE!==AI_PROVIDER_REVIEW)?'flex':'none'}var rp=document.getElementById('review-modal-provider');var gp=document.getElementById('generate-modal-provider');if(rp)rp.textContent=rn;if(gp)gp.textContent=gn}

/* â•â•â• ENHANCEMENT 3: Framework lock â•â•â• */
function updateFrameworkLock(){var f=document.getElementById('audit-framework-select');var b=document.getElementById('fw-lock-banner');if(!f||!b)return;var t=f.options[f.selectedIndex]?f.options[f.selectedIndex].text:'';if(f.value&&t&&t.indexOf('--')===-1){document.getElementById('fwl-framework-name').textContent=t;b.style.display='flex'}else{b.style.display='none'}}

function showAuditLockInfo(){var f=document.getElementById('audit-framework-select');var r=document.getElementById('audit-region-select');var s=document.getElementById('audit-scope-select');var ft=f&&f.options[f.selectedIndex]?f.options[f.selectedIndex].text:'';var rt=r&&r.options[r.selectedIndex]?r.options[r.selectedIndex].text:'';var st=s&&s.options[s.selectedIndex]?s.options[s.selectedIndex].text:'';var tag=document.getElementById('audit-lock-tag');if(tag){document.getElementById('audit-lock-tag-name').textContent=ft;tag.style.display='inline-flex'}var bar=document.getElementById('audit-meta-bar');if(bar){document.getElementById('amb-framework').textContent=ft;document.getElementById('amb-scope').textContent=st;document.getElementById('amb-region').textContent=rt;bar.style.display='flex'}}

function cleanAuditOutput(){var el=document.getElementById('audit-content');if(!el)return;
/* Remove empty tables (header row only, no data rows) */
el.querySelectorAll('table').forEach(function(tbl){var rows=tbl.querySelectorAll('tbody tr');var hasData=false;rows.forEach(function(r){var cells=r.querySelectorAll('td');cells.forEach(function(c){if(c.textContent.trim())hasData=true})});if(!hasData){var prev=tbl.previousElementSibling;if(prev&&/^H[1-6]$/.test(prev.tagName))prev.remove();tbl.remove()}});
/* Remove Compliance Assessment section */
el.querySelectorAll('h1,h2,h3,h4').forEach(function(h){var t=h.textContent.toLowerCase();if(t.indexOf('compliance assessment')!==-1||t.indexOf('ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„')!==-1){var sib=h.nextElementSibling;var toRemove=[h];while(sib&&!/^H[1-4]$/.test(sib.tagName)){toRemove.push(sib);sib=sib.nextElementSibling}toRemove.forEach(function(n){n.remove()})}})}

function checkSession(res){if(res.status===401){Toast.error(isRtl?'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©':'Session expired');setTimeout(function(){window.location.href='/login'},1500);return false}if(res.status===403){Toast.error(isRtl?'Ø®Ø·Ø£ Ø£Ù…Ù†ÙŠ - ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©':'Security error - please refresh the page');return false}return true}
let currentTemplateType='';const currentDomain='{{ domain_name }}';

function openTemplateModal(type){currentTemplateType=type;document.getElementById('template-modal').classList.remove('hidden');loadTemplates(type)}
function closeTemplateModal(){document.getElementById('template-modal').classList.add('hidden')}

async function loadTemplates(type){const el=document.getElementById('template-list');el.innerHTML='<div class="no-templates"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';try{const res=await fetch('/api/templates/'+type+'?lang='+lang+'&domain='+encodeURIComponent(currentDomain));const data=await res.json();if(data.success&&Object.keys(data.templates).length>0){el.innerHTML='';for(const[name,tmpl]of Object.entries(data.templates)){const item=document.createElement('div');item.className='template-item';item.onclick=function(){applyTemplate(type,name,tmpl)};let meta='';if(tmpl.framework)meta+='<span class="template-tag">'+tmpl.framework+'</span>';if(tmpl.controls)meta+='<span class="template-tag">'+tmpl.controls+' controls</span>';if(tmpl.horizon)meta+='<span class="template-tag">'+tmpl.horizon+'</span>';item.innerHTML='<h4><i class="fas fa-file-alt"></i> '+name+'</h4><p>'+tmpl.description+'</p>'+(meta?'<div class="template-meta">'+meta+'</div>':'');el.appendChild(item)}}else{el.innerHTML='<div class="no-templates">'+(isRtl?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨':'No templates available')+'</div>'}}catch(e){el.innerHTML='<div class="no-templates">Error</div>'}}

function applyTemplate(type,name,tmpl){if(type==='policy'){document.getElementById('policy-name-input').value=name;if(tmpl.framework){const f=document.getElementById('policy-framework-select');for(let o of f.options)if(o.value.includes(tmpl.framework)){o.selected=true;break}}}else if(type==='audit'){document.getElementById('audit-topic-input').value=name;if(tmpl.framework){const f=document.getElementById('audit-framework-select');for(let o of f.options)if(o.value.includes(tmpl.framework)){o.selected=true;break}}}else if(type==='risk'&&tmpl.categories){document.getElementById('risk-asset-input').value=name}closeTemplateModal();Toast.success(isRtl?'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨':'Template applied')}

const riskData={{ risk_categories | tojson | safe }};
const categorySelect=document.getElementById('risk-category');const scenarioSelect=document.getElementById('risk-scenario');
function updateScenarios(){const c=categorySelect.value;const s=riskData[c]||[];scenarioSelect.innerHTML='<option value="">'+(isRtl?'Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ...':'Select scenario...')+'</option>';s.forEach(function(sc){const o=document.createElement('option');o.value=sc;o.textContent=sc;scenarioSelect.appendChild(o)})}
if(categorySelect){categorySelect.addEventListener('change',updateScenarios);updateScenarios()}

document.querySelectorAll('.tab').forEach(function(tab){tab.addEventListener('click',function(){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.tab-content').forEach(function(c){c.classList.add('hidden')});tab.classList.add('active');document.getElementById(tab.dataset.tab+'-tab').classList.remove('hidden')})});

(function(){var p=new URLSearchParams(window.location.search);var t=p.get('tab');if(t){var tb=document.querySelector('.tab[data-tab="'+t+'"]');var tc=document.getElementById(t+'-tab');if(tb&&tc){document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('active')});document.querySelectorAll('.tab-content').forEach(function(x){x.classList.add('hidden')});tb.classList.add('active');tc.classList.remove('hidden')}}})();

document.querySelectorAll('.output-tab').forEach(function(tab){tab.addEventListener('click',function(){document.querySelectorAll('.output-tab').forEach(function(t){t.classList.remove('active')});tab.classList.add('active');showSection(tab.dataset.section)})});

let strategyData={},policyData='',auditData='',riskData2='';
let currentStrategyContent='',currentPolicyContent='',currentAuditContent='',currentRiskContent='';
function cleanAILeaks(t){if(!t)return t;[/FINAL CRITICAL REMINDER[:\s].*/gi,/IMPORTANT NOTE[:\s].*/gi,/NOTE TO (SELF|AI|ASSISTANT)[:\s].*/gi,/As (an AI|requested|instructed|per your|per the).*/gi,/I have (ensured|provided|included|made sure|followed).*/gi,/This (completes|concludes|fulfills|satisfies) (the|your|all).*/gi,/\[?(System|Internal|Meta|AI) (note|instruction|reminder)[:\]].*/gi,/[âš ï¸]+\s*(CRITICAL|FRAMEWORK|IMPORTANT|ØªÙ†Ø¨ÙŠÙ‡|Ù…Ù‡Ù…|ØªØ¹Ù„ÙŠÙ…Ø§Øª)[^.\n]*/gi,/You MUST include SEPARATE[^\n]*/gi,/Do NOT write .repeat.[^\n]*/gi,/Without separate implementation[^\n]*/gi,/CRITICAL INSTRUCTION - SELECTED FRAMEWORK[^\n]*/gi,/FRAMEWORK RESTRICTION[^\n]*/gi].forEach(function(p){t=t.replace(p,'')});return t.replace(/\n{3,}/g,'\n\n').trim()}
function showSection(s){document.getElementById('strategy-content').innerHTML=marked.parse(cleanAILeaks(strategyData[s]||''))}
function showLoading(){document.getElementById('loading').classList.remove('hidden')}
function hideLoading(){document.getElementById('loading').classList.add('hidden')}

var fileArea=document.getElementById('file-upload-area');var fileInput=document.getElementById('evidence-file');
if(fileArea&&fileInput){fileArea.addEventListener('click',function(e){if(e.target!==fileInput)fileInput.click()});fileInput.addEventListener('change',function(){var list=document.getElementById('uploaded-files');if(list&&fileInput.files.length>0){list.innerHTML=Array.from(fileInput.files).map(function(f){return '<div class="uploaded-file"><i class="fas fa-file-pdf"></i> '+f.name+'</div>'}).join('')}});fileInput.addEventListener('click',function(e){e.stopPropagation()})}

/* Strategy Form */
document.getElementById('strategy-form').addEventListener('submit',async function(e){e.preventDefault();showLoading();var fd=new FormData(e.target);var data={domain:fd.get('domain'),language:fd.get('language'),org_name:fd.get('org_name'),sector:fd.get('sector'),size:fd.get('size'),budget:fd.get('budget'),frameworks:fd.getAll('frameworks'),org_structure:fd.get('org_structure'),technologies:fd.getAll('technologies'),additional_tech:fd.get('additional_tech'),maturity_level:fd.get('maturity_level'),challenges:fd.get('challenges')};if(data.additional_tech)data.technologies.push(data.additional_tech);try{var res=await fetch('/api/generate-strategy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});if(!checkSession(res)){hideLoading();return}var result=await res.json();if(result.success&&result.sections){strategyData={};for(var sk in result.sections)strategyData[sk]=cleanAILeaks(result.sections[sk]);currentStrategyContent=Object.values(strategyData).join('\n\n');document.getElementById('strategy-output').classList.remove('hidden');document.getElementById('strategy-enhancement-banner').style.display='block';showSection('vision');Toast.success(isRtl?'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©':'Strategy generated')}else{Toast.error((result.error||'Error'))}}catch(ex){Toast.error(isRtl?'Ø®Ø·Ø£':'Error')}hideLoading()});

/* Policy Form */
document.getElementById('policy-form').addEventListener('submit',async function(e){e.preventDefault();showLoading();var fd=new FormData(e.target);try{var res=await fetch('/api/generate-policy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain:fd.get('domain'),language:fd.get('language'),policy_name:fd.get('policy_name'),framework:fd.get('framework')})});if(!checkSession(res)){hideLoading();return}var result=await res.json();if(result.success){policyData=cleanAILeaks(result.content);currentPolicyContent=policyData;document.getElementById('policy-content').innerHTML=marked.parse(policyData);document.getElementById('policy-output').classList.remove('hidden');showDualModelIndicator()}else{alert((result.error||'Failed'))}}catch(ex){alert(isRtl?'Ø®Ø·Ø£':'Error')}hideLoading()});

/* Audit Form */
document.getElementById('audit-form').addEventListener('submit',async function(e){e.preventDefault();showLoading();var fd=new FormData(e.target);if(currentPolicyContent&&currentPolicyContent.trim()){fd.append('policy_content',currentPolicyContent.substring(0,10000))}try{var res=await fetch('/api/generate-audit',{method:'POST',body:fd});if(!checkSession(res)){hideLoading();return}var result=await res.json();if(result.success){auditData=cleanAILeaks(result.content);currentAuditContent=auditData;document.getElementById('audit-content').innerHTML=marked.parse(auditData);cleanAuditOutput();document.getElementById('audit-output').classList.remove('hidden');showAuditLockInfo()}else{alert((result.error||'Failed'))}}catch(ex){alert(isRtl?'Ø®Ø·Ø£':'Error')}hideLoading()});

/* Risk Form */
document.getElementById('risk-form').addEventListener('submit',async function(e){e.preventDefault();showLoading();var fd=new FormData(e.target);var scenario=fd.get('scenario')||'';var extra=fd.get('threat')||'';var threat=scenario+(extra?'. '+extra:'');try{var res=await fetch('/api/analyze-risk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain:fd.get('domain'),language:fd.get('language'),category:fd.get('category'),asset:fd.get('asset'),threat:threat})});if(!checkSession(res)){hideLoading();return}var result=await res.json();if(result.success){riskData2=cleanAILeaks(result.analysis);currentRiskContent=riskData2;document.getElementById('risk-content').innerHTML=marked.parse(riskData2);document.getElementById('risk-output').classList.remove('hidden')}}catch(ex){alert('Error')}hideLoading()});

/* Downloads */
function downloadStrategy(fmt){var order=['vision','gaps','pillars','roadmap','kpis','confidence'];var title=isRtl?'# Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©\n\n':'# Strategy Document\n\n';var c='';for(var i=0;i<order.length;i++){if(strategyData[order[i]]&&strategyData[order[i]].trim())c+=strategyData[order[i]].trim()+'\n\n---\n\n'}c=c.replace(/\n\n---\n\n$/,'');var footer=isRtl?'\n\n---\n**ØªØ§Ø±ÙŠØ®:** '+new Date().toLocaleDateString('ar-SA'):'\n\n---\n**Date:** '+new Date().toLocaleDateString('en-US');downloadFile(title+c+footer,'strategy',fmt)}
function downloadPolicy(fmt){downloadFile(policyData,'policy',fmt)}
function downloadAudit(fmt){downloadFile(auditData,'audit_report',fmt)}
function downloadRisk(fmt){downloadFile(riskData2,'risk_analysis',fmt)}

function downloadFile(content,name,fmt){if(!content||!content.trim()){alert(isRtl?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰':'No content');return}if(fmt==='txt'){var blob=new Blob([content],{type:'text/plain; charset=utf-8'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name+'.txt';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(a.href);return}var endpoint=fmt==='pdf'?'/api/generate-pdf':'/api/generate-docx';var ext=fmt==='pdf'?'.pdf':'.docx';fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:content,filename:name,language:lang})}).then(function(res){if(res.status===401){window.location.href='/login';return null}if(res.status===403){alert(isRtl?'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©':'Session expired, please refresh the page');return null}if(!res.ok){return res.json().then(function(d){alert(d.error||'Error');return null})}return res.blob()}).then(function(b){if(!b)return;if(b.size<100){alert('Empty file');return}var url=URL.createObjectURL(b);var a=document.createElement('a');a.href=url;a.download=name+ext;document.body.appendChild(a);a.click();setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(url)},100)}).catch(function(){alert(isRtl?'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„':'Download error')})}

function printDocument(type){var content='',title='';if(type==='strategy'){var order=['vision','gaps','pillars','roadmap','kpis','confidence'];var parts=[];order.forEach(function(k){if(strategyData[k]&&strategyData[k].trim())parts.push(strategyData[k].trim())});content=parts.length?parts.join('\n\n'):currentStrategyContent;title=isRtl?'Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©':'Strategy'}else if(type==='policy'){content=currentPolicyContent;title=isRtl?'Ø§Ù„Ø³ÙŠØ§Ø³Ø©':'Policy'}else if(type==='audit'){content=currentAuditContent;title=isRtl?'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚':'Audit Report'}else if(type==='risk'){content=currentRiskContent;title=isRtl?'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±':'Risk Analysis'}if(!content){alert(isRtl?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰':'No content');return}var w=window.open('','_blank');var html=marked.parse(content);var font=isRtl?"'Noto Sans Arabic','Arial'":"'Segoe UI',Arial";var align=isRtl?'right':'left';var dir=isRtl?'rtl':'ltr';var d=w.document;d.open();d.write('<!DOCTYPE html><html dir="ltr"><head><meta charset="UTF-8"><title>'+title+'</title><style>@page{size:A4;margin:2cm}body{font-family:'+font+',sans-serif;font-size:12pt;line-height:1.6;color:#333}.print-header{text-align:center;padding-bottom:20px;margin-bottom:30px;border-bottom:2px solid #667eea}.print-logo{font-size:24pt;font-weight:bold;color:#667eea}.print-content{direction:'+dir+';text-align:'+align+'}h1{font-size:18pt;color:#667eea}h2{font-size:14pt;border-bottom:1px solid #ddd;padding-bottom:5px}table{width:100%;border-collapse:collapse;margin:15px 0;font-size:10pt}th,td{border:1px solid #ddd;padding:8px;text-align:'+align+'}th{background:#667eea;color:white}tr:nth-child(even){background:#f9f9f9}.print-footer{margin-top:40px;padding-top:20px;border-top:1px solid #ddd;text-align:center;font-size:9pt;color:#666}</style></head><body><div class="print-header"><div class="print-logo">MIZAN</div><div style="font-size:10pt;color:#666">'+(isRtl?'Ø§Ù„Ø­ÙˆÙƒÙ…Ø© â€¢ Ø§Ù„Ù…Ø®Ø§Ø·Ø± â€¢ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„':'Governance â€¢ Risk â€¢ Compliance')+'</div><div style="font-size:14pt;margin-top:10px">'+title+'</div></div><div class="print-content">'+html+'</div><div class="print-footer"><p>'+(isRtl?'Ù…Ù†ØµØ© Ù…ÙŠØ²Ø§Ù†':'Mizan GRC')+' | '+new Date().toLocaleDateString()+'</p><p>Created by Eng. Mohammad Abbas Alsaadon</p></div></body></html>');d.close();w.onload=function(){w.print()}}

/* Chat */
async function sendChat(docType){var input=document.getElementById(docType+'-chat-input');var msgs=document.getElementById(docType+'-chat-messages');var q=input.value.trim();if(!q)return;var content='';if(docType==='strategy')content=currentStrategyContent;else if(docType==='policy')content=currentPolicyContent;else if(docType==='audit')content=currentAuditContent;else if(docType==='risk')content=currentRiskContent;if(!content){alert(isRtl?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰':'No content');return}var um=document.createElement('div');um.className='chat-message user';um.textContent=q;msgs.appendChild(um);input.value='';input.disabled=true;try{var res=await fetch('/api/chat-document',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:content,question:q,language:lang})});var data=await res.json();var am=document.createElement('div');am.className='chat-message assistant';am.innerHTML=data.success?marked.parse(data.response):(isRtl?'Ø®Ø·Ø£':'Error');msgs.appendChild(am);msgs.scrollTop=msgs.scrollHeight}catch(e){}input.disabled=false;input.focus()}

/* Policy Review */
function openReviewModal(){showDualModelIndicator();document.getElementById('review-modal').classList.remove('hidden')}
function closeReviewModal(){document.getElementById('review-modal').classList.add('hidden')}
async function startPolicyReview(){var rt=document.getElementById('review-type-select').value;if(!currentPolicyContent)return;closeReviewModal();showLoading();try{var res=await fetch('/api/review-policy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:currentPolicyContent,review_type:rt,framework:document.getElementById('policy-framework-select').value,language:lang})});var data=await res.json();if(data.success){lastPolicyReview=cleanAILeaks(data.review);document.getElementById('policy-review-content').innerHTML=marked.parse(lastPolicyReview);document.getElementById('policy-review-output').classList.remove('hidden');Toast.success(isRtl?'ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©':'Review completed')}else{Toast.error(isRtl?'ÙØ´Ù„':'Failed')}}catch(e){Toast.error(isRtl?'Ø®Ø·Ø£':'Error')}hideLoading()}
let lastPolicyReview='';

async function applyReviewToPolicy(){if(!currentPolicyContent){Toast.error('No policy');return}var rc=document.getElementById('policy-review-content').innerText||lastPolicyReview;if(!rc)return;showLoading();try{var res=await fetch('/api/modify-policy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({policy_content:currentPolicyContent.substring(0,6000),review_content:rc.substring(0,3000),framework:document.getElementById('policy-framework-select').value,domain:currentDomain,language:lang})});var sd=await res.json();if(!sd.success||!sd.task_id){Toast.error(sd.error||'Failed');hideLoading();return}var tid=sd.task_id,att=0;var poll=setInterval(async function(){att++;try{var pr=await fetch('/api/task-status/'+tid);var pd=await pr.json();if(pd.status==='done'){clearInterval(poll);policyData=pd.modified_policy;currentPolicyContent=pd.modified_policy;document.getElementById('policy-content').innerHTML=marked.parse(pd.modified_policy);document.getElementById('policy-review-output').classList.add('hidden');Toast.success(isRtl?'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':'Modified');hideLoading()}else if(pd.status==='error'){clearInterval(poll);Toast.error(pd.error||'Failed');hideLoading()}else if(att>=60){clearInterval(poll);Toast.error('Timeout');hideLoading()}}catch(e){if(att>=60){clearInterval(poll);hideLoading()}}},3000)}catch(e){Toast.error('Error');hideLoading()}}

function openRemediationModal(){document.getElementById('remediation-modal').classList.remove('hidden')}
function closeRemediationModal(){document.getElementById('remediation-modal').classList.add('hidden')}
async function generateRemediationPlan(){var g=document.getElementById('gaps-input').value.trim();if(!g)return;var gaps=g.split('\n').filter(function(x){return x.trim()});showLoading();try{var res=await fetch('/api/gap-remediation',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({gaps:gaps,domain:currentDomain,framework:'ISO 27001',language:lang})});var data=await res.json();if(data.success){document.getElementById('remediation-content').innerHTML=marked.parse(cleanAILeaks(data.remediation_plan));document.getElementById('remediation-output').classList.remove('hidden')}}catch(e){}hideLoading()}

/* ERM Risk Register */
{% if domain_code == 'erm' %}
let riskRegisterData=[];
function openAddRiskModal(editId){if(editId!==undefined){var risk=riskRegisterData.find(function(r){return r.id==editId});if(risk){document.getElementById('risk-reg-name').value=risk.name;document.getElementById('risk-reg-desc').value=risk.description||'';document.getElementById('risk-reg-category').value=risk.category;document.getElementById('risk-reg-likelihood').value=risk.likelihood;document.getElementById('risk-reg-impact').value=risk.impact;document.getElementById('risk-reg-owner').value=risk.owner||'';document.getElementById('risk-reg-treatment').value=risk.treatment;document.getElementById('risk-reg-plan').value=risk.treatment_plan||'';document.getElementById('risk-reg-status').value=risk.status;document.getElementById('risk-reg-edit-id').value=editId}}else{document.getElementById('risk-reg-name').value='';document.getElementById('risk-reg-desc').value='';document.getElementById('risk-reg-likelihood').value='3';document.getElementById('risk-reg-impact').value='3';document.getElementById('risk-reg-owner').value='';document.getElementById('risk-reg-plan').value='';document.getElementById('risk-reg-edit-id').value=''}document.getElementById('add-risk-modal').classList.remove('hidden')}
function closeAddRiskModal(){document.getElementById('add-risk-modal').classList.add('hidden')}

async function saveRiskEntry(){var name=document.getElementById('risk-reg-name').value.trim();if(!name){Toast.error(isRtl?'Ø§Ø³Ù… Ø§Ù„Ø®Ø·Ø± Ù…Ø·Ù„ÙˆØ¨':'Name required');return}var eid=document.getElementById('risk-reg-edit-id').value;var payload={name:name,description:document.getElementById('risk-reg-desc').value.trim(),category:document.getElementById('risk-reg-category').value,likelihood:parseInt(document.getElementById('risk-reg-likelihood').value),impact:parseInt(document.getElementById('risk-reg-impact').value),owner:document.getElementById('risk-reg-owner').value.trim(),treatment:document.getElementById('risk-reg-treatment').value,treatment_plan:document.getElementById('risk-reg-plan').value.trim(),status:document.getElementById('risk-reg-status').value,language:lang};try{var url='/api/risk-register',method='POST';if(eid){url+='/'+eid;method='PUT'}var res=await fetch(url,{method:method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});var data=await res.json();if(data.success){Toast.success(isRtl?'ØªÙ…':'Saved');closeAddRiskModal();loadRiskRegister()}else{Toast.error(data.error||'Error')}}catch(e){Toast.error('Error')}}

async function deleteRiskEntry(id){if(!confirm(isRtl?'Ø­Ø°ÙØŸ':'Delete?'))return;try{var res=await fetch('/api/risk-register/'+id,{method:'DELETE'});var data=await res.json();if(data.success){loadRiskRegister();Toast.success(isRtl?'ØªÙ…':'Deleted')}}catch(e){}}

async function loadRiskRegister(){try{var res=await fetch('/api/risk-register?lang='+lang);var data=await res.json();if(data.success){riskRegisterData=data.risks||[];renderRiskRegister();updateRiskStats();if(!document.getElementById('risk-heatmap').classList.contains('hidden'))renderHeatMap()}}catch(e){}}

function getRiskLevel(score){if(score>=20)return{level:isRtl?'Ø­Ø±Ø¬':'Critical',color:'#ef4444'};if(score>=12)return{level:isRtl?'Ø¹Ø§Ù„ÙŠ':'High',color:'#f97316'};if(score>=6)return{level:isRtl?'Ù…ØªÙˆØ³Ø·':'Medium',color:'#eab308'};return{level:isRtl?'Ù…Ù†Ø®ÙØ¶':'Low',color:'#22c55e'}}

function renderRiskRegister(){var tb=document.getElementById('risk-register-body');if(!riskRegisterData.length){tb.innerHTML='<tr><td colspan="10" style="text-align:center;padding:2rem;color:#888;">'+(isRtl?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø·Ø±':'No risks')+'</td></tr>';return}var sorted=riskRegisterData.slice().sort(function(a,b){return(b.likelihood*b.impact)-(a.likelihood*a.impact)});tb.innerHTML=sorted.map(function(r,idx){var score=r.likelihood*r.impact;var rl=getRiskLevel(score);var sc={'Open':'#3b82f6','Ù…ÙØªÙˆØ­':'#3b82f6','In Treatment':'#f59e0b','Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©':'#f59e0b','Closed':'#22c55e','Ù…ØºÙ„Ù‚':'#22c55e','Accepted':'#6b7280','Ù…Ù‚Ø¨ÙˆÙ„':'#6b7280'}[r.status]||'#6b7280';return '<tr style="border-bottom:1px solid var(--border-color)"><td style="padding:10px 8px">'+(idx+1)+'</td><td style="padding:10px 8px;font-weight:600">'+r.name+'</td><td style="padding:10px 8px">'+r.category+'</td><td style="padding:10px 8px;text-align:center">'+r.likelihood+'</td><td style="padding:10px 8px;text-align:center">'+r.impact+'</td><td style="padding:10px 8px;text-align:center"><span style="background:'+rl.color+';color:#fff;padding:3px 10px;border-radius:12px;font-weight:700">'+score+'</span></td><td style="padding:10px 8px">'+(r.owner||'-')+'</td><td style="padding:10px 8px">'+r.treatment+'</td><td style="padding:10px 8px"><span style="background:'+sc+';color:#fff;padding:3px 10px;border-radius:12px;font-size:.8rem">'+r.status+'</span></td><td style="padding:10px 8px;text-align:center"><button onclick="openAddRiskModal('+r.id+')" style="background:none;border:none;color:#3b82f6;cursor:pointer"><i class="fas fa-edit"></i></button> <button onclick="deleteRiskEntry('+r.id+')" style="background:none;border:none;color:#ef4444;cursor:pointer"><i class="fas fa-trash"></i></button></td></tr>'}).join('')}

function updateRiskStats(){var c=0,h=0,m=0,l=0;riskRegisterData.forEach(function(r){var s=r.likelihood*r.impact;if(s>=20)c++;else if(s>=12)h++;else if(s>=6)m++;else l++});document.getElementById('stat-critical').textContent=c;document.getElementById('stat-high').textContent=h;document.getElementById('stat-medium').textContent=m;document.getElementById('stat-low').textContent=l;document.getElementById('stat-total').textContent=riskRegisterData.length}

function toggleHeatMap(){var el=document.getElementById('risk-heatmap');el.classList.toggle('hidden');if(!el.classList.contains('hidden'))renderHeatMap()}

function renderHeatMap(){var grid=document.getElementById('heatmap-grid');var labels=isRtl?['ÙƒØ§Ø±Ø«ÙŠ','ÙƒØ¨ÙŠØ±','Ù…ØªÙˆØ³Ø·','Ø·ÙÙŠÙ','Ø¶Ø¦ÙŠÙ„']:['Catastrophic','Major','Moderate','Minor','Insignificant'];while(grid.children.length>6)grid.removeChild(grid.lastChild);for(var impact=5;impact>=1;impact--){var lb=document.createElement('div');lb.style.cssText='padding:8px;font-weight:600;text-align:center;font-size:.75rem;display:flex;align-items:center;justify-content:center';lb.textContent=labels[5-impact];grid.appendChild(lb);for(var lk=1;lk<=5;lk++){var score=impact*lk;var rl=getRiskLevel(score);var cnt=riskRegisterData.filter(function(r){return r.likelihood==lk&&r.impact==impact}).length;var cell=document.createElement('div');cell.style.cssText='background:'+rl.color+'22;border:2px solid '+rl.color+'44;border-radius:6px;padding:8px 4px;text-align:center;min-height:40px;display:flex;flex-direction:column;align-items:center;justify-content:center';cell.innerHTML='<span style="font-size:.7rem;color:#888">'+score+'</span>'+(cnt?'<span style="background:'+rl.color+';color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;margin-top:2px">'+cnt+'</span>':'');grid.appendChild(cell)}}}

async function generateRiskAppetite(){if(!riskRegisterData.length){Toast.error(isRtl?'Ø£Ø¶Ù Ù…Ø®Ø§Ø·Ø±':'Add risks first');return}showLoading();try{var res=await fetch('/api/risk-appetite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({risks:riskRegisterData,language:lang})});var data=await res.json();if(data.success){document.getElementById('risk-appetite-content').innerHTML=marked.parse(data.content);document.getElementById('risk-appetite-output').classList.remove('hidden');riskAppetiteContent=data.content}}catch(e){}hideLoading()}
let riskAppetiteContent='';
function downloadRiskAppetite(fmt){if(riskAppetiteContent)downloadFile(riskAppetiteContent,'risk_appetite',fmt)}

function exportRiskRegister(){if(!riskRegisterData.length)return;var md=isRtl?'# Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±\n\n| # | Ø§Ù„Ø®Ø·Ø± | Ø§Ù„ÙØ¦Ø© | Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© | Ø§Ù„Ø£Ø«Ø± | Ø§Ù„Ø¯Ø±Ø¬Ø© | Ø§Ù„Ù…Ø§Ù„Ùƒ | Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© | Ø§Ù„Ø­Ø§Ù„Ø© |\n|---|---|---|---|---|---|---|---|---|\n':'# Risk Register\n\n| # | Risk | Category | Likelihood | Impact | Score | Owner | Treatment | Status |\n|---|---|---|---|---|---|---|---|---|\n';var sorted=riskRegisterData.slice().sort(function(a,b){return(b.likelihood*b.impact)-(a.likelihood*a.impact)});sorted.forEach(function(r,i){md+='| '+(i+1)+' | '+r.name+' | '+r.category+' | '+r.likelihood+' | '+r.impact+' | '+(r.likelihood*r.impact)+' | '+(r.owner||'-')+' | '+r.treatment+' | '+r.status+' |\n'});downloadFile(md,'risk_register','docx')}

document.addEventListener('DOMContentLoaded',function(){var rt=document.querySelector('.tab[data-tab="register"]');if(rt)rt.addEventListener('click',function(){if(!riskRegisterData.length)loadRiskRegister()})});
{% endif %}

/* Awareness Modules */
let awarenessModules=[],currentQuiz=null,currentQuizIdx=0,quizAnswers=[];

function loadAwarenessModules(){fetch('/api/awareness/modules?domain='+encodeURIComponent(currentDomain)+'&lang='+lang).then(function(r){if(!checkSession(r))throw new Error('s');return r.json()}).then(function(data){if(data.success){awarenessModules=data.modules;renderModulesGrid()}}).catch(function(){})}

function renderModulesGrid(){var grid=document.getElementById('awareness-modules-grid');if(!grid)return;var completed=0;var html='';awarenessModules.forEach(function(m,idx){if(m.completed)completed++;var badge=m.completed?(m.passed?'<span style="background:#22c55e;color:#fff;padding:3px 10px;border-radius:12px;font-size:.75rem"><i class="fas fa-check"></i> '+(isRtl?'Ù†Ø§Ø¬Ø­':'Passed')+'</span>':'<span style="background:#f59e0b;color:#fff;padding:3px 10px;border-radius:12px;font-size:.75rem"><i class="fas fa-redo"></i> '+(isRtl?'Ø£Ø¹Ø¯':'Retry')+'</span>'):'<span style="background:var(--border-color);color:var(--text-secondary);padding:3px 10px;border-radius:12px;font-size:.75rem">'+(isRtl?'Ù„Ù… ÙŠØ¨Ø¯Ø£':'Not Started')+'</span>';var si=m.completed?'<div style="font-size:.8rem;color:var(--text-secondary);margin-top:.3rem">'+(isRtl?'Ø§Ù„Ù†ØªÙŠØ¬Ø©':'Score')+': '+m.user_score+'/'+m.user_total+'</div>':'';html+='<div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:1.5rem;cursor:pointer;'+(m.passed?'border-color:#22c55e33;':'')+'" onmouseenter="this.style.transform=\'translateY(-2px)\'" onmouseleave="this.style.transform=\'\'"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.8rem"><div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center"><i class="'+m.icon+'" style="color:#fff;font-size:1.1rem"></i></div>'+badge+'</div><h3 style="margin:0 0 .3rem;font-size:1rem">'+m.title+'</h3><div style="display:flex;gap:.8rem;margin-bottom:.6rem;font-size:.8rem;color:var(--text-secondary)"><span><i class="fas fa-signal"></i> '+m.level+'</span><span><i class="fas fa-clock"></i> '+m.duration+'</span><span><i class="fas fa-question-circle"></i> '+m.quiz.length+' '+(isRtl?'Ø£Ø³Ø¦Ù„Ø©':'Q')+'</span></div><p style="margin:0 0 1rem;font-size:.85rem;color:var(--text-secondary);line-height:1.5">'+m.description+'</p>'+si+'<div style="display:flex;gap:.5rem;margin-top:.8rem"><button class="btn" onclick="event.stopPropagation();openLearnView('+idx+')" style="flex:1;font-size:.85rem;padding:.5rem"><i class="fas fa-book-open"></i> '+(isRtl?'ØªØ¹Ù„Ù‘Ù…':'Learn')+'</button><button class="btn btn-primary" onclick="event.stopPropagation();startQuiz('+idx+')" style="flex:1;font-size:.85rem;padding:.5rem"><i class="fas fa-pen"></i> '+(isRtl?'Ø§Ø®ØªØ¨Ø§Ø±':'Quiz')+'</button></div></div>'});grid.innerHTML=html;var total=awarenessModules.length;var pct=total?Math.round(completed/total*100):0;var fill=document.getElementById('awareness-progress-fill');var txt=document.getElementById('awareness-progress-text');if(fill)fill.style.width=pct+'%';if(txt)txt.textContent=pct+'%'}

function showAwarenessModules(){document.getElementById('awareness-modules-view').classList.remove('hidden');document.getElementById('awareness-learn-view').classList.add('hidden');document.getElementById('awareness-quiz-view').classList.add('hidden');document.getElementById('awareness-results-view').classList.add('hidden');loadAwarenessModules()}

function openLearnView(idx){var m=awarenessModules[idx];if(!m)return;document.getElementById('awareness-modules-view').classList.add('hidden');document.getElementById('awareness-learn-view').classList.remove('hidden');document.getElementById('awareness-quiz-view').classList.add('hidden');document.getElementById('awareness-results-view').classList.add('hidden');var bdr=isRtl?'right':'left';document.getElementById('awareness-learn-content').innerHTML='<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem"><div style="width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center"><i class="'+m.icon+'" style="color:#fff;font-size:1.3rem"></i></div><div><h2 style="margin:0;font-size:1.3rem">'+m.title+'</h2><div style="font-size:.85rem;color:var(--text-secondary)">'+m.level+' â€¢ '+m.duration+'</div></div></div><h3 style="margin:1.5rem 0 .8rem;color:var(--primary)"><i class="fas fa-lightbulb"></i> '+(isRtl?'Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¹Ù„Ù…':'Key Points')+'</h3><div style="display:flex;flex-direction:column;gap:.6rem">'+m.learning_points.map(function(p,i){return '<div style="display:flex;gap:.8rem;align-items:flex-start;padding:.8rem;background:var(--bg-card);border-radius:var(--radius-sm);border-'+bdr+':3px solid var(--primary)"><span style="background:var(--primary);color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;flex-shrink:0">'+(i+1)+'</span><span style="font-size:.9rem;line-height:1.5">'+p+'</span></div>'}).join('')+'</div><h3 style="margin:1.5rem 0 .8rem;color:#f59e0b"><i class="fas fa-theater-masks"></i> '+(isRtl?'Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ':'Scenario')+'</h3><div style="background:linear-gradient(135deg,#fef3c7,#fde68a22);border:1px solid #f59e0b44;border-radius:var(--radius-lg);padding:1.5rem"><h4 style="margin:0 0 .5rem;color:#b45309">'+m.scenario.title+'</h4><p style="margin:0 0 1rem;line-height:1.6;font-size:.9rem">'+m.scenario.text+'</p><div style="background:#fff8;border-radius:var(--radius-sm);padding:1rem;border-'+bdr+':3px solid #22c55e"><strong style="color:#22c55e"><i class="fas fa-check-circle"></i> '+(isRtl?'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØµØ­ÙŠØ­:':'Correct Action:')+'</strong><p style="margin:.3rem 0 0;font-size:.9rem;line-height:1.5">'+m.scenario.correct_action+'</p></div></div><div style="text-align:center;margin-top:2rem"><button class="btn btn-primary" onclick="startQuiz('+idx+')" style="padding:.8rem 2rem;font-size:1rem"><i class="fas fa-pen"></i> '+(isRtl?'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±':'Start Quiz')+'</button></div>'}

function startQuiz(idx){var m=awarenessModules[idx];if(!m)return;currentQuiz=m;currentQuizIdx=0;quizAnswers=new Array(m.quiz.length).fill(-1);document.getElementById('awareness-modules-view').classList.add('hidden');document.getElementById('awareness-learn-view').classList.add('hidden');document.getElementById('awareness-quiz-view').classList.remove('hidden');document.getElementById('awareness-results-view').classList.add('hidden');renderQuizQuestion()}

function renderQuizQuestion(){var q=currentQuiz.quiz[currentQuizIdx];var total=currentQuiz.quiz.length;var num=currentQuizIdx+1;var sel=quizAnswers[currentQuizIdx];var arrDir=isRtl?'right':'left';document.getElementById('quiz-progress-indicator').innerHTML='<span style="font-weight:600">'+(isRtl?'Ø§Ù„Ø³Ø¤Ø§Ù„':'Q')+' '+num+'/'+total+'</span>';document.getElementById('awareness-quiz-content').innerHTML='<h3 style="margin:0 0 1.5rem;font-size:1.1rem;line-height:1.5">'+q.q+'</h3><div style="display:flex;flex-direction:column;gap:.7rem">'+q.options.map(function(opt,i){return '<button onclick="selectAnswer('+i+')" style="text-align:'+(isRtl?'right':'left')+';padding:1rem 1.2rem;border-radius:var(--radius-sm);border:2px solid '+(sel===i?'var(--primary)':'var(--border-color)')+';background:'+(sel===i?'var(--primary)11':'var(--bg-card)')+';cursor:pointer;font-size:.95rem;display:flex;align-items:center;gap:.8rem"><span style="width:28px;height:28px;border-radius:50%;border:2px solid '+(sel===i?'var(--primary)':'var(--border-color)')+';display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.8rem;font-weight:600;'+(sel===i?'background:var(--primary);color:#fff;':'')+'">'+String.fromCharCode(65+i)+'</span><span>'+opt+'</span></button>'}).join('')+'</div><div style="display:flex;justify-content:space-between;margin-top:1.5rem"><button class="btn" onclick="prevQuestion()" '+(currentQuizIdx===0?'disabled style="opacity:.5"':'')+'><i class="fas fa-arrow-'+arrDir+'"></i> '+(isRtl?'Ø§Ù„Ø³Ø§Ø¨Ù‚':'Previous')+'</button>'+(currentQuizIdx===total-1?'<button class="btn btn-primary" onclick="submitQuiz()" '+(sel===-1?'disabled style="opacity:.6"':'')+'><i class="fas fa-paper-plane"></i> '+(isRtl?'Ø¥Ø±Ø³Ø§Ù„':'Submit')+'</button>':'<button class="btn btn-primary" onclick="nextQuestion()" '+(sel===-1?'disabled style="opacity:.6"':'')+'>'+(isRtl?'Ø§Ù„ØªØ§Ù„ÙŠ':'Next')+' <i class="fas fa-arrow-'+(isRtl?'left':'right')+'"></i></button>')+'</div>'}

function selectAnswer(i){quizAnswers[currentQuizIdx]=i;renderQuizQuestion()}
function nextQuestion(){if(currentQuizIdx<currentQuiz.quiz.length-1){currentQuizIdx++;renderQuizQuestion()}}
function prevQuestion(){if(currentQuizIdx>0){currentQuizIdx--;renderQuizQuestion()}}

function submitQuiz(){var score=0;var total=currentQuiz.quiz.length;var results=[];currentQuiz.quiz.forEach(function(q,i){var correct=quizAnswers[i]===q.answer;if(correct)score++;results.push({question:q.q,userAnswer:q.options[quizAnswers[i]]||'-',correctAnswer:q.options[q.answer],correct:correct})});var pct=Math.round(score/total*100);var passed=pct>=70;
fetch('/api/awareness/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({module_id:currentQuiz.id,domain:currentDomain,score:score,total:total,language:lang})}).catch(function(){});
document.getElementById('awareness-modules-view').classList.add('hidden');document.getElementById('awareness-learn-view').classList.add('hidden');document.getElementById('awareness-quiz-view').classList.add('hidden');document.getElementById('awareness-results-view').classList.remove('hidden');
document.getElementById('awareness-results-content').innerHTML='<div style="max-width:600px;margin:0 auto"><div style="width:100px;height:100px;border-radius:50%;background:'+(passed?'linear-gradient(135deg,#22c55e,#16a34a)':'linear-gradient(135deg,#f59e0b,#d97706)')+';display:flex;align-items:center;justify-content:center;margin:0 auto 1.5rem"><i class="fas '+(passed?'fa-trophy':'fa-redo')+'" style="color:#fff;font-size:2.5rem"></i></div><h2 style="margin:0 0 .3rem">'+(passed?(isRtl?'ğŸ‰ Ø£Ø­Ø³Ù†Øª!':'ğŸ‰ Excellent!'):(isRtl?'Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹':'Try Again'))+'</h2><p style="color:var(--text-secondary);margin:0 0 1.5rem">'+(passed?(isRtl?'Ù„Ù‚Ø¯ Ù†Ø¬Ø­Øª!':'You passed!'):(isRtl?'ØªØ­ØªØ§Ø¬ 70% Ù„Ù„Ù†Ø¬Ø§Ø­':'Need 70% to pass'))+'</p><div style="display:flex;justify-content:center;gap:2rem;margin-bottom:2rem"><div style="text-align:center"><div style="font-size:2.5rem;font-weight:700;color:'+(passed?'#22c55e':'#f59e0b')+'">'+pct+'%</div><div style="font-size:.85rem;color:var(--text-secondary)">'+(isRtl?'Ø§Ù„Ù†ØªÙŠØ¬Ø©':'Score')+'</div></div><div style="text-align:center"><div style="font-size:2.5rem;font-weight:700">'+score+'/'+total+'</div><div style="font-size:.85rem;color:var(--text-secondary)">'+(isRtl?'ØµØ­ÙŠØ­':'Correct')+'</div></div></div><h3 style="text-align:'+(isRtl?'right':'left')+';margin:1.5rem 0 .8rem"><i class="fas fa-list-check"></i> '+(isRtl?'Ù…Ø±Ø§Ø¬Ø¹Ø©':'Review')+'</h3><div style="display:flex;flex-direction:column;gap:.6rem;text-align:'+(isRtl?'right':'left')+'">'+results.map(function(r,i){return '<div style="padding:.8rem;border-radius:var(--radius-sm);border:1px solid '+(r.correct?'#22c55e44':'#ef444444')+';background:'+(r.correct?'#22c55e08':'#ef444408')+'"><div style="font-size:.85rem;font-weight:600;margin-bottom:.3rem">'+(r.correct?'<i class="fas fa-check-circle" style="color:#22c55e"></i>':'<i class="fas fa-times-circle" style="color:#ef4444"></i>')+' Q'+(i+1)+': '+r.question+'</div>'+(!r.correct?'<div style="font-size:.8rem;color:#ef4444">'+(isRtl?'Ø¥Ø¬Ø§Ø¨ØªÙƒ':'Your answer')+': '+r.userAnswer+'</div><div style="font-size:.8rem;color:#22c55e">'+(isRtl?'Ø§Ù„ØµØ­ÙŠØ­Ø©':'Correct')+': '+r.correctAnswer+'</div>':'')+'</div>'}).join('')+'</div><div style="display:flex;gap:.8rem;justify-content:center;margin-top:2rem"><button class="btn" onclick="showAwarenessModules()" style="padding:.7rem 1.5rem"><i class="fas fa-th-large"></i> '+(isRtl?'Ø§Ù„ÙˆØ­Ø¯Ø§Øª':'Modules')+'</button>'+(!passed?'<button class="btn btn-primary" onclick="startQuiz(awarenessModules.findIndex(function(m){return m.id===\''+currentQuiz.id+'\'}))" style="padding:.7rem 1.5rem"><i class="fas fa-redo"></i> '+(isRtl?'Ø¥Ø¹Ø§Ø¯Ø©':'Retry')+'</button>':'')+'</div></div>'}

document.addEventListener('DOMContentLoaded',function(){var at=document.querySelector('.tab[data-tab="awareness"]');if(at)at.addEventListener('click',function(){loadAwarenessModules()})});

function toggleTheme(){document.body.classList.toggle('light-mode');var icon=document.querySelector('.theme-toggle i');if(icon){icon.className=document.body.classList.contains('light-mode')?'fas fa-moon':'fas fa-sun'}}

function startAwarenessModule(moduleId){if(!awarenessModules||!awarenessModules.length){loadAwarenessModules();return}var idx=awarenessModules.findIndex(function(m){return m.id===moduleId});if(idx>=0){openLearnView(idx)}else{Toast.error(isRtl?'Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©':'Module not found')}}

/* â•â•â• PILLAR 4.1: FORM DRAFTS â€” Save / Load Progress â•â•â• */
function collectFormData(formType){
    var form=document.getElementById(formType+'-form');
    if(!form)return null;
    var fd=new FormData(form);
    var data={};
    // Collect all form values (including multi-selects like checkboxes)
    for(var pair of fd.entries()){
        if(data[pair[0]]){
            if(!Array.isArray(data[pair[0]]))data[pair[0]]=[data[pair[0]]];
            data[pair[0]].push(pair[1]);
        }else{data[pair[0]]=pair[1]}
    }
    return data;
}

function restoreFormData(formType, data){
    var form=document.getElementById(formType+'-form');
    if(!form||!data)return;
    for(var key in data){
        var val=data[key];
        var els=form.querySelectorAll('[name="'+key+'"]');
        if(!els.length)continue;
        if(els[0].type==='checkbox'){
            var vals=Array.isArray(val)?val:[val];
            els.forEach(function(el){el.checked=vals.indexOf(el.value)!==-1});
        }else if(els[0].type==='select-one'){
            els[0].value=val;
        }else{
            els[0].value=val;
        }
    }
}

async function saveDraft(formType){
    var data=collectFormData(formType);
    if(!data)return;
    try{
        var res=await fetch('/api/drafts',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({domain:currentDomain,form_type:formType,form_data:data})});
        var result=await res.json();
        if(result.success){Toast.success(isRtl?'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­':'Draft saved successfully')}
        else{Toast.error(result.error||'Error')}
    }catch(e){Toast.error(isRtl?'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©':'Error saving draft')}
}

async function loadDraft(formType){
    try{
        var res=await fetch('/api/drafts?domain='+encodeURIComponent(currentDomain)+'&form_type='+formType);
        var result=await res.json();
        if(result.success&&result.draft){
            restoreFormData(formType,result.draft);
            // Fire change events for dependent selects
            if(formType==='strategy'){var scenarios=document.getElementById('risk-scenario');if(scenarios)updateScenarios();}
            Toast.success(isRtl?'ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©':'Draft loaded');
        }else{Toast.info(isRtl?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø©':'No saved draft found')}
    }catch(e){Toast.error(isRtl?'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©':'Error loading draft')}
}

async function checkDrafts(){
    var types=['strategy','risk'];
    for(var i=0;i<types.length;i++){
        try{
            var res=await fetch('/api/drafts?domain='+encodeURIComponent(currentDomain)+'&form_type='+types[i]);
            var result=await res.json();
            if(result.success&&result.draft){
                var btn=document.getElementById(types[i]+'-load-draft-btn');
                if(btn){btn.style.display='inline-flex';
                    var ago=result.updated_at?(' ('+new Date(result.updated_at).toLocaleDateString()+')'):'';
                    btn.title=(isRtl?'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ÙˆØ¯Ø©':'Load Draft')+ago;
                }
            }
        }catch(e){}
    }
}

/* â•â•â• PILLAR 3.2: DYNAMIC FRAMEWORK REFRESH â•â•â• */
async function refreshFrameworks(){
    try{
        /* Extract domain code from URL or page context */
        var domainCode='{{ domain_code }}';
        var res=await fetch('/api/frameworks?domain='+encodeURIComponent(domainCode));
        var result=await res.json();
        if(result.success&&result.frameworks){
            /* Update the global frameworksByRegion used by policy/audit selects */
            for(var region in result.frameworks){
                frameworksByRegion[region]=result.frameworks[region].map(function(fw){return fw.name});
            }
        }
    }catch(e){console.log('Framework refresh (non-fatal):',e)}
}

/* On page load: check for saved drafts + refresh frameworks from DB */
document.addEventListener('DOMContentLoaded',function(){
    checkDrafts();
    refreshFrameworks();
});
</script>
{% endblock %}
