{% extends "base.html" %}

{% block content %}
<div class="app-layout {{ 'rtl-layout' if is_rtl else '' }}">
    <!-- Sidebar -->
    <aside class="sidebar {{ 'sidebar-right' if is_rtl else 'sidebar-left' }}">
        <div class="sidebar-brand">
            <a href="{{ url_for('dashboard', lang=lang) }}">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Mizan Logo" class="sidebar-logo">
            </a>
        </div>
        
        <div class="sidebar-lang">
            <a href="{{ url_for('domain_page', domain_name=domain_name, lang='en') }}" class="lang-btn {{ 'active' if lang == 'en' else '' }}">EN</a>
            <a href="{{ url_for('domain_page', domain_name=domain_name, lang='ar') }}" class="lang-btn {{ 'active' if lang == 'ar' else '' }}">ع</a>
        </div>
        
        <a href="{{ url_for('dashboard', lang=lang) }}" class="back-btn">
            <i class="fas fa-arrow-{{ 'right' if is_rtl else 'left' }}"></i>
            {% if is_rtl %}العودة{% else %}Back{% endif %}
        </a>
        
        <div class="user-info">
            <div class="user-avatar"><i class="fas fa-user"></i></div>
            <div class="user-details">
                <span class="user-label">{{ txt.logged_in_as }}</span>
                <span class="user-name">{{ username }}</span>
                {% if session.get('role') == 'admin' %}
                <a href="{{ url_for('admin_dashboard') }}" class="admin-link"><i class="fas fa-crown"></i></a>
                {% endif %}
            </div>
        </div>
        
        <div class="ai-status {{ 'connected' if ai_available else 'disconnected' }}">
            <div class="status-dot"></div>
            <span>{{ txt.ai_connected if ai_available else txt.ai_disconnected }}</span>
        </div>
        
        <a href="{{ url_for('logout') }}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> {{ txt.logout }}
        </a>
        
        <div class="sidebar-footer">
            <p class="created-by">{{ txt.created_by }}</p>
            <p class="creator-name">{{ config.CREATOR_NAME }}</p>
            <p class="copyright">© {{ config.COPYRIGHT_YEAR }}</p>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="domain-header">
            <h1>{{ domain_name }}</h1>
            <!-- Usage Limits Display -->
            <div class="usage-limits-bar">
                <div class="usage-item">
                    <span class="usage-label">{{ 'استراتيجية' if is_rtl else 'Strategy' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.strategies.remaining == 0 else '' }}">
                        {{ usage_info.strategies.used }}/{{ usage_info.strategies.limit }}
                    </span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">{{ 'سياسات' if is_rtl else 'Policies' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.policies.remaining == 0 else '' }}">
                        {{ usage_info.policies.used }}/{{ usage_info.policies.limit }}
                    </span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">{{ 'تدقيق' if is_rtl else 'Audits' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.audits.remaining == 0 else '' }}">
                        {{ usage_info.audits.used }}/{{ usage_info.audits.limit }}
                    </span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">{{ 'مخاطر' if is_rtl else 'Risks' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.risks.remaining == 0 else '' }}">
                        {{ usage_info.risks.used }}/{{ usage_info.risks.limit }}
                    </span>
                </div>
            </div>
        </header>
        
        <!-- Tabs -->
        <div class="tabs" {% if is_rtl %}style="display: flex; flex-direction: row-reverse;"{% endif %}>
            {% if is_rtl %}
            <!-- RTL: Tabs in reverse order -->
            <button class="tab" data-tab="risk" style="flex-direction: row-reverse;">
                <i class="fas fa-exclamation-triangle"></i> {{ txt.tabs[3] }}
            </button>
            <button class="tab" data-tab="audit" style="flex-direction: row-reverse;">
                <i class="fas fa-clipboard-check"></i> {{ txt.tabs[2] }}
            </button>
            <button class="tab" data-tab="policy" style="flex-direction: row-reverse;">
                <i class="fas fa-file-alt"></i> {{ txt.tabs[1] }}
            </button>
            <button class="tab active" data-tab="strategy" style="flex-direction: row-reverse;">
                <i class="fas fa-chess"></i> {{ txt.tabs[0] }}
            </button>
            {% else %}
            <!-- LTR: Normal order -->
            <button class="tab active" data-tab="strategy">
                <i class="fas fa-chess"></i> {{ txt.tabs[0] }}
            </button>
            <button class="tab" data-tab="policy">
                <i class="fas fa-file-alt"></i> {{ txt.tabs[1] }}
            </button>
            <button class="tab" data-tab="audit">
                <i class="fas fa-clipboard-check"></i> {{ txt.tabs[2] }}
            </button>
            <button class="tab" data-tab="risk">
                <i class="fas fa-exclamation-triangle"></i> {{ txt.tabs[3] }}
            </button>
            {% endif %}
        </div>
        
        <!-- Strategy Tab -->
        <div class="tab-content active" id="strategy-tab">
            <form id="strategy-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.org_name }}</label>
                        <input type="text" name="org_name" value="{% if is_rtl %}منظمتي{% else %}My Organization{% endif %}" required>
                    </div>
                    <div class="form-group">
                        <label>{{ txt.sector }}</label>
                        <select name="sector" required>
                            {% for sector in txt.sectors %}
                            <option value="{{ sector }}">{{ sector }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.size }}</label>
                        <select name="size" required>
                            {% for size in txt.sizes %}
                            <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{{ txt.budget }}</label>
                        <select name="budget" required>
                            {% for budget in txt.budgets %}
                            <option value="{{ budget }}">{{ budget }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{ txt.frameworks }}</label>
                    <div class="checkbox-group">
                        {% for framework in frameworks %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="frameworks" value="{{ framework }}">
                            <span>{{ framework }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Current State Assessment - Domain Specific -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-building"></i>
                        {% if is_rtl %}تقييم الوضع الحالي{% else %}Current State Assessment{% endif %}
                    </h3>
                    
                    <div class="form-group">
                        <label>{% if is_rtl %}الهيكل التنظيمي الحالي{% else %}Current Organizational Structure{% endif %}</label>
                        <select name="org_structure">
                            {% if is_rtl %}
                            <option value="centralized">مركزي - فريق مركزي</option>
                            <option value="distributed">موزع - فرق في كل قسم</option>
                            <option value="hybrid">هجين - مركزي مع منسقين</option>
                            <option value="outsourced">خارجي - مزود خدمات</option>
                            <option value="none">لا يوجد هيكل محدد</option>
                            {% else %}
                            <option value="centralized">Centralized - Central Team</option>
                            <option value="distributed">Distributed - Teams in Each Department</option>
                            <option value="hybrid">Hybrid - Central with Coordinators</option>
                            <option value="outsourced">Outsourced - Managed Service Provider</option>
                            <option value="none">No Defined Structure</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Domain-Specific Technologies -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-cogs"></i>
                            {% if is_rtl %}التقنيات والضوابط المطبقة حالياً{% else %}Currently Implemented Technologies & Controls{% endif %}
                        </label>
                        
                        {% for category, techs in technologies.items() %}
                        <div class="tech-category">
                            <h4 class="tech-category-title">{{ category }}</h4>
                            <div class="checkbox-group tech-group">
                                {% for tech in techs %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="technologies" value="{{ tech }}">
                                    <span>{{ tech }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="form-group">
                        <label>{% if is_rtl %}تقنيات إضافية (غير مذكورة أعلاه){% else %}Additional Technologies (not listed above){% endif %}</label>
                        <textarea name="additional_tech" rows="2" placeholder="{% if is_rtl %}أدخل أي تقنيات أخرى مطبقة...{% else %}Enter any other implemented technologies...{% endif %}"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>{% if is_rtl %}مستوى النضج الحالي{% else %}Current Maturity Level{% endif %}</label>
                        <select name="maturity_level">
                            {% if is_rtl %}
                            <option value="initial">مبدئي (1) - عمليات غير منظمة</option>
                            <option value="developing">نامٍ (2) - بعض العمليات موثقة</option>
                            <option value="defined">محدد (3) - عمليات موحدة</option>
                            <option value="managed">مُدار (4) - عمليات مقاسة</option>
                            <option value="optimized">محسّن (5) - تحسين مستمر</option>
                            {% else %}
                            <option value="initial">Initial (1) - Ad-hoc processes</option>
                            <option value="developing">Developing (2) - Some documented</option>
                            <option value="defined">Defined (3) - Standardized</option>
                            <option value="managed">Managed (4) - Measured</option>
                            <option value="optimized">Optimized (5) - Continuous improvement</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{ txt.challenges }}</label>
                    <textarea name="challenges" rows="3" placeholder="{% if is_rtl %}صف التحديات الرئيسية...{% else %}Describe key challenges...{% endif %}"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-magic"></i> {{ txt.generate }}
                </button>
            </form>
            
            <div id="strategy-output" class="output-container hidden">
                <div class="output-tabs" {% if is_rtl %}style="display: flex; flex-direction: row-reverse;"{% endif %}>
                    {% if is_rtl %}
                    <!-- RTL: Tabs in reverse order so they appear right-to-left -->
                    <button class="output-tab" data-section="kpis">{{ txt.strategy_sections.kpis }}</button>
                    <button class="output-tab" data-section="roadmap">{{ txt.strategy_sections.roadmap }}</button>
                    <button class="output-tab" data-section="pillars">{{ txt.strategy_sections.pillars }}</button>
                    <button class="output-tab" data-section="gaps">{{ txt.strategy_sections.gaps }}</button>
                    <button class="output-tab active" data-section="vision">{{ txt.strategy_sections.vision }}</button>
                    {% else %}
                    <!-- LTR: Normal order -->
                    <button class="output-tab active" data-section="vision">{{ txt.strategy_sections.vision }}</button>
                    <button class="output-tab" data-section="gaps">{{ txt.strategy_sections.gaps }}</button>
                    <button class="output-tab" data-section="pillars">{{ txt.strategy_sections.pillars }}</button>
                    <button class="output-tab" data-section="roadmap">{{ txt.strategy_sections.roadmap }}</button>
                    <button class="output-tab" data-section="kpis">{{ txt.strategy_sections.kpis }}</button>
                    {% endif %}
                </div>
                <div class="output-content" id="strategy-content"></div>
                <div class="download-buttons" {% if is_rtl %}style="flex-direction: row-reverse;"{% endif %}>
                    <button class="btn btn-secondary" onclick="downloadStrategy('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadStrategy('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadStrategy('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Policy Tab -->
        <div class="tab-content hidden" id="policy-tab">
            <form id="policy-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.policy_name }}</label>
                        <input type="text" name="policy_name" placeholder="{% if is_rtl %}سياسة أمن المعلومات{% else %}Information Security Policy{% endif %}" required>
                    </div>
                    <div class="form-group">
                        <label>{{ txt.policy_framework }}</label>
                        <select name="framework" required>
                            {% for framework in frameworks %}
                            <option value="{{ framework }}">{{ framework }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-file-alt"></i> {{ txt.generate_policy }}
                </button>
            </form>
            
            <div id="policy-output" class="output-container hidden">
                <div class="output-content policy-content" id="policy-content"></div>
                <div class="download-buttons">
                    <button class="btn btn-secondary" onclick="downloadPolicy('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadPolicy('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadPolicy('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Audit Tab -->
        <div class="tab-content hidden" id="audit-tab">
            <form id="audit-form" class="grc-form" enctype="multipart/form-data">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{% if is_rtl %}معيار التدقيق{% else %}Audit Standard{% endif %}</label>
                        <select name="framework" required>
                            {% for framework in frameworks %}
                            <option value="{{ framework }}">{{ framework }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{% if is_rtl %}نطاق التدقيق{% else %}Audit Scope{% endif %}</label>
                        <select name="audit_scope">
                            {% if is_rtl %}
                            <option value="full">تدقيق شامل</option>
                            <option value="controls">تدقيق الضوابط</option>
                            <option value="compliance">تدقيق الامتثال</option>
                            {% else %}
                            <option value="full">Full Audit</option>
                            <option value="controls">Controls Audit</option>
                            <option value="compliance">Compliance Audit</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-upload"></i> {% if is_rtl %}رفع الأدلة (PDF){% else %}Upload Evidence (PDF){% endif %}</label>
                    <div class="file-upload-area" id="file-upload-area">
                        <input type="file" name="evidence" id="evidence-file" accept=".pdf" multiple>
                        <div class="file-upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>{% if is_rtl %}اسحب الملفات أو انقر{% else %}Drag files or click{% endif %}</p>
                        </div>
                    </div>
                    <div id="uploaded-files" class="uploaded-files-list"></div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-clipboard-check"></i> {% if is_rtl %}إنشاء تقرير التدقيق{% else %}Generate Audit Report{% endif %}
                </button>
            </form>
            
            <div id="audit-output" class="output-container hidden">
                <div class="output-content" id="audit-content"></div>
                <div class="download-buttons">
                    <button class="btn btn-secondary" onclick="downloadAudit('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadAudit('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadAudit('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Risk Tab - Enhanced -->
        <div class="tab-content hidden" id="risk-tab">
            <form id="risk-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.risk_category }}</label>
                        <select name="category" id="risk-category" required>
                            {% for cat, scenarios in risk_categories.items() %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{% if is_rtl %}السيناريو{% else %}Scenario{% endif %}</label>
                        <select name="scenario" id="risk-scenario">
                            <option value="">{% if is_rtl %}اختر سيناريو...{% else %}Select scenario...{% endif %}</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{ txt.asset_name }}</label>
                    <input type="text" name="asset" placeholder="{% if is_rtl %}قاعدة بيانات العملاء{% else %}Customer Database{% endif %}" required>
                </div>
                
                <div class="form-group">
                    <label>{% if is_rtl %}وصف إضافي للتهديد{% else %}Additional Threat Description{% endif %}</label>
                    <textarea name="threat" rows="3" placeholder="{% if is_rtl %}صف تفاصيل إضافية عن سيناريو التهديد...{% else %}Describe additional details about the threat scenario...{% endif %}"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-search"></i> {{ txt.analyze_risk }}
                </button>
            </form>
            
            <div id="risk-output" class="output-container hidden">
                <div class="output-content" id="risk-content"></div>
                <div class="download-buttons">
                    <button class="btn btn-secondary" onclick="downloadRisk('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadRisk('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadRisk('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="loading-overlay hidden" id="loading">
    <div class="loading-spinner"></div>
    <p>{{ txt.generating }}</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const lang = '{{ lang }}';
const isRtl = {{ 'true' if is_rtl else 'false' }};

// Risk categories with scenarios from server
const riskData = {{ risk_categories | tojson | safe }};

// Populate risk scenarios based on category selection
const categorySelect = document.getElementById('risk-category');
const scenarioSelect = document.getElementById('risk-scenario');

function updateScenarios() {
    const category = categorySelect.value;
    const scenarios = riskData[category] || [];
    
    scenarioSelect.innerHTML = '<option value="">' + (isRtl ? 'اختر سيناريو...' : 'Select scenario...') + '</option>';
    scenarios.forEach(scenario => {
        const option = document.createElement('option');
        option.value = scenario;
        option.textContent = scenario;
        scenarioSelect.appendChild(option);
    });
}

if (categorySelect) {
    categorySelect.addEventListener('change', updateScenarios);
    updateScenarios(); // Initialize on load
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.remove('hidden');
    });
});

document.querySelectorAll('.output-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        showSection(tab.dataset.section);
    });
});

let strategyData = {}, policyData = '', auditData = '', riskData2 = '';

function showSection(section) {
    document.getElementById('strategy-content').innerHTML = marked.parse(strategyData[section] || '');
}

function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

// File Upload - Fixed to prevent click loop
const fileArea = document.getElementById('file-upload-area');
const fileInput = document.getElementById('evidence-file');
if (fileArea && fileInput) {
    fileArea.addEventListener('click', (e) => {
        // Only trigger if clicking on the area itself, not the input
        if (e.target !== fileInput) {
            fileInput.click();
        }
    });
    fileInput.addEventListener('change', () => {
        const list = document.getElementById('uploaded-files');
        if (list && fileInput.files.length > 0) {
            list.innerHTML = Array.from(fileInput.files).map(f => 
                `<div class="uploaded-file"><i class="fas fa-file-pdf"></i> ${f.name}</div>`
            ).join('');
        }
    });
    // Prevent click from bubbling up from input
    fileInput.addEventListener('click', (e) => e.stopPropagation());
}

// Strategy Form
document.getElementById('strategy-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    const data = {
        domain: fd.get('domain'), language: fd.get('language'), org_name: fd.get('org_name'),
        sector: fd.get('sector'), size: fd.get('size'), budget: fd.get('budget'),
        frameworks: fd.getAll('frameworks'), org_structure: fd.get('org_structure'),
        technologies: fd.getAll('technologies'), 
        additional_tech: fd.get('additional_tech'),
        maturity_level: fd.get('maturity_level'),
        challenges: fd.get('challenges')
    };
    // Add additional tech to technologies if provided
    if (data.additional_tech) {
        data.technologies.push(data.additional_tech);
    }
    try {
        console.log('Sending strategy request:', data);
        const res = await fetch('/api/generate-strategy', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });
        console.log('Response status:', res.status);
        const result = await res.json();
        console.log('Response data:', result);
        console.log('DEBUG - Vision section first 200 chars:', result.sections?.vision?.substring(0, 200));
        if (result.success && result.sections) {
            strategyData = result.sections;
            document.getElementById('strategy-output').classList.remove('hidden');
            showSection('vision');
            Toast.success('{{ "تم إنشاء الاستراتيجية بنجاح" if is_rtl else "Strategy generated successfully" }}');
        } else {
            const errorMsg = result.error || 'Unknown error';
            console.error('Strategy generation failed:', errorMsg);
            Toast.error('{{ "خطأ في إنشاء الاستراتيجية" if is_rtl else "Error generating strategy" }}: ' + errorMsg);
        }
    } catch (e) { 
        console.error('Strategy error:', e);
        Toast.error('{{ "خطأ في إنشاء الاستراتيجية" if is_rtl else "Error generating strategy" }}'); 
    }
    hideLoading();
});

// Policy Form
document.getElementById('policy-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    try {
        const res = await fetch('/api/generate-policy', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain: fd.get('domain'), language: fd.get('language'),
                policy_name: fd.get('policy_name'), framework: fd.get('framework')})
        });
        const result = await res.json();
        if (result.success) {
            policyData = result.content;
            document.getElementById('policy-content').innerHTML = marked.parse(result.content);
            document.getElementById('policy-output').classList.remove('hidden');
        } else {
            alert(isRtl ? 'خطأ: ' + (result.error || 'فشل في إنشاء السياسة') : 'Error: ' + (result.error || 'Failed to generate policy'));
        }
    } catch (e) { 
        console.error('Policy error:', e);
        alert(isRtl ? 'خطأ في الاتصال' : 'Connection error'); 
    }
    hideLoading();
});

// Audit Form
document.getElementById('audit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    try {
        const res = await fetch('/api/generate-audit', { method: 'POST', body: fd });
        const result = await res.json();
        if (result.success) {
            auditData = result.content;
            document.getElementById('audit-content').innerHTML = marked.parse(result.content);
            document.getElementById('audit-output').classList.remove('hidden');
        } else {
            alert(isRtl ? 'خطأ: ' + (result.error || 'فشل في إنشاء التدقيق') : 'Error: ' + (result.error || 'Failed to generate audit'));
        }
    } catch (e) { 
        console.error('Audit error:', e);
        alert(isRtl ? 'خطأ في الاتصال' : 'Connection error'); 
    }
    hideLoading();
});

// Risk Form
document.getElementById('risk-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    const scenario = fd.get('scenario') || '';
    const additionalThreat = fd.get('threat') || '';
    const fullThreat = scenario + (additionalThreat ? '. ' + additionalThreat : '');
    
    try {
        const res = await fetch('/api/analyze-risk', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                domain: fd.get('domain'), 
                language: fd.get('language'),
                category: fd.get('category'), 
                asset: fd.get('asset'), 
                threat: fullThreat
            })
        });
        const result = await res.json();
        if (result.success) {
            riskData2 = result.analysis;
            document.getElementById('risk-content').innerHTML = marked.parse(result.analysis);
            document.getElementById('risk-output').classList.remove('hidden');
        }
    } catch (e) { alert('Error'); }
    hideLoading();
});

// Downloads - with correct section order
function downloadStrategy(fmt) {
    const sectionOrder = ['vision', 'gaps', 'pillars', 'roadmap', 'kpis', 'confidence'];
    
    const title = isRtl ? '# الاستراتيجية\n\n' : '# Strategy Document\n\n';
    
    // Build content with proper formatting
    let orderedContent = '';
    for (const key of sectionOrder) {
        if (strategyData[key] && strategyData[key].trim()) {
            let sectionContent = strategyData[key].trim();
            
            // Add section content (fix_formatting in backend should have added ## and ###)
            orderedContent += sectionContent + '\n\n---\n\n';
        }
    }
    
    // Remove trailing separator
    orderedContent = orderedContent.replace(/\n\n---\n\n$/, '');
    
    const footer = isRtl 
        ? '\n\n---\n**تاريخ الإعداد:** ' + new Date().toLocaleDateString('ar-SA') + '\n**المُعد:** فريق الحوكمة والمخاطر والامتثال'
        : '\n\n---\n**Preparation Date:** ' + new Date().toLocaleDateString('en-US') + '\n**Prepared By:** GRC Team';
    
    downloadFile(title + orderedContent + footer, 'strategy', fmt);
}
function downloadPolicy(fmt) { downloadFile(policyData, 'policy', fmt); }
function downloadAudit(fmt) { downloadFile(auditData, 'audit_report', fmt); }
function downloadRisk(fmt) { downloadFile(riskData2, 'risk_analysis', fmt); }

function downloadFile(content, name, fmt) {
    console.log('Download requested:', name, fmt);
    console.log('Content length:', content ? content.length : 0);
    console.log('Content preview:', content ? content.substring(0, 200) : 'EMPTY');
    
    if (!content || content.trim().length === 0) {
        alert(isRtl ? 'لا يوجد محتوى للتحميل' : 'No content to download');
        return;
    }
    
    if (fmt === 'pdf') {
        fetch('/api/generate-pdf', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content, filename: name, language: lang})
        }).then(r => {
            console.log('PDF response status:', r.status);
            if (!r.ok) {
                return r.text().then(text => {
                    console.error('PDF error response:', text);
                    throw new Error('PDF generation failed: ' + text);
                });
            }
            return r.blob();
        }).then(b => {
            console.log('PDF blob size:', b.size);
            if (b.size < 100) {
                throw new Error('Empty PDF');
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = name + '.pdf';
            a.click();
        }).catch(err => {
            console.error('PDF download error:', err);
            alert(isRtl ? 'حدث خطأ في إنشاء PDF. جاري التحميل كنص...' : 'Error creating PDF. Downloading as text...');
            downloadFile(content, name, 'txt');
        });
    } else if (fmt === 'docx') {
        fetch('/api/generate-docx', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content, filename: name, language: lang})
        }).then(r => {
            console.log('DOCX response status:', r.status);
            if (!r.ok) {
                return r.text().then(text => {
                    console.error('DOCX error response:', text);
                    throw new Error('DOCX generation failed: ' + text);
                });
            }
            return r.blob();
        }).then(b => {
            console.log('DOCX blob size:', b.size);
            if (b.size < 100) {
                throw new Error('Empty document');
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = name + '.docx';
            a.click();
        }).catch(err => {
            console.error('DOCX download error:', err);
            alert(isRtl ? 'حدث خطأ في إنشاء الملف. جاري التحميل كنص...' : 'Error creating DOCX. Downloading as text...');
            downloadFile(content, name, 'txt');
        });
    } else {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([content], {type: 'text/plain; charset=utf-8'}));
        a.download = name + '.txt';
        a.click();
    }
}
</script>
{% endblock %}
