{% extends "base.html" %}

{% block content %}
<div class="app-layout {{ 'rtl-layout' if is_rtl else '' }}">
    <!-- Sidebar -->
    <aside class="sidebar {{ 'sidebar-right' if is_rtl else 'sidebar-left' }}">
        <div class="sidebar-brand">
            <a href="{{ url_for('dashboard', lang=lang) }}">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Mizan Logo" class="sidebar-logo">
            </a>
        </div>
        
        <div class="sidebar-controls">
            <div class="sidebar-lang">
                <a href="{{ url_for('domain_page', domain_name=domain_name, lang='en') }}" class="lang-btn {{ 'active' if lang == 'en' else '' }}">EN</a>
                <a href="{{ url_for('domain_page', domain_name=domain_name, lang='ar') }}" class="lang-btn {{ 'active' if lang == 'ar' else '' }}">Ø¹</a>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <i class="fas fa-sun"></i>
            </button>
        </div>
        
        <a href="{{ url_for('dashboard', lang=lang) }}" class="back-btn">
            <i class="fas fa-arrow-{{ 'right' if is_rtl else 'left' }}"></i>
            {% if is_rtl %}Ø§Ù„Ø¹ÙˆØ¯Ø©{% else %}Back{% endif %}
        </a>
        
        <!-- Document History Link -->
        <a href="{{ url_for('document_history', lang=lang) }}" class="history-link">
            <i class="fas fa-folder-open"></i>
            {{ txt.my_documents }}
        </a>
        
        <div class="user-info">
            <div class="user-avatar"><i class="fas fa-user"></i></div>
            <div class="user-details">
                <span class="user-label">{{ txt.logged_in_as }}</span>
                <span class="user-name">{{ username }}</span>
                {% if session.get('role') == 'admin' %}
                <a href="{{ url_for('admin_dashboard') }}" class="admin-link"><i class="fas fa-crown"></i></a>
                {% endif %}
            </div>
        </div>
        
        <div class="ai-status {{ 'connected' if ai_available else 'disconnected' }}">
            <div class="status-dot"></div>
            <span>{{ txt.ai_connected if ai_available else txt.ai_disconnected }}</span>
        </div>
        
        <a href="{{ url_for('logout') }}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> {{ txt.logout }}
        </a>
        
        <div class="sidebar-footer">
            <p class="created-by">{{ txt.created_by }}</p>
            <p class="creator-name">{{ config.CREATOR_NAME_AR if is_rtl else config.CREATOR_NAME }}</p>
            <p class="copyright">Â© {{ config.COPYRIGHT_YEAR }}</p>
        </div>
    </aside>
    
    <main class="main-content">
        <header class="domain-header">
            <h1>{{ domain_name }}</h1>
            <!-- Usage Limits Display -->
            <div class="usage-limits-bar">
                <div class="usage-item">
                    <span class="usage-label">{{ 'Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©' if is_rtl else 'Strategy' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.strategies.remaining == 0 else '' }}">
                        {{ usage_info.strategies.used }}/{{ usage_info.strategies.limit }}
                    </span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">{{ 'Ø³ÙŠØ§Ø³Ø§Øª' if is_rtl else 'Policies' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.policies.remaining == 0 else '' }}">
                        {{ usage_info.policies.used }}/{{ usage_info.policies.limit }}
                    </span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">{{ 'ØªØ¯Ù‚ÙŠÙ‚' if is_rtl else 'Audits' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.audits.remaining == 0 else '' }}">
                        {{ usage_info.audits.used }}/{{ usage_info.audits.limit }}
                    </span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">{{ 'Ù…Ø®Ø§Ø·Ø±' if is_rtl else 'Risks' }}</span>
                    <span class="usage-count {{ 'limit-reached' if usage_info.risks.remaining == 0 else '' }}">
                        {{ usage_info.risks.used }}/{{ usage_info.risks.limit }}
                    </span>
                </div>
            </div>
        </header>
        
        <!-- Tabs -->
        <div class="tabs" {% if is_rtl %}style="display: flex; flex-direction: row-reverse;"{% endif %}>
            {% if is_rtl %}
            <!-- RTL: Tabs in reverse order -->
            <button class="tab" data-tab="awareness" style="flex-direction: row-reverse;">
                <i class="fas fa-graduation-cap"></i> {% if is_rtl %}Ø§Ù„ØªÙˆØ¹ÙŠØ©{% else %}Awareness{% endif %}
            </button>
            {% if domain_code == 'erm' %}
            <button class="tab" data-tab="register" style="flex-direction: row-reverse;">
                <i class="fas fa-th-list"></i> {% if is_rtl %}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Register{% endif %}
            </button>
            {% endif %}
            <button class="tab" data-tab="risk" style="flex-direction: row-reverse;">
                <i class="fas fa-exclamation-triangle"></i> {{ txt.tabs[3] }}
            </button>
            <button class="tab" data-tab="audit" style="flex-direction: row-reverse;">
                <i class="fas fa-clipboard-check"></i> {{ txt.tabs[2] }}
            </button>
            <button class="tab" data-tab="policy" style="flex-direction: row-reverse;">
                <i class="fas fa-file-alt"></i> {{ txt.tabs[1] }}
            </button>
            <button class="tab active" data-tab="strategy" style="flex-direction: row-reverse;">
                <i class="fas fa-chess"></i> {{ txt.tabs[0] }}
            </button>
            {% else %}
            <!-- LTR: Normal order -->
            <button class="tab active" data-tab="strategy">
                <i class="fas fa-chess"></i> {{ txt.tabs[0] }}
            </button>
            <button class="tab" data-tab="policy">
                <i class="fas fa-file-alt"></i> {{ txt.tabs[1] }}
            </button>
            <button class="tab" data-tab="audit">
                <i class="fas fa-clipboard-check"></i> {{ txt.tabs[2] }}
            </button>
            <button class="tab" data-tab="risk">
                <i class="fas fa-exclamation-triangle"></i> {{ txt.tabs[3] }}
            </button>
            {% if domain_code == 'erm' %}
            <button class="tab" data-tab="register">
                <i class="fas fa-th-list"></i> {% if is_rtl %}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Register{% endif %}
            </button>
            {% endif %}
            <button class="tab" data-tab="awareness">
                <i class="fas fa-graduation-cap"></i> {% if is_rtl %}Ø§Ù„ØªÙˆØ¹ÙŠØ©{% else %}Awareness{% endif %}
            </button>
            {% endif %}
        </div>
        
        <!-- Strategy Tab -->
        <div class="tab-content active" id="strategy-tab">
            <form id="strategy-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.org_name }}</label>
                        <input type="text" name="org_name" value="{% if is_rtl %}Ù…Ù†Ø¸Ù…ØªÙŠ{% else %}My Organization{% endif %}" required>
                    </div>
                    <div class="form-group">
                        <label>{{ txt.sector }}</label>
                        <select name="sector" required>
                            {% for sector in txt.sectors %}
                            <option value="{{ sector }}">{{ sector }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.size }}</label>
                        <select name="size" required>
                            {% for size in txt.sizes %}
                            <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{{ txt.budget }}</label>
                        <select name="budget" required>
                            {% for budget in txt.budgets %}
                            <option value="{{ budget }}">{{ budget }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{ txt.frameworks }}</label>
                    <div class="frameworks-container">
                        {% if frameworks is mapping %}
                        <!-- Hierarchical frameworks by region -->
                        {% for region, region_frameworks in frameworks.items() %}
                        <div class="framework-region">
                            <div class="region-header" onclick="toggleRegion(this)">
                                <i class="fas fa-chevron-right region-chevron"></i>
                                <strong>
                                    {% if region == 'KSA' %}ğŸ‡¸ğŸ‡¦ Saudi Arabia (KSA)
                                    {% elif region == 'GCC' %}ğŸŒ Gulf Cooperation Council (GCC)
                                    {% elif region == 'EU' %}ğŸ‡ªğŸ‡º European Union (EU)
                                    {% elif region == 'US' %}ğŸ‡ºğŸ‡¸ United States (US)
                                    {% elif region == 'International' %}ğŸŒ International Standards
                                    {% elif region == 'Quality & Management' %}ğŸ“‹ Quality & Management
                                    {% elif region == 'Business Continuity' %}ğŸ”„ Business Continuity
                                    {% elif region == 'Audit & Assurance' %}âœ… Audit & Assurance
                                    {% elif region == 'Governance' %}ğŸ›ï¸ Governance
                                    {% elif region == 'Sector-Specific' %}ğŸ¢ Sector-Specific
                                    {% elif region == 'International Standards' %}ğŸŒ International Standards
                                    {% elif region == 'Financial Risk' %}ğŸ’° Financial Risk
                                    {% elif region == 'Operational Risk' %}âš™ï¸ Operational Risk
                                    {% elif region == 'Regional' %}ğŸ—ºï¸ Regional
                                    {% else %}{{ region }}
                                    {% endif %}
                                </strong>
                                <span class="framework-count">({{ region_frameworks|length }})</span>
                            </div>
                            <div class="region-frameworks" style="display: none;">
                                {% for framework in region_frameworks %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="frameworks" value="{{ framework }}">
                                    <span>{{ framework }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <!-- Flat list fallback -->
                        <div class="checkbox-group">
                            {% for framework in frameworks_flat %}
                            <label class="checkbox-label">
                                <input type="checkbox" name="frameworks" value="{{ framework }}">
                                <span>{{ framework }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Current State Assessment - Domain Specific -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <i class="fas fa-building"></i>
                        {% if is_rtl %}ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ{% else %}Current State Assessment{% endif %}
                    </h3>
                    
                    <div class="form-group">
                        <label>{% if is_rtl %}Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ{% else %}Current Organizational Structure{% endif %}</label>
                        <select name="org_structure">
                            {% if is_rtl %}
                            <option value="centralized">Ù…Ø±ÙƒØ²ÙŠ - ÙØ±ÙŠÙ‚ Ù…Ø±ÙƒØ²ÙŠ</option>
                            <option value="distributed">Ù…ÙˆØ²Ø¹ - ÙØ±Ù‚ ÙÙŠ ÙƒÙ„ Ù‚Ø³Ù…</option>
                            <option value="hybrid">Ù‡Ø¬ÙŠÙ† - Ù…Ø±ÙƒØ²ÙŠ Ù…Ø¹ Ù…Ù†Ø³Ù‚ÙŠÙ†</option>
                            <option value="outsourced">Ø®Ø§Ø±Ø¬ÙŠ - Ù…Ø²ÙˆØ¯ Ø®Ø¯Ù…Ø§Øª</option>
                            <option value="none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡ÙŠÙƒÙ„ Ù…Ø­Ø¯Ø¯</option>
                            {% else %}
                            <option value="centralized">Centralized - Central Team</option>
                            <option value="distributed">Distributed - Teams in Each Department</option>
                            <option value="hybrid">Hybrid - Central with Coordinators</option>
                            <option value="outsourced">Outsourced - Managed Service Provider</option>
                            <option value="none">No Defined Structure</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Domain-Specific Technologies -->
                    <div class="form-group">
                        <label>
                            <i class="fas fa-cogs"></i>
                            {% if is_rtl %}Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª ÙˆØ§Ù„Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹{% else %}Currently Implemented Technologies & Controls{% endif %}
                        </label>
                        
                        {% for category, techs in technologies.items() %}
                        <div class="tech-category">
                            <h4 class="tech-category-title">{{ category }}</h4>
                            <div class="checkbox-group tech-group">
                                {% for tech in techs %}
                                <label class="checkbox-label">
                                    <input type="checkbox" name="technologies" value="{{ tech }}">
                                    <span>{{ tech }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="form-group">
                        <label>{% if is_rtl %}ØªÙ‚Ù†ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© (ØºÙŠØ± Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡){% else %}Additional Technologies (not listed above){% endif %}</label>
                        <textarea name="additional_tech" rows="2" placeholder="{% if is_rtl %}Ø£Ø¯Ø®Ù„ Ø£ÙŠ ØªÙ‚Ù†ÙŠØ§Øª Ø£Ø®Ø±Ù‰ Ù…Ø·Ø¨Ù‚Ø©...{% else %}Enter any other implemented technologies...{% endif %}"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>{% if is_rtl %}Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø¶Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ{% else %}Current Maturity Level{% endif %}</label>
                        <select name="maturity_level">
                            {% if is_rtl %}
                            <option value="initial">Ù…Ø¨Ø¯Ø¦ÙŠ (1) - Ø¹Ù…Ù„ÙŠØ§Øª ØºÙŠØ± Ù…Ù†Ø¸Ù…Ø©</option>
                            <option value="developing">Ù†Ø§Ù…Ù (2) - Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù…ÙˆØ«Ù‚Ø©</option>
                            <option value="defined">Ù…Ø­Ø¯Ø¯ (3) - Ø¹Ù…Ù„ÙŠØ§Øª Ù…ÙˆØ­Ø¯Ø©</option>
                            <option value="managed">Ù…ÙØ¯Ø§Ø± (4) - Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ù‚Ø§Ø³Ø©</option>
                            <option value="optimized">Ù…Ø­Ø³Ù‘Ù† (5) - ØªØ­Ø³ÙŠÙ† Ù…Ø³ØªÙ…Ø±</option>
                            {% else %}
                            <option value="initial">Initial (1) - Ad-hoc processes</option>
                            <option value="developing">Developing (2) - Some documented</option>
                            <option value="defined">Defined (3) - Standardized</option>
                            <option value="managed">Managed (4) - Measured</option>
                            <option value="optimized">Optimized (5) - Continuous improvement</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{ txt.challenges }}</label>
                    <textarea name="challenges" rows="3" placeholder="{% if is_rtl %}ØµÙ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...{% else %}Describe key challenges...{% endif %}"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-magic"></i> {{ txt.generate }}
                </button>
            </form>
            
            <div id="strategy-output" class="output-container hidden">
                <div class="output-tabs" {% if is_rtl %}style="display: flex; flex-direction: row-reverse;"{% endif %}>
                    {% if is_rtl %}
                    <!-- RTL: Tabs in reverse order so they appear right-to-left -->
                    <button class="output-tab" data-section="kpis">{{ txt.strategy_sections.kpis }}</button>
                    <button class="output-tab" data-section="roadmap">{{ txt.strategy_sections.roadmap }}</button>
                    <button class="output-tab" data-section="pillars">{{ txt.strategy_sections.pillars }}</button>
                    <button class="output-tab" data-section="gaps">{{ txt.strategy_sections.gaps }}</button>
                    <button class="output-tab active" data-section="vision">{{ txt.strategy_sections.vision }}</button>
                    {% else %}
                    <!-- LTR: Normal order -->
                    <button class="output-tab active" data-section="vision">{{ txt.strategy_sections.vision }}</button>
                    <button class="output-tab" data-section="gaps">{{ txt.strategy_sections.gaps }}</button>
                    <button class="output-tab" data-section="pillars">{{ txt.strategy_sections.pillars }}</button>
                    <button class="output-tab" data-section="roadmap">{{ txt.strategy_sections.roadmap }}</button>
                    <button class="output-tab" data-section="kpis">{{ txt.strategy_sections.kpis }}</button>
                    {% endif %}
                </div>
                <div class="output-content" id="strategy-content"></div>
                <div class="download-buttons" {% if is_rtl %}style="flex-direction: row-reverse;"{% endif %}>
                    <button class="btn btn-secondary" onclick="downloadStrategy('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadStrategy('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadStrategy('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-info" onclick="printDocument('strategy')">
                        <i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}
                    </button>
                </div>
                <!-- Chat with Document -->
                <div class="chat-section">
                    <h4><i class="fas fa-comments"></i> {{ txt.chat_document }}</h4>
                    <div class="chat-messages" id="strategy-chat-messages"></div>
                    <div class="chat-input-row">
                        <input type="text" id="strategy-chat-input" placeholder="{{ txt.ask_question }}" onkeypress="if(event.key==='Enter')sendChat('strategy')">
                        <button class="btn btn-primary" onclick="sendChat('strategy')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Policy Tab -->
        <div class="tab-content hidden" id="policy-tab">
            <form id="policy-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <!-- Template Button -->
                <div class="template-btn-row">
                    <button type="button" class="btn btn-outline" onclick="openTemplateModal('policy')">
                        <i class="fas fa-folder-open"></i> {{ txt.use_template }}
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.policy_name }}</label>
                        <input type="text" name="policy_name" id="policy-name-input" placeholder="{% if is_rtl %}Ø³ÙŠØ§Ø³Ø© Ø£Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª{% else %}Information Security Policy{% endif %}" required>
                    </div>
                    <div class="form-group">
                        <label>{{ txt.policy_framework }}</label>
                        <select name="framework" id="policy-framework-select" required>
                            {% for framework in frameworks %}
                            <option value="{{ framework }}">{{ framework }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-file-alt"></i> {{ txt.generate_policy }}
                </button>
            </form>
            
            <div id="policy-output" class="output-container hidden">
                <div class="output-content policy-content" id="policy-content"></div>
                <div class="download-buttons">
                    <button class="btn btn-secondary" onclick="downloadPolicy('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadPolicy('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadPolicy('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-info" onclick="printDocument('policy')">
                        <i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}
                    </button>
                    <button class="btn btn-warning" onclick="openReviewModal()">
                        <i class="fas fa-search"></i> {{ txt.review_policy }}
                    </button>
                </div>
                <!-- Policy Review Results -->
                <div id="policy-review-output" class="review-output hidden">
                    <h4><i class="fas fa-clipboard-check"></i> {{ txt.review_policy }}</h4>
                    <div class="review-content" id="policy-review-content"></div>
                    <div style="margin-top:1rem;display:flex;gap:0.75rem;">
                        <button class="btn btn-primary" onclick="applyReviewToPolicy()">
                            <i class="fas fa-magic"></i> {% if is_rtl %}ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø­Ø³Ø¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©{% else %}Modify Policy Based on Review{% endif %}
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('policy-review-output').classList.add('hidden')">
                            <i class="fas fa-times"></i> {% if is_rtl %}Ø¥ØºÙ„Ø§Ù‚{% else %}Dismiss{% endif %}
                        </button>
                    </div>
                </div>
                <!-- Chat with Document -->
                <div class="chat-section">
                    <h4><i class="fas fa-comments"></i> {{ txt.chat_document }}</h4>
                    <div class="chat-messages" id="policy-chat-messages"></div>
                    <div class="chat-input-row">
                        <input type="text" id="policy-chat-input" placeholder="{{ txt.ask_question }}" onkeypress="if(event.key==='Enter')sendChat('policy')">
                        <button class="btn btn-primary" onclick="sendChat('policy')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Audit Tab -->
        <div class="tab-content hidden" id="audit-tab">
            <form id="audit-form" class="grc-form" enctype="multipart/form-data">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <!-- Template Button -->
                <div class="template-btn-row">
                    <button type="button" class="btn btn-outline" onclick="openTemplateModal('audit')">
                        <i class="fas fa-folder-open"></i> {{ txt.use_template }}
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{% if is_rtl %}Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚{% else %}Audit Standard{% endif %}</label>
                        <select name="framework" id="audit-framework-select" required>
                            {% for framework in frameworks %}
                            <option value="{{ framework }}">{{ framework }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{% if is_rtl %}Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚{% else %}Audit Scope{% endif %}</label>
                        <select name="audit_scope" id="audit-scope-select">
                            {% if is_rtl %}
                            <option value="full">ØªØ¯Ù‚ÙŠÙ‚ Ø´Ø§Ù…Ù„</option>
                            <option value="controls">ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¶ÙˆØ§Ø¨Ø·</option>
                            <option value="compliance">ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</option>
                            {% else %}
                            <option value="full">Full Audit</option>
                            <option value="controls">Controls Audit</option>
                            <option value="compliance">Compliance Audit</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-upload"></i> {% if is_rtl %}Ø±ÙØ¹ Ø§Ù„Ø£Ø¯Ù„Ø© (PDF){% else %}Upload Evidence (PDF){% endif %}</label>
                    <div class="file-upload-area" id="file-upload-area">
                        <input type="file" name="evidence" id="evidence-file" accept=".pdf" multiple>
                        <div class="file-upload-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>{% if is_rtl %}Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø§Ù†Ù‚Ø±{% else %}Drag files or click{% endif %}</p>
                        </div>
                    </div>
                    <div id="uploaded-files" class="uploaded-files-list"></div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-clipboard-check"></i> {% if is_rtl %}Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚{% else %}Generate Audit Report{% endif %}
                </button>
            </form>
            
            <div id="audit-output" class="output-container hidden">
                <div class="output-content" id="audit-content"></div>
                <div class="download-buttons">
                    <button class="btn btn-secondary" onclick="downloadAudit('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadAudit('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadAudit('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-info" onclick="printDocument('audit')">
                        <i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Risk Tab - Enhanced -->
        <div class="tab-content hidden" id="risk-tab">
            <form id="risk-form" class="grc-form">
                <input type="hidden" name="domain" value="{{ domain_name }}">
                <input type="hidden" name="language" value="{{ lang }}">
                
                <!-- Template Button -->
                <div class="template-btn-row">
                    <button type="button" class="btn btn-outline" onclick="openTemplateModal('risk')">
                        <i class="fas fa-folder-open"></i> {{ txt.use_template }}
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>{{ txt.risk_category }}</label>
                        <select name="category" id="risk-category" required>
                            {% for cat, scenarios in risk_categories.items() %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{% if is_rtl %}Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ{% else %}Scenario{% endif %}</label>
                        <select name="scenario" id="risk-scenario">
                            <option value="">{% if is_rtl %}Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ...{% else %}Select scenario...{% endif %}</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{ txt.asset_name }}</label>
                    <input type="text" name="asset" id="risk-asset-input" placeholder="{% if is_rtl %}Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡{% else %}Customer Database{% endif %}" required>
                </div>
                
                <div class="form-group">
                    <label>{% if is_rtl %}ÙˆØµÙ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªÙ‡Ø¯ÙŠØ¯{% else %}Additional Threat Description{% endif %}</label>
                    <textarea name="threat" id="risk-threat-input" rows="3" placeholder="{% if is_rtl %}ØµÙ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯...{% else %}Describe additional details about the threat scenario...{% endif %}"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-search"></i> {{ txt.analyze_risk }}
                </button>
            </form>
            
            <div id="risk-output" class="output-container hidden">
                <div class="output-content" id="risk-content"></div>
                <div class="download-buttons">
                    <button class="btn btn-secondary" onclick="downloadRisk('txt')">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="btn btn-primary" onclick="downloadRisk('docx')">
                        <i class="fas fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-danger" onclick="downloadRisk('pdf')">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-info" onclick="printDocument('risk')">
                        <i class="fas fa-print"></i> {% if is_rtl %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}
                    </button>
                </div>
            </div>
        </div>
        
        {% if domain_code == 'erm' %}
        <!-- ERM Risk Register Tab -->
        <div class="tab-content hidden" id="register-tab">
            <div class="erm-workspace">
                <!-- Risk Register Header -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:0.75rem;">
                    <h3 style="margin:0;"><i class="fas fa-th-list"></i> {% if is_rtl %}Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ©{% else %}Enterprise Risk Register{% endif %}</h3>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="openAddRiskModal()">
                            <i class="fas fa-plus"></i> {% if is_rtl %}Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø±{% else %}Add Risk{% endif %}
                        </button>
                        <button class="btn btn-info" onclick="toggleHeatMap()">
                            <i class="fas fa-fire"></i> {% if is_rtl %}Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©{% else %}Heat Map{% endif %}
                        </button>
                        <button class="btn btn-warning" onclick="generateRiskAppetite()">
                            <i class="fas fa-balance-scale"></i> {% if is_rtl %}Ø´Ù‡ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Appetite{% endif %}
                        </button>
                        <button class="btn btn-secondary" onclick="exportRiskRegister()">
                            <i class="fas fa-download"></i> {% if is_rtl %}ØªØµØ¯ÙŠØ±{% else %}Export{% endif %}
                        </button>
                    </div>
                </div>

                <!-- Risk Heat Map (toggleable) -->
                <div id="risk-heatmap" class="hidden" style="margin-bottom:1.5rem;background:var(--card-bg);border-radius:12px;padding:1.5rem;border:1px solid var(--border-color);">
                    <h4 style="margin-top:0;text-align:center;">{% if is_rtl %}Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Heat Map{% endif %}</h4>
                    <div id="heatmap-grid" style="display:grid;grid-template-columns:auto repeat(5,1fr);grid-template-rows:repeat(6,auto);gap:2px;max-width:600px;margin:0 auto;font-size:0.8rem;">
                        <!-- Header row -->
                        <div style="padding:8px;font-weight:700;text-align:center;"></div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ù†Ø§Ø¯Ø±{% else %}Rare{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ø¨Ø¹ÙŠØ¯{% else %}Unlikely{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ù…Ø­ØªÙ…Ù„{% else %}Possible{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ù…Ø±Ø¬Ø­{% else %}Likely{% endif %}</div>
                        <div style="padding:8px;font-weight:700;text-align:center;background:#e2e8f0;border-radius:4px;">{% if is_rtl %}Ø´Ø¨Ù‡ Ù…Ø¤ÙƒØ¯{% else %}Almost Certain{% endif %}</div>
                        <!-- Rows: Catastrophic(5), Major(4), Moderate(3), Minor(2), Insignificant(1) -->
                    </div>
                    <div id="heatmap-canvas" style="max-width:600px;margin:1rem auto 0;"></div>
                </div>

                <!-- Summary Stats -->
                <div id="register-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:1.5rem;">
                    <div class="stat-card" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;" id="stat-critical">0</div>
                        <div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ø­Ø±Ø¬{% else %}Critical{% endif %}</div>
                    </div>
                    <div class="stat-card" style="background:linear-gradient(135deg,#f97316,#ea580c);color:#fff;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;" id="stat-high">0</div>
                        <div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ø¹Ø§Ù„ÙŠ{% else %}High{% endif %}</div>
                    </div>
                    <div class="stat-card" style="background:linear-gradient(135deg,#eab308,#ca8a04);color:#fff;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;" id="stat-medium">0</div>
                        <div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ù…ØªÙˆØ³Ø·{% else %}Medium{% endif %}</div>
                    </div>
                    <div class="stat-card" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;" id="stat-low">0</div>
                        <div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ù…Ù†Ø®ÙØ¶{% else %}Low{% endif %}</div>
                    </div>
                    <div class="stat-card" style="background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;padding:1rem;border-radius:10px;text-align:center;">
                        <div style="font-size:1.8rem;font-weight:700;" id="stat-total">0</div>
                        <div style="font-size:0.85rem;opacity:0.9;">{% if is_rtl %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total{% endif %}</div>
                    </div>
                </div>

                <!-- Risk Register Table -->
                <div style="overflow-x:auto;background:var(--card-bg);border-radius:12px;border:1px solid var(--border-color);">
                    <table id="risk-register-table" style="width:100%;border-collapse:collapse;font-size:0.9rem;">
                        <thead>
                            <tr style="background:var(--primary-color);color:#fff;">
                                <th style="padding:12px 8px;text-align:{{ 'right' if is_rtl else 'left' }};">#</th>
                                <th style="padding:12px 8px;text-align:{{ 'right' if is_rtl else 'left' }};">{% if is_rtl %}Ø§Ø³Ù… Ø§Ù„Ø®Ø·Ø±{% else %}Risk Name{% endif %}</th>
                                <th style="padding:12px 8px;text-align:{{ 'right' if is_rtl else 'left' }};">{% if is_rtl %}Ø§Ù„ÙØ¦Ø©{% else %}Category{% endif %}</th>
                                <th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©{% else %}Likelihood{% endif %}</th>
                                <th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø§Ù„Ø£Ø«Ø±{% else %}Impact{% endif %}</th>
                                <th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø§Ù„Ø¯Ø±Ø¬Ø©{% else %}Score{% endif %}</th>
                                <th style="padding:12px 8px;text-align:{{ 'right' if is_rtl else 'left' }};">{% if is_rtl %}Ø§Ù„Ù…Ø§Ù„Ùƒ{% else %}Owner{% endif %}</th>
                                <th style="padding:12px 8px;text-align:{{ 'right' if is_rtl else 'left' }};">{% if is_rtl %}Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Treatment{% endif %}</th>
                                <th style="padding:12px 8px;text-align:{{ 'right' if is_rtl else 'left' }};">{% if is_rtl %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</th>
                                <th style="padding:12px 8px;text-align:center;">{% if is_rtl %}Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody id="risk-register-body">
                            <tr><td colspan="10" style="text-align:center;padding:2rem;color:#888;"><i class="fas fa-info-circle"></i> {% if is_rtl %}Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø·Ø± Ù…Ø³Ø¬Ù„Ø©. Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø±" Ù„Ù„Ø¨Ø¯Ø¡.{% else %}No risks registered. Click "Add Risk" to start.{% endif %}</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Risk Appetite Output -->
                <div id="risk-appetite-output" class="hidden" style="margin-top:1.5rem;background:var(--card-bg);border-radius:12px;padding:1.5rem;border:1px solid var(--border-color);">
                    <h4><i class="fas fa-balance-scale"></i> {% if is_rtl %}Ø¨ÙŠØ§Ù† Ø´Ù‡ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}Risk Appetite Statement{% endif %}</h4>
                    <div id="risk-appetite-content" class="output-content"></div>
                    <div class="download-buttons" style="margin-top:1rem;">
                        <button class="btn btn-primary" onclick="downloadRiskAppetite('docx')"><i class="fas fa-file-word"></i> Word</button>
                        <button class="btn btn-danger" onclick="downloadRiskAppetite('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Awareness Tab -->
        <div class="tab-content hidden" id="awareness-tab">
            <!-- Modules Grid -->
            <div id="awareness-modules-view">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                    <div>
                        <h2 style="margin:0;font-size:1.4rem;">
                            <i class="fas fa-graduation-cap" style="color:var(--primary);"></i>
                            {{ 'ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙˆØ¹ÙŠØ© ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨' if is_rtl else 'Awareness & Training Modules' }}
                        </h2>
                        <p style="margin:0.3rem 0 0;color:var(--text-secondary);font-size:0.9rem;">
                            {{ 'ØªØ¹Ù„Ù… ÙˆØ£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù…' if is_rtl else 'Learn, take quizzes, and earn completion badges' }}
                        </p>
                    </div>
                    <div id="awareness-progress-bar" style="display:flex;align-items:center;gap:0.8rem;background:var(--bg-elevated);padding:0.6rem 1rem;border-radius:var(--radius-sm);">
                        <span style="font-size:0.85rem;color:var(--text-secondary);">{{ 'Ø§Ù„ØªÙ‚Ø¯Ù…' if is_rtl else 'Progress' }}:</span>
                        <div style="width:120px;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;">
                            <div id="awareness-progress-fill" style="width:0%;height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:4px;transition:width 0.5s;"></div>
                        </div>
                        <span id="awareness-progress-text" style="font-size:0.85rem;font-weight:600;">0%</span>
                    </div>
                </div>
                
                <!-- Domain-Specific Modules -->
                <div id="awareness-modules-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.2rem;">
                    <!-- Loaded dynamically -->
                </div>
                
                <!-- GRC Professional Section -->
                {% if grc_professional_modules %}
                <div style="margin-top:2.5rem;padding-top:2rem;border-top:2px solid var(--border-color);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                        <div>
                            <h2 style="margin:0;font-size:1.3rem;">
                                <i class="fas fa-user-tie" style="color:var(--secondary);"></i>
                                {{ 'ØªØ¯Ø±ÙŠØ¨ Ù…Ø­ØªØ±ÙÙŠ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„' if is_rtl else 'GRC Professional Training' }}
                            </h2>
                            <p style="margin:0.3rem 0 0;color:var(--text-secondary);font-size:0.9rem;">
                                {{ 'ÙÙ‡Ù… Ø§Ù„Ø£Ø·Ø± ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±' if is_rtl else 'Understanding Frameworks, Regulations & Standards' }}
                            </p>
                        </div>
                        <span class="badge" style="background:linear-gradient(135deg,var(--secondary),var(--primary));color:white;padding:0.4rem 1rem;font-size:0.8rem;">
                            <i class="fas fa-star"></i> {{ 'Ù„Ù„Ù…Ø­ØªØ±ÙÙŠÙ†' if is_rtl else 'Professional' }}
                        </span>
                    </div>
                    <div id="grc-professional-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.2rem;">
                        {% for module in grc_professional_modules %}
                        <div class="awareness-card" onclick="startAwarenessModule('{{ module.id }}')" style="cursor:pointer;background:var(--bg-elevated);border-radius:var(--radius-md);padding:1.2rem;border:1px solid var(--border-color);transition:all 0.2s;">
                            <div style="display:flex;align-items:flex-start;gap:1rem;">
                                <div style="width:50px;height:50px;background:linear-gradient(135deg,var(--secondary),var(--primary));border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                    <i class="{{ module.icon }}" style="color:white;font-size:1.3rem;"></i>
                                </div>
                                <div style="flex:1;min-width:0;">
                                    <h4 style="margin:0 0 0.3rem;font-size:1rem;color:var(--text-primary);">{{ module.title }}</h4>
                                    <p style="margin:0;font-size:0.8rem;color:var(--text-secondary);line-height:1.4;">{{ module.description[:80] }}...</p>
                                </div>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;padding-top:0.8rem;border-top:1px solid var(--border-color);">
                                <div style="display:flex;gap:0.8rem;font-size:0.75rem;color:var(--text-secondary);">
                                    <span><i class="fas fa-signal"></i> {{ module.level }}</span>
                                    <span><i class="fas fa-clock"></i> {{ module.duration }}</span>
                                </div>
                                <span class="module-status" data-module="{{ module.id }}" style="font-size:0.75rem;padding:0.2rem 0.6rem;border-radius:4px;background:var(--bg-secondary);color:var(--text-secondary);">
                                    {{ 'Ø§Ø¨Ø¯Ø£' if is_rtl else 'Start' }} <i class="fas fa-arrow-{{ 'left' if is_rtl else 'right' }}"></i>
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Learning View -->
            <div id="awareness-learn-view" class="hidden">
                <button class="btn" onclick="showAwarenessModules()" style="margin-bottom:1rem;">
                    <i class="fas fa-arrow-{{ 'right' if is_rtl else 'left' }}"></i> {{ 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø¯Ø§Øª' if is_rtl else 'Back to Modules' }}
                </button>
                <div id="awareness-learn-content" style="background:var(--bg-elevated);border-radius:var(--radius-lg);padding:2rem;border:1px solid var(--border-color);">
                    <!-- Dynamic content -->
                </div>
            </div>
            
            <!-- Quiz View -->
            <div id="awareness-quiz-view" class="hidden">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <button class="btn" onclick="showAwarenessModules()">
                        <i class="fas fa-arrow-{{ 'right' if is_rtl else 'left' }}"></i> {{ 'Ø§Ù„Ø¹ÙˆØ¯Ø©' if is_rtl else 'Back' }}
                    </button>
                    <div id="quiz-progress-indicator" style="font-size:0.9rem;color:var(--text-secondary);"></div>
                </div>
                <div id="awareness-quiz-content" style="background:var(--bg-elevated);border-radius:var(--radius-lg);padding:2rem;border:1px solid var(--border-color);">
                    <!-- Dynamic quiz -->
                </div>
            </div>
            
            <!-- Results View -->
            <div id="awareness-results-view" class="hidden">
                <div id="awareness-results-content" style="text-align:center;padding:2rem;">
                    <!-- Dynamic results -->
                </div>
            </div>
        </div>
    </main>
</div>

<div class="loading-overlay hidden" id="loading">
    <div class="loading-spinner"></div>
    <p>{{ txt.generating }}</p>
</div>

<!-- Template Modal -->
<div class="modal-overlay hidden" id="template-modal">
    <div class="modal-content template-modal">
        <div class="modal-header">
            <h3><i class="fas fa-folder-open"></i> {{ txt.select_template }}</h3>
            <button class="modal-close" onclick="closeTemplateModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="template-list" id="template-list">
                <!-- Templates loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Policy Review Modal -->
<div class="modal-overlay hidden" id="review-modal">
    <div class="modal-content template-modal">
        <div class="modal-header">
            <h3><i class="fas fa-search"></i> {{ txt.review_policy }}</h3>
            <button class="modal-close" onclick="closeReviewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>{{ txt.review_type }}</label>
                <select id="review-type-select">
                    <option value="comprehensive">{{ txt.comprehensive_review }}</option>
                    <option value="compliance">{{ txt.compliance_review }}</option>
                    <option value="gaps">{{ txt.gap_analysis }}</option>
                </select>
            </div>
            <button class="btn btn-primary btn-block" onclick="startPolicyReview()">
                <i class="fas fa-play"></i> {{ txt.start_review }}
            </button>
        </div>
    </div>
</div>

<!-- Gap Remediation Modal -->

{% if domain_code == 'erm' %}
<!-- Add Risk Modal -->
<div class="modal-overlay hidden" id="add-risk-modal">
    <div class="modal-content template-modal" style="max-width:600px;">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> {% if is_rtl %}Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø± Ø¬Ø¯ÙŠØ¯{% else %}Add New Risk{% endif %}</h3>
            <button class="modal-close" onclick="closeAddRiskModal()">&times;</button>
        </div>
        <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
            <div class="form-group">
                <label>{% if is_rtl %}Ø§Ø³Ù… Ø§Ù„Ø®Ø·Ø±{% else %}Risk Name{% endif %} *</label>
                <input type="text" id="risk-reg-name" placeholder="{% if is_rtl %}Ù…Ø«Ø§Ù„: ØªØ³Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª{% else %}e.g. Data Breach{% endif %}" required>
            </div>
            <div class="form-group">
                <label>{% if is_rtl %}Ø§Ù„ÙˆØµÙ{% else %}Description{% endif %}</label>
                <textarea id="risk-reg-desc" rows="2" placeholder="{% if is_rtl %}ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø®Ø·Ø±...{% else %}Detailed risk description...{% endif %}"></textarea>
            </div>
            <div class="form-group">
                <label>{% if is_rtl %}Ø§Ù„ÙØ¦Ø©{% else %}Category{% endif %}</label>
                <select id="risk-reg-category">
                    {% if is_rtl %}
                    <option value="Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ">Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</option>
                    <option value="ØªØ´ØºÙŠÙ„ÙŠ">ØªØ´ØºÙŠÙ„ÙŠ</option>
                    <option value="Ù…Ø§Ù„ÙŠ">Ù…Ø§Ù„ÙŠ</option>
                    <option value="Ø§Ù…ØªØ«Ø§Ù„">Ø§Ù…ØªØ«Ø§Ù„</option>
                    <option value="ØªÙ‚Ù†ÙŠ">ØªÙ‚Ù†ÙŠ</option>
                    <option value="Ø³Ù…Ø¹Ø©">Ø³Ù…Ø¹Ø©</option>
                    <option value="Ø¨ÙŠØ¦ÙŠ">Ø¨ÙŠØ¦ÙŠ</option>
                    <option value="Ù‚Ø§Ù†ÙˆÙ†ÙŠ">Ù‚Ø§Ù†ÙˆÙ†ÙŠ</option>
                    {% else %}
                    <option value="Strategic">Strategic</option>
                    <option value="Operational">Operational</option>
                    <option value="Financial">Financial</option>
                    <option value="Compliance">Compliance</option>
                    <option value="Technology">Technology</option>
                    <option value="Reputational">Reputational</option>
                    <option value="Environmental">Environmental</option>
                    <option value="Legal">Legal</option>
                    {% endif %}
                </select>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group">
                    <label>{% if is_rtl %}Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© (1-5){% else %}Likelihood (1-5){% endif %}</label>
                    <select id="risk-reg-likelihood">
                        <option value="1">1 - {% if is_rtl %}Ù†Ø§Ø¯Ø±{% else %}Rare{% endif %}</option>
                        <option value="2">2 - {% if is_rtl %}Ø¨Ø¹ÙŠØ¯{% else %}Unlikely{% endif %}</option>
                        <option value="3" selected>3 - {% if is_rtl %}Ù…Ø­ØªÙ…Ù„{% else %}Possible{% endif %}</option>
                        <option value="4">4 - {% if is_rtl %}Ù…Ø±Ø¬Ø­{% else %}Likely{% endif %}</option>
                        <option value="5">5 - {% if is_rtl %}Ø´Ø¨Ù‡ Ù…Ø¤ÙƒØ¯{% else %}Almost Certain{% endif %}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>{% if is_rtl %}Ø§Ù„Ø£Ø«Ø± (1-5){% else %}Impact (1-5){% endif %}</label>
                    <select id="risk-reg-impact">
                        <option value="1">1 - {% if is_rtl %}Ø¶Ø¦ÙŠÙ„{% else %}Insignificant{% endif %}</option>
                        <option value="2">2 - {% if is_rtl %}Ø·ÙÙŠÙ{% else %}Minor{% endif %}</option>
                        <option value="3" selected>3 - {% if is_rtl %}Ù…ØªÙˆØ³Ø·{% else %}Moderate{% endif %}</option>
                        <option value="4">4 - {% if is_rtl %}ÙƒØ¨ÙŠØ±{% else %}Major{% endif %}</option>
                        <option value="5">5 - {% if is_rtl %}ÙƒØ§Ø±Ø«ÙŠ{% else %}Catastrophic{% endif %}</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>{% if is_rtl %}Ù…Ø§Ù„Ùƒ Ø§Ù„Ø®Ø·Ø±{% else %}Risk Owner{% endif %}</label>
                <input type="text" id="risk-reg-owner" placeholder="{% if is_rtl %}Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±{% else %}e.g. Chief Risk Officer{% endif %}">
            </div>
            <div class="form-group">
                <label>{% if is_rtl %}Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Treatment Strategy{% endif %}</label>
                <select id="risk-reg-treatment">
                    {% if is_rtl %}
                    <option value="ØªØ®ÙÙŠÙ">ØªØ®ÙÙŠÙ</option>
                    <option value="Ù†Ù‚Ù„">Ù†Ù‚Ù„</option>
                    <option value="ØªØ¬Ù†Ø¨">ØªØ¬Ù†Ø¨</option>
                    <option value="Ù‚Ø¨ÙˆÙ„">Ù‚Ø¨ÙˆÙ„</option>
                    {% else %}
                    <option value="Mitigate">Mitigate</option>
                    <option value="Transfer">Transfer</option>
                    <option value="Avoid">Avoid</option>
                    <option value="Accept">Accept</option>
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label>{% if is_rtl %}Ø®Ø·Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Treatment Plan{% endif %}</label>
                <textarea id="risk-reg-plan" rows="2" placeholder="{% if is_rtl %}ØµÙ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...{% else %}Describe treatment actions...{% endif %}"></textarea>
            </div>
            <div class="form-group">
                <label>{% if is_rtl %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</label>
                <select id="risk-reg-status">
                    {% if is_rtl %}
                    <option value="Ù…ÙØªÙˆØ­">Ù…ÙØªÙˆØ­</option>
                    <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                    <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
                    <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
                    {% else %}
                    <option value="Open">Open</option>
                    <option value="In Treatment">In Treatment</option>
                    <option value="Closed">Closed</option>
                    <option value="Accepted">Accepted</option>
                    {% endif %}
                </select>
            </div>
            <input type="hidden" id="risk-reg-edit-id" value="">
            <button class="btn btn-primary btn-block" onclick="saveRiskEntry()">
                <i class="fas fa-save"></i> {% if is_rtl %}Ø­ÙØ¸ Ø§Ù„Ø®Ø·Ø±{% else %}Save Risk{% endif %}
            </button>
        </div>
    </div>
</div>
{% endif %}
<div class="modal-overlay hidden" id="remediation-modal">
    <div class="modal-content template-modal">
        <div class="modal-header">
            <h3><i class="fas fa-tools"></i> {{ txt.gap_remediation }}</h3>
            <button class="modal-close" onclick="closeRemediationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>{{ txt.enter_gaps }}</label>
                <textarea id="gaps-input" rows="5" placeholder="{% if is_rtl %}Ù…Ø«Ø§Ù„: Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø³ÙŠØ§Ø³Ø© Ø£Ù…Ù†ÙŠØ© Ø´Ø§Ù…Ù„Ø©{% else %}Example: No comprehensive security policy{% endif %}"></textarea>
            </div>
            <button class="btn btn-primary btn-block" onclick="generateRemediationPlan()">
                <i class="fas fa-cogs"></i> {{ txt.generate_plan }}
            </button>
            <div id="remediation-output" class="remediation-output hidden">
                <h4>{% if is_rtl %}Ø®Ø·Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©{% else %}Remediation Plan{% endif %}</h4>
                <div id="remediation-content"></div>
            </div>
        </div>
    </div>
</div>

<style>
/* Template Button Row */
.template-btn-row {
    margin-bottom: 15px;
}

.btn-outline {
    background: transparent;
    border: 2px dashed var(--primary);
    color: var(--primary);
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-outline:hover {
    background: rgba(102, 126, 234, 0.1);
    border-style: solid;
}

/* Chat Section */
.chat-section {
    margin-top: 20px;
    padding: 15px;
    background: var(--bg-elevated);
    border-radius: 10px;
    border: 1px solid var(--border);
}

.chat-section h4 {
    margin: 0 0 15px 0;
    color: var(--primary);
}

.chat-messages {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 10px;
    padding: 10px;
    background: var(--bg-card);
    border-radius: 8px;
    min-height: 60px;
}

.chat-message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 8px;
}

.chat-message.user {
    background: var(--primary);
    color: white;
    margin-{{ 'right' if is_rtl else 'left' }}: 20%;
}

.chat-message.assistant {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    margin-{{ 'left' if is_rtl else 'right' }}: 20%;
}

.chat-input-row {
    display: flex;
    gap: 10px;
}

.chat-input-row input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-card);
    color: var(--text-primary);
}

.chat-input-row button {
    padding: 10px 15px;
}

/* Review Output */
.review-output {
    margin-top: 20px;
    padding: 15px;
    background: var(--bg-elevated);
    border-radius: 10px;
    border: 1px solid var(--border);
}

.review-output h4 {
    margin: 0 0 15px 0;
    color: var(--warning);
}

.review-content {
    line-height: 1.6;
}

/* Remediation Output */
.remediation-output {
    margin-top: 20px;
    padding: 15px;
    background: var(--bg-card);
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
}

#gaps-input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-card);
    color: var(--text-primary);
    resize: vertical;
}

/* Template Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.modal-overlay.hidden {
    display: none;
}

.template-modal {
    background: var(--bg-card);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.modal-close:hover {
    opacity: 1;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.template-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.template-item {
    background: var(--bg-elevated);
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.template-item:hover {
    border-color: var(--primary);
    transform: translateX(5px);
}

.template-item h4 {
    margin: 0 0 8px 0;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.template-item h4 i {
    color: var(--primary);
}

.template-item p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.template-item .template-meta {
    margin-top: 10px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.template-tag {
    background: rgba(102, 126, 234, 0.2);
    color: var(--primary);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
}

.no-templates {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}

{% if is_rtl %}
.template-item:hover {
    transform: translateX(-5px);
}
{% endif %}

/* Frameworks by Region */
.frameworks-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
}

.framework-region {
    margin-bottom: 8px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
}

.region-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background: var(--bg-secondary);
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
}

.region-header:hover {
    background: var(--bg-hover);
}

.region-chevron {
    transition: transform 0.2s;
    color: var(--primary);
    font-size: 12px;
}

.region-header.expanded .region-chevron {
    transform: rotate(90deg);
}

.framework-count {
    color: var(--text-secondary);
    font-size: 12px;
    margin-{{ 'right' if is_rtl else 'left' }}: auto;
}

.region-frameworks {
    padding: 10px 15px;
    background: var(--bg-primary);
    border-top: 1px solid var(--border-color);
}

.region-frameworks .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    margin: 4px 0;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
}

.region-frameworks .checkbox-label:hover {
    background: var(--bg-hover);
}

.region-frameworks input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--primary);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const lang = '{{ lang }}';
const isRtl = {{ 'true' if is_rtl else 'false' }};

// Toggle framework region visibility
function toggleRegion(header) {
    const region = header.parentElement;
    const frameworks = region.querySelector('.region-frameworks');
    const isExpanded = frameworks.style.display !== 'none';
    
    frameworks.style.display = isExpanded ? 'none' : 'block';
    header.classList.toggle('expanded', !isExpanded);
}

// Global session check - handles 401 for all API calls
function checkSession(res) {
    if (res.status === 401) {
        Toast.error(isRtl ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' : 'Session expired. Please login again.');
        setTimeout(() => window.location.href = '/login', 1500);
        return false;
    }
    return true;
}

// Current template type
let currentTemplateType = '';
const currentDomain = '{{ domain_name }}';

// Template Modal Functions
function openTemplateModal(type) {
    currentTemplateType = type;
    document.getElementById('template-modal').classList.remove('hidden');
    loadTemplates(type);
}

function closeTemplateModal() {
    document.getElementById('template-modal').classList.add('hidden');
}

async function loadTemplates(type) {
    const listEl = document.getElementById('template-list');
    listEl.innerHTML = '<div class="no-templates"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
    
    try {
        const res = await fetch('/api/templates/' + type + '?lang=' + lang + '&domain=' + encodeURIComponent(currentDomain));
        const data = await res.json();
        
        if (data.success && Object.keys(data.templates).length > 0) {
            listEl.innerHTML = '';
            
            for (const [name, template] of Object.entries(data.templates)) {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.onclick = () => applyTemplate(type, name, template);
                
                let metaHtml = '';
                if (template.framework) {
                    metaHtml += '<span class="template-tag">' + template.framework + '</span>';
                }
                if (template.controls) {
                    metaHtml += '<span class="template-tag">' + template.controls + ' controls</span>';
                }
                if (template.horizon) {
                    metaHtml += '<span class="template-tag">' + template.horizon + '</span>';
                }
                
                item.innerHTML = 
                    '<h4><i class="fas fa-file-alt"></i> ' + name + '</h4>' +
                    '<p>' + template.description + '</p>' +
                    (metaHtml ? '<div class="template-meta">' + metaHtml + '</div>' : '');
                
                listEl.appendChild(item);
            }
        } else {
            listEl.innerHTML = '<div class="no-templates">' + (isRtl ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ù…ØªØ§Ø­Ø©' : 'No templates available') + '</div>';
        }
    } catch (e) {
        console.error('Error loading templates:', e);
        listEl.innerHTML = '<div class="no-templates">Error loading templates</div>';
    }
}

function applyTemplate(type, name, template) {
    if (type === 'policy') {
        document.getElementById('policy-name-input').value = name;
        // Try to set framework if matching option exists
        const frameworkSelect = document.getElementById('policy-framework-select');
        if (template.framework) {
            for (let opt of frameworkSelect.options) {
                if (opt.value.includes(template.framework) || template.framework.includes(opt.value.split(' ')[0])) {
                    opt.selected = true;
                    break;
                }
            }
        }
    } else if (type === 'audit') {
        const frameworkSelect = document.getElementById('audit-framework-select');
        if (template.framework) {
            for (let opt of frameworkSelect.options) {
                if (opt.value.includes(template.framework) || template.framework.includes(opt.value.split(' ')[0])) {
                    opt.selected = true;
                    break;
                }
            }
        }
    } else if (type === 'risk') {
        // Set first category from template if available
        if (template.categories && template.categories.length > 0) {
            document.getElementById('risk-asset-input').value = name;
        }
    }
    
    closeTemplateModal();
    Toast.success(isRtl ? 'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨' : 'Template applied');
}

// Risk categories with scenarios from server
const riskData = {{ risk_categories | tojson | safe }};

// Populate risk scenarios based on category selection
const categorySelect = document.getElementById('risk-category');
const scenarioSelect = document.getElementById('risk-scenario');

function updateScenarios() {
    const category = categorySelect.value;
    const scenarios = riskData[category] || [];
    
    scenarioSelect.innerHTML = '<option value="">' + (isRtl ? 'Ø§Ø®ØªØ± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ...' : 'Select scenario...') + '</option>';
    scenarios.forEach(scenario => {
        const option = document.createElement('option');
        option.value = scenario;
        option.textContent = scenario;
        scenarioSelect.appendChild(option);
    });
}

if (categorySelect) {
    categorySelect.addEventListener('change', updateScenarios);
    updateScenarios(); // Initialize on load
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + '-tab').classList.remove('hidden');
    });
});

// Activate tab from URL parameter (e.g. ?tab=policy)
(function() {
    const params = new URLSearchParams(window.location.search);
    const tabParam = params.get('tab');
    if (tabParam) {
        const targetTab = document.querySelector('.tab[data-tab="' + tabParam + '"]');
        const targetContent = document.getElementById(tabParam + '-tab');
        if (targetTab && targetContent) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            targetTab.classList.add('active');
            targetContent.classList.remove('hidden');
        }
    }
})();

document.querySelectorAll('.output-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        showSection(tab.dataset.section);
    });
});

let strategyData = {}, policyData = '', auditData = '', riskData2 = '';
let currentStrategyContent = '', currentPolicyContent = '', currentAuditContent = '', currentRiskContent = '';

function showSection(section) {
    document.getElementById('strategy-content').innerHTML = marked.parse(strategyData[section] || '');
}

function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

// File Upload - Fixed to prevent click loop
const fileArea = document.getElementById('file-upload-area');
const fileInput = document.getElementById('evidence-file');
if (fileArea && fileInput) {
    fileArea.addEventListener('click', (e) => {
        // Only trigger if clicking on the area itself, not the input
        if (e.target !== fileInput) {
            fileInput.click();
        }
    });
    fileInput.addEventListener('change', () => {
        const list = document.getElementById('uploaded-files');
        if (list && fileInput.files.length > 0) {
            list.innerHTML = Array.from(fileInput.files).map(f => 
                `<div class="uploaded-file"><i class="fas fa-file-pdf"></i> ${f.name}</div>`
            ).join('');
        }
    });
    // Prevent click from bubbling up from input
    fileInput.addEventListener('click', (e) => e.stopPropagation());
}

// Strategy Form
document.getElementById('strategy-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    const data = {
        domain: fd.get('domain'), language: fd.get('language'), org_name: fd.get('org_name'),
        sector: fd.get('sector'), size: fd.get('size'), budget: fd.get('budget'),
        frameworks: fd.getAll('frameworks'), org_structure: fd.get('org_structure'),
        technologies: fd.getAll('technologies'), 
        additional_tech: fd.get('additional_tech'),
        maturity_level: fd.get('maturity_level'),
        challenges: fd.get('challenges')
    };
    // Add additional tech to technologies if provided
    if (data.additional_tech) {
        data.technologies.push(data.additional_tech);
    }
    try {
        console.log('Sending strategy request:', data);
        const res = await fetch('/api/generate-strategy', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });
        console.log('Response status:', res.status);
        if (res.status === 401) {
            Toast.error('{{ "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰" if is_rtl else "Session expired. Please login again." }}');
            setTimeout(() => window.location.href = '/login', 1500);
            hideLoading();
            return;
        }
        const result = await res.json();
        console.log('Response data:', result);
        console.log('DEBUG - Vision section first 200 chars:', result.sections?.vision?.substring(0, 200));
        if (result.success && result.sections) {
            strategyData = result.sections;
            // Build full content for print/download
            currentStrategyContent = Object.values(result.sections).join('\n\n');
            document.getElementById('strategy-output').classList.remove('hidden');
            showSection('vision');
            Toast.success('{{ "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­" if is_rtl else "Strategy generated successfully" }}');
        } else {
            const errorMsg = result.error || 'Unknown error';
            console.error('Strategy generation failed:', errorMsg);
            Toast.error('{{ "Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©" if is_rtl else "Error generating strategy" }}: ' + errorMsg);
        }
    } catch (e) { 
        console.error('Strategy error:', e);
        Toast.error('{{ "Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©" if is_rtl else "Error generating strategy" }}'); 
    }
    hideLoading();
});

// Policy Form
document.getElementById('policy-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    try {
        const res = await fetch('/api/generate-policy', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({domain: fd.get('domain'), language: fd.get('language'),
                policy_name: fd.get('policy_name'), framework: fd.get('framework')})
        });
        if (!checkSession(res)) { hideLoading(); return; }
        const result = await res.json();
        if (result.success) {
            policyData = result.content;
            currentPolicyContent = result.content;
            document.getElementById('policy-content').innerHTML = marked.parse(result.content);
            document.getElementById('policy-output').classList.remove('hidden');
        } else {
            alert(isRtl ? 'Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø³Ø©') : 'Error: ' + (result.error || 'Failed to generate policy'));
        }
    } catch (e) { 
        console.error('Policy error:', e);
        alert(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error'); 
    }
    hideLoading();
});

// Audit Form
document.getElementById('audit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    try {
        const res = await fetch('/api/generate-audit', { method: 'POST', body: fd });
        if (!checkSession(res)) { hideLoading(); return; }
        const result = await res.json();
        if (result.success) {
            auditData = result.content;
            currentAuditContent = result.content;
            document.getElementById('audit-content').innerHTML = marked.parse(result.content);
            document.getElementById('audit-output').classList.remove('hidden');
        } else {
            alert(isRtl ? 'Ø®Ø·Ø£: ' + (result.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚') : 'Error: ' + (result.error || 'Failed to generate audit'));
        }
    } catch (e) { 
        console.error('Audit error:', e);
        alert(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error'); 
    }
    hideLoading();
});

// Risk Form
document.getElementById('risk-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();
    const fd = new FormData(e.target);
    const scenario = fd.get('scenario') || '';
    const additionalThreat = fd.get('threat') || '';
    const fullThreat = scenario + (additionalThreat ? '. ' + additionalThreat : '');
    
    try {
        const res = await fetch('/api/analyze-risk', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                domain: fd.get('domain'), 
                language: fd.get('language'),
                category: fd.get('category'), 
                asset: fd.get('asset'), 
                threat: fullThreat
            })
        });
        if (!checkSession(res)) { hideLoading(); return; }
        const result = await res.json();
        if (result.success) {
            riskData2 = result.analysis;
            currentRiskContent = result.analysis;
            document.getElementById('risk-content').innerHTML = marked.parse(result.analysis);
            document.getElementById('risk-output').classList.remove('hidden');
        }
    } catch (e) { alert('Error'); }
    hideLoading();
});

// Downloads - with correct section order
function downloadStrategy(fmt) {
    const sectionOrder = ['vision', 'gaps', 'pillars', 'roadmap', 'kpis', 'confidence'];
    
    const title = isRtl ? '# Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©\n\n' : '# Strategy Document\n\n';
    
    // Build content with proper formatting
    let orderedContent = '';
    for (const key of sectionOrder) {
        if (strategyData[key] && strategyData[key].trim()) {
            let sectionContent = strategyData[key].trim();
            
            // Add section content (fix_formatting in backend should have added ## and ###)
            orderedContent += sectionContent + '\n\n---\n\n';
        }
    }
    
    // Remove trailing separator
    orderedContent = orderedContent.replace(/\n\n---\n\n$/, '');
    
    const footer = isRtl 
        ? '\n\n---\n**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯:** ' + new Date().toLocaleDateString('ar-SA') + '\n**Ø§Ù„Ù…ÙØ¹Ø¯:** ÙØ±ÙŠÙ‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„'
        : '\n\n---\n**Preparation Date:** ' + new Date().toLocaleDateString('en-US') + '\n**Prepared By:** GRC Team';
    
    downloadFile(title + orderedContent + footer, 'strategy', fmt);
}
function downloadPolicy(fmt) { downloadFile(policyData, 'policy', fmt); }
function downloadAudit(fmt) { downloadFile(auditData, 'audit_report', fmt); }
function downloadRisk(fmt) { downloadFile(riskData2, 'risk_analysis', fmt); }

function downloadFile(content, name, fmt) {
    console.log('Download requested:', name, fmt);
    console.log('Content length:', content ? content.length : 0);
    
    if (!content || content.trim().length === 0) {
        alert(isRtl ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØ­Ù…ÙŠÙ„' : 'No content to download');
        return;
    }
    
    if (fmt === 'txt') {
        // Direct text download - no server needed
        const blob = new Blob([content], {type: 'text/plain; charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name + '.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        return;
    }
    
    // PDF or DOCX - use server generation
    const endpoint = fmt === 'pdf' ? '/api/generate-pdf' : '/api/generate-docx';
    const ext = fmt === 'pdf' ? '.pdf' : '.docx';
    
    console.log('Calling endpoint:', endpoint);
    
    // Use XMLHttpRequest for binary download (more reliable than fetch for blobs)
    const xhr = new XMLHttpRequest();
    xhr.open('POST', endpoint, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.responseType = 'blob';
    
    xhr.onload = function() {
        console.log('XHR status:', xhr.status);
        console.log('XHR response type:', xhr.response ? xhr.response.type : 'null');
        console.log('XHR response size:', xhr.response ? xhr.response.size : 0);
        
        if (xhr.status === 200) {
            const blob = xhr.response;
            // Check if response is actually an error (JSON instead of binary)
            if (blob.type && blob.type.includes('application/json')) {
                const reader = new FileReader();
                reader.onload = function() {
                    console.error('Server returned error:', reader.result);
                    try {
                        const err = JSON.parse(reader.result);
                        alert((isRtl ? 'Ø®Ø·Ø£: ' : 'Error: ') + (err.error || 'Unknown error'));
                    } catch(e) {
                        alert(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù' : 'Error generating file');
                    }
                };
                reader.readAsText(blob);
                return;
            }
            // Check if we got redirected to login page (HTML response)
            if (blob.type && blob.type.includes('text/html')) {
                console.error('Got HTML response - likely session expired');
                alert(isRtl ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' : 'Session expired. Please login again.');
                window.location.href = '/login';
                return;
            }
            if (blob.size < 100) {
                console.error('Response too small:', blob.size);
                alert(isRtl ? 'Ø®Ø·Ø£: Ù…Ù„Ù ÙØ§Ø±Øº' : 'Error: Empty file');
                return;
            }
            // Success - trigger download
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name + ext;
            document.body.appendChild(a);
            a.click();
            setTimeout(function() {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            console.log('Download triggered successfully!');
        } else {
            console.error('XHR error status:', xhr.status);
            if (xhr.status === 401) {
                alert(isRtl ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' : 'Session expired. Please login again.');
                window.location.href = '/login';
                return;
            }
            // Try to read error message
            const reader = new FileReader();
            reader.onload = function() {
                console.error('Error body:', reader.result);
                alert((isRtl ? 'Ø®Ø·Ø£ ' + xhr.status + ': ' : 'Error ' + xhr.status + ': ') + reader.result.substring(0, 200));
            };
            reader.readAsText(xhr.response);
        }
    };
    
    xhr.onerror = function() {
        console.error('XHR network error');
        alert(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…' : 'Network error connecting to server');
    };
    
    xhr.send(JSON.stringify({
        content: content,
        filename: name,
        language: lang
    }));
}

// Print Document Function
function printDocument(type) {
    let content = '';
    let title = '';
    
    if (type === 'strategy') {
        // Build content in explicit order for print
        const sectionOrder = ['vision', 'gaps', 'pillars', 'roadmap', 'kpis', 'confidence'];
        const parts = [];
        sectionOrder.forEach(key => {
            if (strategyData[key] && strategyData[key].trim()) {
                parts.push(strategyData[key].trim());
            }
        });
        content = parts.length > 0 ? parts.join('\n\n') : currentStrategyContent;
        title = isRtl ? 'Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©' : 'Strategy';
    } else if (type === 'policy') {
        content = currentPolicyContent;
        title = isRtl ? 'Ø§Ù„Ø³ÙŠØ§Ø³Ø©' : 'Policy';
    } else if (type === 'audit') {
        content = currentAuditContent;
        title = isRtl ? 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚' : 'Audit Report';
    } else if (type === 'risk') {
        content = currentRiskContent;
        title = isRtl ? 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±' : 'Risk Analysis';
    }
    
    if (!content) {
        alert(isRtl ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©' : 'No content to print');
        return;
    }
    
    // Create print window
    const printWindow = window.open('', '_blank');
    const htmlContent = marked.parse(content);
    const fontFamily = isRtl ? "'Noto Sans Arabic', 'Arial'" : "'Segoe UI', Arial";
    const textAlign = isRtl ? 'right' : 'left';
    const tagline = isRtl ? 'Ø§Ù„Ø­ÙˆÙƒÙ…Ø© â€¢ Ø§Ù„Ù…Ø®Ø§Ø·Ø± â€¢ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„' : 'Governance â€¢ Risk â€¢ Compliance';
    const footerText = isRtl ? 'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ù†ØµØ© Ù…ÙŠØ²Ø§Ù†' : 'Generated by Mizan GRC Platform';
    const paddingDir = isRtl ? 'right' : 'left';
    
    const doc = printWindow.document;
    doc.open();
    // IMPORTANT: Always use dir="ltr" on <html> to prevent section reversal in print.
    // Arabic text direction is handled at the content level via CSS.
    doc.write('<!DOCTYPE html><html lang="' + lang + '" dir="ltr">');
    doc.write('<head><meta charset="UTF-8"><title>' + title + ' - Mizan GRC</title>');
    doc.write('<style>');
    doc.write('@page { size: A4; margin: 2cm; }');
    doc.write('* { margin: 0; padding: 0; box-sizing: border-box; }');
    doc.write('body { font-family: ' + fontFamily + ', sans-serif; font-size: 12pt; line-height: 1.6; color: #333; direction: ltr; }');
    doc.write('.print-header { text-align: center; padding-bottom: 20px; margin-bottom: 30px; border-bottom: 2px solid #667eea; }');
    doc.write('.print-logo { font-size: 24pt; font-weight: bold; color: #667eea; margin-bottom: 5px; }');
    doc.write('.print-tagline { font-size: 10pt; color: #666; }');
    doc.write('.print-title { font-size: 14pt; margin-top: 10px; color: #333; }');
    // Content area gets RTL direction for Arabic text while keeping block flow top-to-bottom
    doc.write('.print-content { direction: ' + (isRtl ? 'rtl' : 'ltr') + '; text-align: ' + textAlign + '; }');
    doc.write('.print-content h1, .print-content h2, .print-content h3, .print-content h4, .print-content h5, .print-content h6, .print-content p, .print-content li, .print-content td, .print-content th { direction: ' + (isRtl ? 'rtl' : 'ltr') + '; text-align: ' + textAlign + '; unicode-bidi: embed; }');
    doc.write('h1, h2, h3 { color: #333; margin-top: 20px; margin-bottom: 10px; }');
    doc.write('h1 { font-size: 18pt; color: #667eea; }');
    doc.write('h2 { font-size: 14pt; border-bottom: 1px solid #ddd; padding-bottom: 5px; }');
    doc.write('h3 { font-size: 12pt; }');
    doc.write('p { margin-bottom: 10px; }');
    doc.write('table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 10pt; }');
    doc.write('th, td { border: 1px solid #ddd; padding: 8px; text-align: ' + textAlign + '; }');
    doc.write('th { background: #667eea; color: white; }');
    doc.write('tr:nth-child(even) { background: #f9f9f9; }');
    doc.write('ul, ol { padding-' + paddingDir + ': 20px; margin: 10px 0; }');
    doc.write('li { margin-bottom: 5px; }');
    doc.write('.print-footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 9pt; color: #666; }');
    doc.write('</style></head><body>');
    doc.write('<div class="print-header">');
    doc.write('<div class="print-logo">MIZAN</div>');
    doc.write('<div class="print-tagline">' + tagline + '</div>');
    doc.write('<div class="print-title">' + title + '</div>');
    doc.write('</div>');
    doc.write('<div class="print-content">' + htmlContent + '</div>');
    doc.write('<div class="print-footer">');
    doc.write('<p>' + footerText + ' | ' + new Date().toLocaleDateString() + '</p>');
    doc.write('<p>Created by Eng. Mohammad Abbas Alsaadon</p>');
    doc.write('</div>');
    doc.write('</body></html>');
    doc.close();
    
    // Trigger print after content loads
    printWindow.onload = function() {
        printWindow.print();
    };
}

// ============================================================================
// CHAT WITH DOCUMENT FEATURE
// ============================================================================

async function sendChat(docType) {
    const inputId = docType + '-chat-input';
    const messagesId = docType + '-chat-messages';
    const input = document.getElementById(inputId);
    const messagesDiv = document.getElementById(messagesId);
    const question = input.value.trim();
    
    if (!question) return;
    
    // Get document content
    let content = '';
    if (docType === 'strategy') content = currentStrategyContent;
    else if (docType === 'policy') content = currentPolicyContent;
    else if (docType === 'audit') content = currentAuditContent;
    else if (docType === 'risk') content = currentRiskContent;
    
    if (!content) {
        alert(isRtl ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©' : 'No content to chat about');
        return;
    }
    
    // Add user message
    const userMsg = document.createElement('div');
    userMsg.className = 'chat-message user';
    userMsg.textContent = question;
    messagesDiv.appendChild(userMsg);
    
    input.value = '';
    input.placeholder = isRtl ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' : 'Processing...';
    input.disabled = true;
    
    try {
        const res = await fetch('/api/chat-document', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                content: content,
                question: question,
                language: lang
            })
        });
        const data = await res.json();
        
        const assistantMsg = document.createElement('div');
        assistantMsg.className = 'chat-message assistant';
        
        if (data.success) {
            assistantMsg.innerHTML = marked.parse(data.response);
        } else {
            assistantMsg.textContent = isRtl ? 'Ø­Ø¯Ø« Ø®Ø·Ø£' : 'An error occurred';
        }
        messagesDiv.appendChild(assistantMsg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
    } catch (e) {
        console.error('Chat error:', e);
    }
    
    input.placeholder = isRtl ? 'Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©...' : 'Ask a question about this document...';
    input.disabled = false;
    input.focus();
}

// ============================================================================
// POLICY REVIEW FEATURE
// ============================================================================

function openReviewModal() {
    document.getElementById('review-modal').classList.remove('hidden');
}

function closeReviewModal() {
    document.getElementById('review-modal').classList.add('hidden');
}

async function startPolicyReview() {
    const reviewType = document.getElementById('review-type-select').value;
    
    if (!currentPolicyContent) {
        alert(isRtl ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'No policy to review');
        return;
    }
    
    closeReviewModal();
    showLoading();
    
    try {
        const res = await fetch('/api/review-policy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                content: currentPolicyContent,
                review_type: reviewType,
                framework: document.getElementById('policy-framework-select').value,
                language: lang
            })
        });
        const data = await res.json();
        
        if (data.success) {
            lastPolicyReview = data.review;
            document.getElementById('policy-review-content').innerHTML = marked.parse(data.review);
            document.getElementById('policy-review-output').classList.remove('hidden');
            Toast.success(isRtl ? 'ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­' : 'Review completed');
        } else {
            Toast.error(isRtl ? 'ÙØ´Ù„Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'Review failed');
        }
    } catch (e) {
        console.error('Review error:', e);
        Toast.error(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error');
    }
    
    hideLoading();
}

let lastPolicyReview = '';

async function applyReviewToPolicy() {
    if (!currentPolicyContent) {
        Toast.error(isRtl ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø³Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„' : 'No policy to modify');
        return;
    }
    
    const reviewContent = document.getElementById('policy-review-content').innerText || lastPolicyReview;
    if (!reviewContent) {
        Toast.error(isRtl ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'No review results to apply');
        return;
    }
    
    showLoading();
    
    try {
        // Step 1: Start the background task (returns immediately)
        const res = await fetch('/api/modify-policy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                policy_content: currentPolicyContent.substring(0, 6000),
                review_content: reviewContent.substring(0, 3000),
                framework: document.getElementById('policy-framework-select').value,
                domain: currentDomain,
                language: lang
            })
        });
        const startData = await res.json();
        
        if (!startData.success || !startData.task_id) {
            Toast.error(startData.error || (isRtl ? 'ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„' : 'Failed to start modification'));
            hideLoading();
            return;
        }
        
        // Step 2: Poll for result every 3 seconds
        const taskId = startData.task_id;
        let attempts = 0;
        const maxAttempts = 60; // 3 minutes max (60 * 3s)
        
        const pollInterval = setInterval(async () => {
            attempts++;
            try {
                const pollRes = await fetch(`/api/task-status/${taskId}`);
                const pollData = await pollRes.json();
                
                if (pollData.status === 'done') {
                    clearInterval(pollInterval);
                    policyData = pollData.modified_policy;
                    currentPolicyContent = pollData.modified_policy;
                    document.getElementById('policy-content').innerHTML = marked.parse(pollData.modified_policy);
                    document.getElementById('policy-review-output').classList.add('hidden');
                    Toast.success(isRtl ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­' : 'Policy modified successfully');
                    hideLoading();
                } else if (pollData.status === 'error') {
                    clearInterval(pollInterval);
                    Toast.error(pollData.error || (isRtl ? 'ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø³Ø©' : 'Policy modification failed'));
                    hideLoading();
                } else if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    Toast.error(isRtl ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' : 'Request timed out. Please try again.');
                    hideLoading();
                }
                // else status === 'pending', keep polling
            } catch (pollErr) {
                // Network error on poll â€” don't stop, try again next interval
                console.warn('Poll error (will retry):', pollErr);
                if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    Toast.error(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error');
                    hideLoading();
                }
            }
        }, 3000);
        
    } catch (e) {
        console.error('Modify policy error:', e);
        Toast.error(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' : 'Connection error. Please try again.');
        hideLoading();
    }
}

// ============================================================================
// GAP REMEDIATION FEATURE
// ============================================================================

function openRemediationModal() {
    document.getElementById('remediation-modal').classList.remove('hidden');
}

function closeRemediationModal() {
    document.getElementById('remediation-modal').classList.add('hidden');
}

async function generateRemediationPlan() {
    const gapsText = document.getElementById('gaps-input').value.trim();
    
    if (!gapsText) {
        alert(isRtl ? 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙØ¬ÙˆØ§Øª' : 'Please enter gaps');
        return;
    }
    
    const gaps = gapsText.split('\n').filter(g => g.trim());
    
    showLoading();
    
    try {
        const res = await fetch('/api/gap-remediation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                gaps: gaps,
                domain: currentDomain,
                framework: 'ISO 27001',
                language: lang
            })
        });
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('remediation-content').innerHTML = marked.parse(data.remediation_plan);
            document.getElementById('remediation-output').classList.remove('hidden');
            Toast.success(isRtl ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' : 'Remediation plan generated');
        } else {
            Toast.error(isRtl ? 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©' : 'Failed to generate plan');
        }
    } catch (e) {
        console.error('Remediation error:', e);
        Toast.error(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error');
    }
    
    hideLoading();
}

// ============================================================================
// ERM RISK REGISTER (only active when domain_code == 'erm')
// ============================================================================
{% if domain_code == 'erm' %}

let riskRegisterData = [];

function openAddRiskModal(editId) {
    if (editId !== undefined) {
        // Edit mode â€” pre-fill form
        const risk = riskRegisterData.find(r => r.id == editId);
        if (risk) {
            document.getElementById('risk-reg-name').value = risk.name;
            document.getElementById('risk-reg-desc').value = risk.description || '';
            document.getElementById('risk-reg-category').value = risk.category;
            document.getElementById('risk-reg-likelihood').value = risk.likelihood;
            document.getElementById('risk-reg-impact').value = risk.impact;
            document.getElementById('risk-reg-owner').value = risk.owner || '';
            document.getElementById('risk-reg-treatment').value = risk.treatment;
            document.getElementById('risk-reg-plan').value = risk.treatment_plan || '';
            document.getElementById('risk-reg-status').value = risk.status;
            document.getElementById('risk-reg-edit-id').value = editId;
        }
    } else {
        // New â€” clear form
        document.getElementById('risk-reg-name').value = '';
        document.getElementById('risk-reg-desc').value = '';
        document.getElementById('risk-reg-likelihood').value = '3';
        document.getElementById('risk-reg-impact').value = '3';
        document.getElementById('risk-reg-owner').value = '';
        document.getElementById('risk-reg-plan').value = '';
        document.getElementById('risk-reg-edit-id').value = '';
    }
    document.getElementById('add-risk-modal').classList.remove('hidden');
}

function closeAddRiskModal() {
    document.getElementById('add-risk-modal').classList.add('hidden');
}

async function saveRiskEntry() {
    const name = document.getElementById('risk-reg-name').value.trim();
    if (!name) { Toast.error(isRtl ? 'Ø§Ø³Ù… Ø§Ù„Ø®Ø·Ø± Ù…Ø·Ù„ÙˆØ¨' : 'Risk name is required'); return; }
    
    const editId = document.getElementById('risk-reg-edit-id').value;
    const payload = {
        name: name,
        description: document.getElementById('risk-reg-desc').value.trim(),
        category: document.getElementById('risk-reg-category').value,
        likelihood: parseInt(document.getElementById('risk-reg-likelihood').value),
        impact: parseInt(document.getElementById('risk-reg-impact').value),
        owner: document.getElementById('risk-reg-owner').value.trim(),
        treatment: document.getElementById('risk-reg-treatment').value,
        treatment_plan: document.getElementById('risk-reg-plan').value.trim(),
        status: document.getElementById('risk-reg-status').value,
        language: lang
    };
    
    try {
        let url = '/api/risk-register';
        let method = 'POST';
        if (editId) { url += '/' + editId; method = 'PUT'; }
        
        const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.success) {
            Toast.success(isRtl ? 'ØªÙ… Ø§Ù„Ø­ÙØ¸' : 'Saved');
            closeAddRiskModal();
            loadRiskRegister();
        } else {
            Toast.error(data.error || 'Error');
        }
    } catch (e) {
        Toast.error(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error');
    }
}

async function deleteRiskEntry(id) {
    if (!confirm(isRtl ? 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø±ØŸ' : 'Delete this risk?')) return;
    try {
        const res = await fetch('/api/risk-register/' + id, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) { loadRiskRegister(); Toast.success(isRtl ? 'ØªÙ… Ø§Ù„Ø­Ø°Ù' : 'Deleted'); }
    } catch (e) { Toast.error('Error'); }
}

async function loadRiskRegister() {
    try {
        const res = await fetch('/api/risk-register?lang=' + lang);
        const data = await res.json();
        if (data.success) {
            riskRegisterData = data.risks || [];
            renderRiskRegister();
            updateRiskStats();
            if (!document.getElementById('risk-heatmap').classList.contains('hidden')) {
                renderHeatMap();
            }
        }
    } catch (e) { console.error('Load risk register error:', e); }
}

function getRiskLevel(score) {
    if (score >= 20) return { level: isRtl ? 'Ø­Ø±Ø¬' : 'Critical', color: '#ef4444', cls: 'critical' };
    if (score >= 12) return { level: isRtl ? 'Ø¹Ø§Ù„ÙŠ' : 'High', color: '#f97316', cls: 'high' };
    if (score >= 6) return { level: isRtl ? 'Ù…ØªÙˆØ³Ø·' : 'Medium', color: '#eab308', cls: 'medium' };
    return { level: isRtl ? 'Ù…Ù†Ø®ÙØ¶' : 'Low', color: '#22c55e', cls: 'low' };
}

function renderRiskRegister() {
    const tbody = document.getElementById('risk-register-body');
    if (!riskRegisterData.length) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:2rem;color:#888;"><i class="fas fa-info-circle"></i> ' + (isRtl ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø·Ø± Ù…Ø³Ø¬Ù„Ø©.' : 'No risks registered.') + '</td></tr>';
        return;
    }
    
    // Sort by score descending
    const sorted = [...riskRegisterData].sort((a,b) => (b.likelihood * b.impact) - (a.likelihood * a.impact));
    
    tbody.innerHTML = sorted.map((r, idx) => {
        const score = r.likelihood * r.impact;
        const rl = getRiskLevel(score);
        const statusColors = {'Open':'#3b82f6','Ù…ÙØªÙˆØ­':'#3b82f6','In Treatment':'#f59e0b','Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©':'#f59e0b','Closed':'#22c55e','Ù…ØºÙ„Ù‚':'#22c55e','Accepted':'#6b7280','Ù…Ù‚Ø¨ÙˆÙ„':'#6b7280'};
        const sc = statusColors[r.status] || '#6b7280';
        return `<tr style="border-bottom:1px solid var(--border-color);">
            <td style="padding:10px 8px;">${idx+1}</td>
            <td style="padding:10px 8px;font-weight:600;">${r.name}</td>
            <td style="padding:10px 8px;">${r.category}</td>
            <td style="padding:10px 8px;text-align:center;">${r.likelihood}</td>
            <td style="padding:10px 8px;text-align:center;">${r.impact}</td>
            <td style="padding:10px 8px;text-align:center;"><span style="background:${rl.color};color:#fff;padding:3px 10px;border-radius:12px;font-weight:700;font-size:0.85rem;">${score}</span></td>
            <td style="padding:10px 8px;">${r.owner || '-'}</td>
            <td style="padding:10px 8px;">${r.treatment}</td>
            <td style="padding:10px 8px;"><span style="background:${sc};color:#fff;padding:3px 10px;border-radius:12px;font-size:0.8rem;">${r.status}</span></td>
            <td style="padding:10px 8px;text-align:center;white-space:nowrap;">
                <button onclick="openAddRiskModal(${r.id})" style="background:none;border:none;color:#3b82f6;cursor:pointer;font-size:1rem;padding:4px;" title="Edit"><i class="fas fa-edit"></i></button>
                <button onclick="deleteRiskEntry(${r.id})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:1rem;padding:4px;" title="Delete"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }).join('');
}

function updateRiskStats() {
    let critical=0, high=0, medium=0, low=0;
    riskRegisterData.forEach(r => {
        const score = r.likelihood * r.impact;
        if (score >= 20) critical++;
        else if (score >= 12) high++;
        else if (score >= 6) medium++;
        else low++;
    });
    document.getElementById('stat-critical').textContent = critical;
    document.getElementById('stat-high').textContent = high;
    document.getElementById('stat-medium').textContent = medium;
    document.getElementById('stat-low').textContent = low;
    document.getElementById('stat-total').textContent = riskRegisterData.length;
}

function toggleHeatMap() {
    const el = document.getElementById('risk-heatmap');
    el.classList.toggle('hidden');
    if (!el.classList.contains('hidden')) renderHeatMap();
}

function renderHeatMap() {
    const grid = document.getElementById('heatmap-grid');
    const impactLabels = isRtl 
        ? ['ÙƒØ§Ø±Ø«ÙŠ','ÙƒØ¨ÙŠØ±','Ù…ØªÙˆØ³Ø·','Ø·ÙÙŠÙ','Ø¶Ø¦ÙŠÙ„']
        : ['Catastrophic','Major','Moderate','Minor','Insignificant'];
    
    // Clear previous cells (keep header row = 6 children)
    while (grid.children.length > 6) grid.removeChild(grid.lastChild);
    
    // Build 5x5 grid (rows = impact 5 down to 1, cols = likelihood 1 to 5)
    for (let impact = 5; impact >= 1; impact--) {
        // Row label
        const label = document.createElement('div');
        label.style.cssText = 'padding:8px;font-weight:600;text-align:center;font-size:0.75rem;display:flex;align-items:center;justify-content:center;';
        label.textContent = impactLabels[5 - impact];
        grid.appendChild(label);
        
        for (let likelihood = 1; likelihood <= 5; likelihood++) {
            const score = impact * likelihood;
            const rl = getRiskLevel(score);
            const count = riskRegisterData.filter(r => r.likelihood == likelihood && r.impact == impact).length;
            
            const cell = document.createElement('div');
            cell.style.cssText = `background:${rl.color}22;border:2px solid ${rl.color}44;border-radius:6px;padding:8px 4px;text-align:center;min-height:40px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;`;
            cell.innerHTML = `<span style="font-size:0.7rem;color:#888;">${score}</span>` + 
                (count ? `<span style="background:${rl.color};color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;margin-top:2px;">${count}</span>` : '');
            grid.appendChild(cell);
        }
    }
}

async function generateRiskAppetite() {
    if (!riskRegisterData.length) {
        Toast.error(isRtl ? 'Ø£Ø¶Ù Ù…Ø®Ø§Ø·Ø± Ø£ÙˆÙ„Ø§Ù‹' : 'Add risks first');
        return;
    }
    showLoading();
    try {
        const res = await fetch('/api/risk-appetite', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ risks: riskRegisterData, language: lang })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('risk-appetite-content').innerHTML = marked.parse(data.content);
            document.getElementById('risk-appetite-output').classList.remove('hidden');
            riskAppetiteContent = data.content;
            Toast.success(isRtl ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù† Ø´Ù‡ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±' : 'Risk appetite statement generated');
        } else {
            Toast.error(data.error || 'Error');
        }
    } catch (e) { Toast.error(isRtl ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„' : 'Connection error'); }
    hideLoading();
}

let riskAppetiteContent = '';

function downloadRiskAppetite(fmt) {
    if (!riskAppetiteContent) return;
    downloadFile(riskAppetiteContent, 'risk_appetite_statement', fmt);
}

function exportRiskRegister() {
    if (!riskRegisterData.length) {
        Toast.error(isRtl ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ø·Ø± Ù„Ù„ØªØµØ¯ÙŠØ±' : 'No risks to export');
        return;
    }
    // Build markdown table
    let md = isRtl ? '# Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ©\n\n' : '# Enterprise Risk Register\n\n';
    md += isRtl 
        ? '| # | Ø§Ù„Ø®Ø·Ø± | Ø§Ù„ÙØ¦Ø© | Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© | Ø§Ù„Ø£Ø«Ø± | Ø§Ù„Ø¯Ø±Ø¬Ø© | Ø§Ù„Ù…Ø§Ù„Ùƒ | Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© | Ø§Ù„Ø­Ø§Ù„Ø© |\n|---|-------|-------|-----------|-------|--------|--------|---------|--------|\n'
        : '| # | Risk | Category | Likelihood | Impact | Score | Owner | Treatment | Status |\n|---|------|----------|-----------|--------|-------|-------|-----------|--------|\n';
    
    const sorted = [...riskRegisterData].sort((a,b) => (b.likelihood*b.impact) - (a.likelihood*a.impact));
    sorted.forEach((r, i) => {
        md += `| ${i+1} | ${r.name} | ${r.category} | ${r.likelihood} | ${r.impact} | ${r.likelihood*r.impact} | ${r.owner||'-'} | ${r.treatment} | ${r.status} |\n`;
    });
    
    md += '\n---\n' + (isRtl ? '**ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±:** ' : '**Export Date:** ') + new Date().toLocaleDateString(isRtl ? 'ar-SA' : 'en-US');
    downloadFile(md, 'risk_register', 'docx');
}

// Load risk register on tab activation
document.addEventListener('DOMContentLoaded', function() {
    const registerTab = document.querySelector('.tab[data-tab="register"]');
    if (registerTab) {
        registerTab.addEventListener('click', function() {
            if (!riskRegisterData.length || riskRegisterData._loaded !== true) {
                loadRiskRegister();
                riskRegisterData._loaded = true;
            }
        });
    }
});

{% endif %}

// ============================================================================
// AWARENESS MODULES
// ============================================================================

let awarenessModules = [];
let currentQuiz = null;
let currentQuizIdx = 0;
let quizAnswers = [];

function loadAwarenessModules() {
    fetch(`/api/awareness/modules?domain=${encodeURIComponent(currentDomain)}&lang=${lang}`)
    .then(r => { if (!checkSession(r)) throw new Error('session'); return r.json(); })
    .then(data => {
        if (!data.success) return;
        awarenessModules = data.modules;
        renderModulesGrid();
    })
    .catch(e => { if (e.message !== 'session') console.error('Awareness load error:', e); });
}

function renderModulesGrid() {
    const grid = document.getElementById('awareness-modules-grid');
    if (!grid) return;
    
    let completed = 0;
    let html = '';
    awarenessModules.forEach((m, idx) => {
        if (m.completed) completed++;
        const statusBadge = m.completed 
            ? (m.passed 
                ? `<span style="background:#22c55e;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.75rem;"><i class="fas fa-check"></i> ${isRtl ? 'Ù†Ø§Ø¬Ø­' : 'Passed'}</span>`
                : `<span style="background:#f59e0b;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.75rem;"><i class="fas fa-redo"></i> ${isRtl ? 'Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹' : 'Try Again'}</span>`)
            : `<span style="background:var(--border-color);color:var(--text-secondary);padding:3px 10px;border-radius:12px;font-size:0.75rem;">${isRtl ? 'Ù„Ù… ÙŠØ¨Ø¯Ø£' : 'Not Started'}</span>`;
        
        const scoreInfo = m.completed ? `<div style="font-size:0.8rem;color:var(--text-secondary);margin-top:0.3rem;">${isRtl ? 'Ø§Ù„Ù†ØªÙŠØ¬Ø©' : 'Score'}: ${m.user_score}/${m.user_total}</div>` : '';
        
        html += `
        <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:1.5rem;transition:all 0.2s;cursor:pointer;position:relative;${m.passed ? 'border-color:#22c55e33;' : ''}" 
             onmouseenter="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" 
             onmouseleave="this.style.transform='';this.style.boxShadow=''">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.8rem;">
                <div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;">
                    <i class="${m.icon}" style="color:#fff;font-size:1.1rem;"></i>
                </div>
                ${statusBadge}
            </div>
            <h3 style="margin:0 0 0.3rem;font-size:1rem;">${m.title}</h3>
            <div style="display:flex;gap:0.8rem;margin-bottom:0.6rem;font-size:0.8rem;color:var(--text-secondary);">
                <span><i class="fas fa-signal"></i> ${m.level}</span>
                <span><i class="fas fa-clock"></i> ${m.duration}</span>
                <span><i class="fas fa-question-circle"></i> ${m.quiz.length} ${isRtl ? 'Ø£Ø³Ø¦Ù„Ø©' : 'questions'}</span>
            </div>
            <p style="margin:0 0 1rem;font-size:0.85rem;color:var(--text-secondary);line-height:1.5;">${m.description}</p>
            ${scoreInfo}
            <div style="display:flex;gap:0.5rem;margin-top:0.8rem;">
                <button class="btn" onclick="event.stopPropagation();openLearnView(${idx})" style="flex:1;font-size:0.85rem;padding:0.5rem;">
                    <i class="fas fa-book-open"></i> ${isRtl ? 'ØªØ¹Ù„Ù‘Ù…' : 'Learn'}
                </button>
                <button class="btn btn-primary" onclick="event.stopPropagation();startQuiz(${idx})" style="flex:1;font-size:0.85rem;padding:0.5rem;">
                    <i class="fas fa-pen"></i> ${isRtl ? 'Ø§Ø®ØªØ¨Ø§Ø±' : 'Quiz'}
                </button>
            </div>
        </div>`;
    });
    grid.innerHTML = html;
    
    // Update progress
    const total = awarenessModules.length;
    const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
    const fill = document.getElementById('awareness-progress-fill');
    const txt = document.getElementById('awareness-progress-text');
    if (fill) fill.style.width = pct + '%';
    if (txt) txt.textContent = pct + '%';
}

function showAwarenessModules() {
    document.getElementById('awareness-modules-view').classList.remove('hidden');
    document.getElementById('awareness-learn-view').classList.add('hidden');
    document.getElementById('awareness-quiz-view').classList.add('hidden');
    document.getElementById('awareness-results-view').classList.add('hidden');
    loadAwarenessModules();
}

function openLearnView(idx) {
    const m = awarenessModules[idx];
    if (!m) return;
    
    document.getElementById('awareness-modules-view').classList.add('hidden');
    document.getElementById('awareness-learn-view').classList.remove('hidden');
    document.getElementById('awareness-quiz-view').classList.add('hidden');
    document.getElementById('awareness-results-view').classList.add('hidden');
    
    let html = `
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
        <div style="width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;">
            <i class="${m.icon}" style="color:#fff;font-size:1.3rem;"></i>
        </div>
        <div>
            <h2 style="margin:0;font-size:1.3rem;">${m.title}</h2>
            <div style="font-size:0.85rem;color:var(--text-secondary);">${m.level} â€¢ ${m.duration}</div>
        </div>
    </div>
    
    <h3 style="margin:1.5rem 0 0.8rem;color:var(--primary);"><i class="fas fa-lightbulb"></i> ${isRtl ? 'Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Key Learning Points'}</h3>
    <div style="display:flex;flex-direction:column;gap:0.6rem;">
        ${m.learning_points.map((p, i) => `
        <div style="display:flex;gap:0.8rem;align-items:flex-start;padding:0.8rem;background:var(--bg-card);border-radius:var(--radius-sm);border-${isRtl ? 'right' : 'left'}:3px solid var(--primary);">
            <span style="background:var(--primary);color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;flex-shrink:0;">${i+1}</span>
            <span style="font-size:0.9rem;line-height:1.5;">${p}</span>
        </div>`).join('')}
    </div>
    
    <h3 style="margin:1.5rem 0 0.8rem;color:#f59e0b;"><i class="fas fa-theater-masks"></i> ${isRtl ? 'Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ ØªØ·Ø¨ÙŠÙ‚ÙŠ' : 'Real-World Scenario'}</h3>
    <div style="background:linear-gradient(135deg,#fef3c7,#fde68a22);border:1px solid #f59e0b44;border-radius:var(--radius-lg);padding:1.5rem;">
        <h4 style="margin:0 0 0.5rem;color:#b45309;">${m.scenario.title}</h4>
        <p style="margin:0 0 1rem;line-height:1.6;font-size:0.9rem;">${m.scenario.text}</p>
        <div style="background:#fff8;border-radius:var(--radius-sm);padding:1rem;border-${isRtl ? 'right' : 'left'}:3px solid #22c55e;">
            <strong style="color:#22c55e;"><i class="fas fa-check-circle"></i> ${isRtl ? 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØµØ­ÙŠØ­:' : 'Correct Action:'}</strong>
            <p style="margin:0.3rem 0 0;font-size:0.9rem;line-height:1.5;">${m.scenario.correct_action}</p>
        </div>
    </div>
    
    <div style="text-align:center;margin-top:2rem;">
        <button class="btn btn-primary" onclick="startQuiz(${idx})" style="padding:0.8rem 2rem;font-size:1rem;">
            <i class="fas fa-pen"></i> ${isRtl ? 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†' : 'Start Quiz Now'}
        </button>
    </div>`;
    
    document.getElementById('awareness-learn-content').innerHTML = html;
}

function startQuiz(idx) {
    const m = awarenessModules[idx];
    if (!m) return;
    currentQuiz = m;
    currentQuizIdx = 0;
    quizAnswers = new Array(m.quiz.length).fill(-1);
    
    document.getElementById('awareness-modules-view').classList.add('hidden');
    document.getElementById('awareness-learn-view').classList.add('hidden');
    document.getElementById('awareness-quiz-view').classList.remove('hidden');
    document.getElementById('awareness-results-view').classList.add('hidden');
    
    renderQuizQuestion();
}

function renderQuizQuestion() {
    const q = currentQuiz.quiz[currentQuizIdx];
    const total = currentQuiz.quiz.length;
    const num = currentQuizIdx + 1;
    
    document.getElementById('quiz-progress-indicator').innerHTML = `
        <span style="font-weight:600;">${isRtl ? 'Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Question'} ${num}/${total}</span>
        <div style="display:inline-flex;gap:4px;margin-${isRtl ? 'right' : 'left'}:0.8rem;">
            ${currentQuiz.quiz.map((_, i) => `<div style="width:10px;height:10px;border-radius:50%;background:${i < num ? 'var(--primary)' : 'var(--border-color)'};"></div>`).join('')}
        </div>`;
    
    const selectedAnswer = quizAnswers[currentQuizIdx];
    
    let html = `
    <h3 style="margin:0 0 1.5rem;font-size:1.1rem;line-height:1.5;">${q.q}</h3>
    <div style="display:flex;flex-direction:column;gap:0.7rem;">
        ${q.options.map((opt, i) => `
        <button onclick="selectAnswer(${i})" style="
            text-align:${isRtl ? 'right' : 'left'};
            padding:1rem 1.2rem;
            border-radius:var(--radius-sm);
            border:2px solid ${selectedAnswer === i ? 'var(--primary)' : 'var(--border-color)'};
            background:${selectedAnswer === i ? 'var(--primary)11' : 'var(--bg-card)'};
            cursor:pointer;
            font-size:0.95rem;
            transition:all 0.15s;
            display:flex;align-items:center;gap:0.8rem;
            ${isRtl ? 'flex-direction:row-reverse;' : ''}
        " onmouseenter="if(${selectedAnswer}!==${i})this.style.borderColor='var(--primary)44'" 
           onmouseleave="if(${selectedAnswer}!==${i})this.style.borderColor='var(--border-color)'">
            <span style="width:28px;height:28px;border-radius:50%;border:2px solid ${selectedAnswer === i ? 'var(--primary)' : 'var(--border-color)'};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.8rem;font-weight:600;${selectedAnswer === i ? 'background:var(--primary);color:#fff;' : ''}">
                ${String.fromCharCode(65 + i)}
            </span>
            <span>${opt}</span>
        </button>`).join('')}
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:1.5rem;">
        <button class="btn" onclick="prevQuestion()" ${currentQuizIdx === 0 ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
            <i class="fas fa-arrow-${isRtl ? 'right' : 'left'}"></i> ${isRtl ? 'Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'Previous'}
        </button>
        ${currentQuizIdx === currentQuiz.quiz.length - 1 
            ? `<button class="btn btn-primary" onclick="submitQuiz()" ${selectedAnswer === -1 ? 'disabled style="opacity:0.6;"' : ''}>
                <i class="fas fa-paper-plane"></i> ${isRtl ? 'Ø¥Ø±Ø³Ø§Ù„' : 'Submit'}
               </button>`
            : `<button class="btn btn-primary" onclick="nextQuestion()" ${selectedAnswer === -1 ? 'disabled style="opacity:0.6;"' : ''}>
                ${isRtl ? 'Ø§Ù„ØªØ§Ù„ÙŠ' : 'Next'} <i class="fas fa-arrow-${isRtl ? 'left' : 'right'}"></i>
               </button>`
        }
    </div>`;
    
    document.getElementById('awareness-quiz-content').innerHTML = html;
}

function selectAnswer(i) {
    quizAnswers[currentQuizIdx] = i;
    renderQuizQuestion();
}

function nextQuestion() {
    if (currentQuizIdx < currentQuiz.quiz.length - 1) {
        currentQuizIdx++;
        renderQuizQuestion();
    }
}

function prevQuestion() {
    if (currentQuizIdx > 0) {
        currentQuizIdx--;
        renderQuizQuestion();
    }
}

function submitQuiz() {
    let score = 0;
    const total = currentQuiz.quiz.length;
    const results = [];
    
    currentQuiz.quiz.forEach((q, i) => {
        const correct = quizAnswers[i] === q.answer;
        if (correct) score++;
        results.push({question: q.q, userAnswer: q.options[quizAnswers[i]] || '-', correctAnswer: q.options[q.answer], correct: correct});
    });
    
    const pct = Math.round((score / total) * 100);
    const passed = pct >= 70;
    
    // Save to backend
    fetch('/api/awareness/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({module_id: currentQuiz.id, domain: currentDomain, score: score, total: total, language: lang})
    }).then(r => r.json()).catch(e => console.error(e));
    
    // Show results
    document.getElementById('awareness-modules-view').classList.add('hidden');
    document.getElementById('awareness-learn-view').classList.add('hidden');
    document.getElementById('awareness-quiz-view').classList.add('hidden');
    document.getElementById('awareness-results-view').classList.remove('hidden');
    
    let html = `
    <div style="max-width:600px;margin:0 auto;">
        <div style="width:100px;height:100px;border-radius:50%;background:${passed ? 'linear-gradient(135deg,#22c55e,#16a34a)' : 'linear-gradient(135deg,#f59e0b,#d97706)'};display:flex;align-items:center;justify-content:center;margin:0 auto 1.5rem;">
            <i class="fas ${passed ? 'fa-trophy' : 'fa-redo'}" style="color:#fff;font-size:2.5rem;"></i>
        </div>
        <h2 style="margin:0 0 0.3rem;">${passed ? (isRtl ? 'ğŸ‰ Ø£Ø­Ø³Ù†Øª!' : 'ğŸ‰ Excellent!') : (isRtl ? 'Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹' : 'Try Again')}</h2>
        <p style="color:var(--text-secondary);margin:0 0 1.5rem;">
            ${passed 
                ? (isRtl ? 'Ù„Ù‚Ø¯ Ø§Ø¬ØªØ²Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!' : 'You passed the quiz successfully!') 
                : (isRtl ? 'ØªØ­ØªØ§Ø¬ 70% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù†Ø¬Ø§Ø­. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.' : 'You need at least 70% to pass. Review the material and try again.')}
        </p>
        
        <div style="display:flex;justify-content:center;gap:2rem;margin-bottom:2rem;">
            <div style="text-align:center;">
                <div style="font-size:2.5rem;font-weight:700;color:${passed ? '#22c55e' : '#f59e0b'};">${pct}%</div>
                <div style="font-size:0.85rem;color:var(--text-secondary);">${isRtl ? 'Ø§Ù„Ù†ØªÙŠØ¬Ø©' : 'Score'}</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:2.5rem;font-weight:700;">${score}/${total}</div>
                <div style="font-size:0.85rem;color:var(--text-secondary);">${isRtl ? 'Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©' : 'Correct'}</div>
            </div>
        </div>
        
        <h3 style="text-align:${isRtl ? 'right' : 'left'};margin:1.5rem 0 0.8rem;">
            <i class="fas fa-list-check"></i> ${isRtl ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª' : 'Answer Review'}
        </h3>
        <div style="display:flex;flex-direction:column;gap:0.6rem;text-align:${isRtl ? 'right' : 'left'};">
            ${results.map((r, i) => `
            <div style="padding:0.8rem;border-radius:var(--radius-sm);border:1px solid ${r.correct ? '#22c55e44' : '#ef444444'};background:${r.correct ? '#22c55e08' : '#ef444408'};">
                <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.3rem;">
                    ${r.correct ? '<i class="fas fa-check-circle" style="color:#22c55e;"></i>' : '<i class="fas fa-times-circle" style="color:#ef4444;"></i>'}
                    ${isRtl ? 'Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Q'}${i+1}: ${r.question}
                </div>
                ${!r.correct ? `<div style="font-size:0.8rem;color:#ef4444;margin-bottom:0.2rem;">${isRtl ? 'Ø¥Ø¬Ø§Ø¨ØªÙƒ' : 'Your answer'}: ${r.userAnswer}</div>
                <div style="font-size:0.8rem;color:#22c55e;">${isRtl ? 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©' : 'Correct'}: ${r.correctAnswer}</div>` : ''}
            </div>`).join('')}
        </div>
        
        <div style="display:flex;gap:0.8rem;justify-content:center;margin-top:2rem;">
            <button class="btn" onclick="showAwarenessModules()" style="padding:0.7rem 1.5rem;">
                <i class="fas fa-th-large"></i> ${isRtl ? 'ÙƒÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª' : 'All Modules'}
            </button>
            ${!passed ? `<button class="btn btn-primary" onclick="startQuiz(awarenessModules.findIndex(m=>m.id==='${currentQuiz.id}'))" style="padding:0.7rem 1.5rem;">
                <i class="fas fa-redo"></i> ${isRtl ? 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Retry Quiz'}
            </button>` : ''}
        </div>
    </div>`;
    
    document.getElementById('awareness-results-content').innerHTML = html;
}

// Load awareness modules when tab is activated
document.addEventListener('DOMContentLoaded', function() {
    const awarenessTab = document.querySelector('.tab[data-tab="awareness"]');
    if (awarenessTab) {
        awarenessTab.addEventListener('click', function() {
            loadAwarenessModules();
        });
    }
});

</script>
{% endblock %}
