{% extends "base.html" %}
{% block content %}
<div class="login-page {{ 'rtl' if is_rtl else '' }}">
    <div class="login-bg"><div class="bg-gradient"></div><div class="bg-pattern"></div></div>
    <div class="login-theme-toggle"><button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"><i class="fas fa-sun"></i></button></div>

    <div class="login-container">
        <!-- Brand -->
        <div class="brand-header">
            <div class="brand-icon">‚öñÔ∏è</div>
            <div class="brand-name">{{ txt.app_name }}</div>
            <div class="brand-tagline">{{ txt.tagline }}</div>
        </div>

        <!-- Language Toggle -->
        <div class="lang-toggle">
            <a href="{{ url_for('login', lang='en') }}" class="lang-btn {{ 'active' if lang == 'en' else '' }}">English</a>
            <a href="{{ url_for('login', lang='ar') }}" class="lang-btn {{ 'active' if lang == 'ar' else '' }}">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a>
        </div>

        <!-- Flash Messages -->
        {% set flashed = get_flashed_messages(with_categories=true) %}
        {% if flashed %}
        {% for category, message in flashed %}
        <div class="alert {{ 'alert-error' if category == 'error' else 'alert-success' }}">
            <i class="fas {{ 'fa-exclamation-circle' if category == 'error' else 'fa-check-circle' }}"></i> {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        <!-- Pass flash context to JS for tab auto-switch -->
        <script>var _flashCtx = {{ flashed | tojson | safe }};</script>

        <!-- Welcome -->
        <div class="welcome-box">
            <h2>{{ txt.welcome }}</h2>
            <p>{{ txt.welcome_sub }}</p>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer-box">
            <div class="disclaimer-content">
                <div class="disclaimer-icon">üîí</div>
                <div class="disclaimer-text">
                    <p>{{ txt.disclaimer }}</p>
                    <p class="sensitive-warning"><i class="fas fa-shield-alt"></i> {{ txt.no_sensitive }}</p>
                </div>
            </div>
        </div>

        <!-- Auth Tabs -->
        <script>
        function showAuthTab(tab, btn) {
            document.querySelectorAll('.auth-tab').forEach(function(t){ t.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
        }
        </script>
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="showAuthTab('login', this)" id="tab-login">
                <i class="fas fa-sign-in-alt"></i> {{ txt.login }}
            </button>
            <button class="auth-tab" onclick="showAuthTab('register', this)" id="tab-register">
                <i class="fas fa-user-plus"></i> {{ txt.register }}
            </button>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="auth-form" method="POST" action="{{ url_for('login', lang=lang) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label><i class="fas fa-user"></i> {{ txt.username }}</label>
                <input type="text" name="username" placeholder="{{ txt.username }}" required autocomplete="username" maxlength="50">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> {{ txt.password }}</label>
                <input type="password" name="password" placeholder="{{ txt.password }}" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-sign-in-alt"></i> {{ txt.login }}
            </button>
        </form>

        <!-- Register Form (hidden by default) -->
        <form id="register-form" class="auth-form" method="POST" action="{{ url_for('register') }}" style="display:none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label><i class="fas fa-user"></i> {{ txt.username }}</label>
                <input type="text" name="username" placeholder="{% if is_rtl %}ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (3-50 ÿ≠ÿ±ŸÅ){% else %}Username (3-50 characters){% endif %}" required autocomplete="username" maxlength="50" pattern="[a-zA-Z0-9_]{3,50}">
            </div>
            <div class="form-group">
                <label><i class="fas fa-envelope"></i> {% if is_rtl %}ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä{% else %}Email{% endif %}</label>
                <input type="email" name="email" placeholder="{% if is_rtl %}ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä){% else %}Email (optional){% endif %}" autocomplete="email">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> {{ txt.password }}</label>
                <input type="password" name="password" id="reg-password" placeholder="{% if is_rtl %}ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± (8 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ){% else %}Password (min 8 characters){% endif %}" required autocomplete="new-password" minlength="8">
                <div class="password-strength" id="pw-strength" style="display:none;">
                    <div style="flex:1;height:4px;background:var(--bg-elevated);border-radius:2px;overflow:hidden;">
                        <div class="strength-bar" id="pw-bar" style="width:0%;height:100%;"></div>
                    </div>
                    <span class="strength-label" id="pw-label"></span>
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-user-plus"></i> {{ txt.register }}
            </button>
        </form>

        <!-- Footer -->
        <div class="creator-footer">
            <p class="created-by">{{ txt.created_by }}</p>
            <p class="creator-name">{{ config.CREATOR_NAME_AR if is_rtl else config.CREATOR_NAME }}</p>
            <p class="copyright">¬© {{ config.COPYRIGHT_YEAR }} {{ config.APP_NAME }} v{{ config.APP_VERSION }}</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Password strength indicator
var regPw = document.getElementById('reg-password');
if (regPw) {
    regPw.addEventListener('input', function() {
        var v = this.value;
        var el = document.getElementById('pw-strength');
        var bar = document.getElementById('pw-bar');
        var label = document.getElementById('pw-label');
        if (!v) { el.style.display = 'none'; return; }
        el.style.display = 'flex';
        var score = 0;
        if (v.length >= 8) score++;
        if (v.length >= 12) score++;
        if (/[A-Z]/.test(v)) score++;
        if (/[0-9]/.test(v)) score++;
        if (/[^A-Za-z0-9]/.test(v)) score++;
        var pct = Math.min(score * 20, 100);
        var colors = ['#ef4444','#f97316','#eab308','#22c55e','#22c55e'];
        var labels = {{ "['ÿ∂ÿπŸäŸÅ','ŸÖŸÇÿ®ŸàŸÑ','ŸÖÿ™Ÿàÿ≥ÿ∑','ŸÇŸàŸä','ŸÖŸÖÿ™ÿßÿ≤']" if is_rtl else "['Weak','Fair','Medium','Strong','Excellent']" }};
        bar.style.width = pct + '%';
        bar.style.background = colors[Math.min(score,4)];
        label.textContent = labels[Math.min(score,4)];
        label.style.color = colors[Math.min(score,4)];
    });
}

// Auto-switch tab based on URL hash or flash message context
document.addEventListener('DOMContentLoaded', function() {
    // 1) Hash-based: /login#register from landing page
    if (window.location.hash === '#register') {
        showAuthTab('register', document.getElementById('tab-register'));
    }
    // 2) Flash-based: registration errors ‚Üí stay on register tab
    if (typeof _flashCtx !== 'undefined' && _flashCtx.length > 0) {
        var hasRegErr = false, hasSuccess = false;
        for (var i = 0; i < _flashCtx.length; i++) {
            var msg = _flashCtx[i][1] || '';
            if (msg.indexOf('Account created') !== -1) { hasSuccess = true; }
            else if (msg.indexOf('Username') !== -1 || msg.indexOf('email') !== -1 || msg.indexOf('assword') !== -1 || msg.indexOf('Registration') !== -1 || msg.indexOf('limit reached') !== -1) { hasRegErr = true; }
        }
        // On success ‚Üí show login tab; on register error ‚Üí show register tab
        if (hasSuccess) showAuthTab('login', document.getElementById('tab-login'));
        else if (hasRegErr) showAuthTab('register', document.getElementById('tab-register'));
    }
});
</script>
{% endblock %}
