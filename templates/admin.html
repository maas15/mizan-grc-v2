<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Dashboard - {{ config.APP_NAME }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e4e4e4;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .header h1 { color: #d4af37; font-size: 1.8em; }
        .header-actions { display: flex; gap: 15px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }
        .btn-primary { background: #d4af37; color: #1a1a2e; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.08);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .stat-card h3 { color: #888; font-size: 0.9em; margin-bottom: 10px; }
        .stat-card .value { font-size: 2.5em; font-weight: bold; color: #d4af37; }
        .stat-card .sub { font-size: 0.85em; color: #666; margin-top: 5px; }
        
        /* Cards */
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            color: #d4af37;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { color: #d4af37; font-weight: 600; }
        tr:hover { background: rgba(255,255,255,0.03); }
        
        /* Status badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .badge-success { background: #27ae60; color: white; }
        .badge-danger { background: #e74c3c; color: white; }
        .badge-warning { background: #f39c12; color: white; }
        .badge-info { background: #3498db; color: white; }
        
        /* Charts area */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        .chart-item { text-align: center; }
        .chart-item h4 { margin-bottom: 15px; color: #aaa; }
        .domain-list { list-style: none; text-align: left; }
        .domain-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .domain-list .count { color: #d4af37; font-weight: bold; }
        
        /* Progress bar */
        .progress-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #f4d03f);
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        /* Action buttons */
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin: 0 2px;
        }
        .action-btn.toggle { background: #3498db; color: white; }
        .action-btn.delete { background: #e74c3c; color: white; }
        
        /* Logo */
        .logo { height: 50px; margin-right: 15px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center;">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Mizan Logo" class="logo">
                <div>
                    <h1>üõ°Ô∏è Admin Dashboard</h1>
                    <small style="color: #888;">{{ config.APP_NAME }} GRC Platform</small>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">üìä Main App</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger">üö™ Logout</a>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>üë• Total Users</h3>
                <div class="value">{{ stats.total_users }}</div>
                <div class="sub">of {{ stats.max_users }} max</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ (stats.total_users / stats.max_users * 100)|round(1) }}%"></div>
                </div>
            </div>
            <div class="stat-card">
                <h3>‚úÖ Active Users</h3>
                <div class="value">{{ stats.active_users }}</div>
            </div>
            <div class="stat-card">
                <h3>üìÑ Total Documents</h3>
                <div class="value">{{ stats.total_documents }}</div>
            </div>
            <div class="stat-card">
                <h3>üìã Strategies</h3>
                <div class="value">{{ stats.total_strategies }}</div>
            </div>
            <div class="stat-card">
                <h3>üìú Policies</h3>
                <div class="value">{{ stats.total_policies }}</div>
            </div>
            <div class="stat-card">
                <h3>üîç Audits</h3>
                <div class="value">{{ stats.total_audits }}</div>
            </div>
            <div class="stat-card">
                <h3>‚ö†Ô∏è Risk Analyses</h3>
                <div class="value">{{ stats.total_risks }}</div>
            </div>
        </div>
        
        <!-- Documents by Category -->
        <div class="card">
            <h2>üìä Documents by Domain</h2>
            <div class="charts-grid">
                <div class="chart-item">
                    <h4>Strategies</h4>
                    <ul class="domain-list">
                        {% for d in domains_strategies %}
                        <li><span>{{ d.domain or 'Unspecified' }}</span><span class="count">{{ d.count }}</span></li>
                        {% else %}
                        <li><span>No data</span></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="chart-item">
                    <h4>Policies</h4>
                    <ul class="domain-list">
                        {% for d in domains_policies %}
                        <li><span>{{ d.domain or 'Unspecified' }}</span><span class="count">{{ d.count }}</span></li>
                        {% else %}
                        <li><span>No data</span></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="chart-item">
                    <h4>Audits</h4>
                    <ul class="domain-list">
                        {% for d in domains_audits %}
                        <li><span>{{ d.domain or 'Unspecified' }}</span><span class="count">{{ d.count }}</span></li>
                        {% else %}
                        <li><span>No data</span></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="chart-item">
                    <h4>Risk Analyses</h4>
                    <ul class="domain-list">
                        {% for d in domains_risks %}
                        <li><span>{{ d.domain or 'Unspecified' }}</span><span class="count">{{ d.count }}</span></li>
                        {% else %}
                        <li><span>No data</span></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Recent Users -->
        <div class="card">
            <h2>üë• Recent Users</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in recent_users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email or '-' }}</td>
                        <td>
                            <span class="badge {% if user.role == 'admin' %}badge-warning{% else %}badge-info{% endif %}">
                                {{ user.role or 'user' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge {% if user.is_active %}badge-success{% else %}badge-danger{% endif %}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td>{{ user.created_at[:10] if user.created_at else '-' }}</td>
                        <td>{{ user.last_login[:16] if user.last_login else 'Never' }}</td>
                        <td>
                            {% if user.role != 'admin' %}
                            <form action="{{ url_for('toggle_user', user_id=user.id) }}" method="POST" style="display:inline;">
                                <button type="submit" class="action-btn toggle">
                                    {{ 'üö´' if user.is_active else '‚úÖ' }}
                                </button>
                            </form>
                            <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Delete this user?');">
                                <button type="submit" class="action-btn delete">üóëÔ∏è</button>
                            </form>
                            {% else %}
                            <span style="color:#888;">Protected</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- System Info -->
        <div class="card">
            <h2>‚ÑπÔ∏è System Information</h2>
            <table>
                <tr><td>App Version</td><td>{{ config.APP_VERSION }}</td></tr>
                <tr><td>Max Users</td><td>{{ stats.max_users }}</td></tr>
                <tr><td>Registration Status</td><td>
                    <span class="badge {% if stats.total_users < stats.max_users %}badge-success{% else %}badge-danger{% endif %}">
                        {{ 'Open' if stats.total_users < stats.max_users else 'Closed' }}
                    </span>
                </td></tr>
            </table>
        </div>
        
        <!-- Benchmark Management -->
        <div class="card">
            <h2>üìä Industry Benchmarks</h2>
            <p style="color: #888; margin-bottom: 15px;">Manage benchmark data for sector comparisons</p>
            <table>
                <thead>
                    <tr>
                        <th>Sector</th>
                        <th>Compliance %</th>
                        <th>Maturity (1-5)</th>
                        <th>Risk Coverage %</th>
                        <th>Policies Avg</th>
                        <th>Source</th>
                        <th>Year</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for b in benchmarks %}
                    <tr>
                        <td><strong>{{ b.sector }}</strong><br><small style="color:#888;">{{ b.sector_ar }}</small></td>
                        <td>
                            <input type="number" class="benchmark-input" id="compliance-{{ b.id }}" 
                                   value="{{ b.compliance_score_avg }}" min="0" max="100" step="1">
                        </td>
                        <td>
                            <input type="number" class="benchmark-input" id="maturity-{{ b.id }}" 
                                   value="{{ b.maturity_level_avg }}" min="1" max="5" step="0.1">
                        </td>
                        <td>
                            <input type="number" class="benchmark-input" id="risk-{{ b.id }}" 
                                   value="{{ b.risk_coverage_avg }}" min="0" max="100" step="1">
                        </td>
                        <td>
                            <input type="number" class="benchmark-input" id="policies-{{ b.id }}" 
                                   value="{{ b.policy_count_avg }}" min="0" step="1">
                        </td>
                        <td>
                            <input type="text" class="benchmark-input" id="source-{{ b.id }}" 
                                   value="{{ b.source }}" style="width: 120px;">
                        </td>
                        <td>
                            <input type="number" class="benchmark-input" id="year-{{ b.id }}" 
                                   value="{{ b.source_year }}" min="2020" max="2030">
                        </td>
                        <td>
                            <button class="action-btn toggle" onclick="updateBenchmark({{ b.id }})">üíæ</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Footer -->
        <div style="text-align: center; padding: 20px; color: #666;">
            <p>{{ config.APP_NAME }} GRC Platform v{{ config.APP_VERSION }}</p>
            <p>Created by {{ config.CREATOR_NAME }}</p>
        </div>
    </div>
    
    <style>
        .benchmark-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            padding: 5px 8px;
            color: #e4e4e4;
            width: 60px;
            text-align: center;
        }
        .benchmark-input:focus {
            outline: none;
            border-color: #d4af37;
        }
    </style>
    
    <script>
        function updateBenchmark(id) {
            const data = {
                compliance_score_avg: document.getElementById('compliance-' + id).value,
                maturity_level_avg: document.getElementById('maturity-' + id).value,
                risk_coverage_avg: document.getElementById('risk-' + id).value,
                policy_count_avg: document.getElementById('policies-' + id).value,
                source: document.getElementById('source-' + id).value,
                source_year: document.getElementById('year-' + id).value
            };
            
            fetch('/admin/api/benchmark/' + id, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    alert('Benchmark updated successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(err => alert('Error updating benchmark'));
        }
        
        // Auto-refresh stats every 60 seconds
        setInterval(() => {
            fetch('/admin/api/stats')
                .then(r => r.json())
                .then(data => {
                    console.log('Stats updated:', data);
                })
                .catch(err => console.error('Stats refresh failed:', err));
        }, 60000);
    </script>
</body>
</html>
