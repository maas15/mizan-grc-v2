{% extends "base.html" %}

{% block content %}
<div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar {{ 'sidebar-right' if is_rtl else 'sidebar-left' }}">
        <div class="sidebar-brand">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Mizan Logo" class="sidebar-logo">
        </div>
        <div class="sidebar-controls">
            <div class="sidebar-lang">
                <a href="{{ url_for('profile_page', lang='en') }}" class="lang-btn {{ 'active' if lang == 'en' else '' }}">EN</a>
                <a href="{{ url_for('profile_page', lang='ar') }}" class="lang-btn {{ 'active' if lang == 'ar' else '' }}">ع</a>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <i class="fas fa-sun"></i>
            </button>
        </div>
        <div class="user-info">
            <div class="user-avatar"><i class="fas fa-user"></i></div>
            <div class="user-details">
                <span class="user-label">{{ txt.logged_in_as }}</span>
                <span class="user-name">{{ username }}</span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard', lang=lang) }}" class="nav-item">
                <i class="fas fa-home"></i>
                <span>{% if is_rtl %}الرئيسية{% else %}Dashboard{% endif %}</span>
            </a>
            {% for domain in domains %}
            <a href="{{ url_for('domain_page', domain_name=domain, lang=lang) }}" class="nav-item">
                {% if 'Cyber' in domain %}<i class="fas fa-shield-alt"></i>
                {% elif 'Data' in domain %}<i class="fas fa-database"></i>
                {% elif 'AI' in domain %}<i class="fas fa-robot"></i>
                {% elif 'Digital' in domain %}<i class="fas fa-digital-tachograph"></i>
                {% else %}<i class="fas fa-globe"></i>{% endif %}
                <span>{{ domain }}</span>
            </a>
            {% endfor %}
            <a href="{{ url_for('document_history', lang=lang) }}" class="nav-item nav-history">
                <i class="fas fa-folder-open"></i><span>{{ txt.my_documents }}</span>
            </a>
            <a href="{{ url_for('analytics_page', lang=lang) }}" class="nav-item nav-analytics">
                <i class="fas fa-chart-line"></i><span>{{ txt.analytics }}</span>
            </a>
        </nav>
        <div class="ai-status {{ 'connected' if ai_available else 'disconnected' }}">
            <div class="status-dot"></div>
            <span>{{ txt.ai_connected if ai_available else txt.ai_disconnected }}</span>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> {{ txt.logout }}
        </a>
        <div class="sidebar-footer">
            <p class="created-by">{{ txt.created_by }}</p>
            <p class="creator-name">{{ config.CREATOR_NAME }}</p>
            <p class="copyright">© {{ config.COPYRIGHT_YEAR }}</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="main-header">
            <h1><i class="fas fa-user-circle"></i> {{ txt.my_profile }}</h1>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="flash-msg flash-{{ category }}" style="padding:1rem;margin:0 0 1.5rem;border-radius:10px;
            background:{% if category == 'success' %}rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);color:#10b981{% else %}rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#ef4444{% endif %};">
            <i class="fas {% if category == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %}"></i> {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
            <!-- Account Info Card -->
            <div class="stat-card" style="padding:2rem;grid-column:span 1;">
                <h3 style="margin-bottom:1.5rem;font-size:1.1rem;"><i class="fas fa-id-card"></i> {{ txt.account_info }}</h3>
                <div style="display:flex;flex-direction:column;gap:1rem;">
                    <div style="display:flex;justify-content:space-between;padding:0.75rem 0;border-bottom:1px solid var(--border-color,rgba(255,255,255,0.08));">
                        <span style="color:var(--text-muted,#94a3b8);">{{ txt.username }}</span>
                        <span style="font-weight:600;">{{ user.username }}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:0.75rem 0;border-bottom:1px solid var(--border-color,rgba(255,255,255,0.08));">
                        <span style="color:var(--text-muted,#94a3b8);">{% if is_rtl %}البريد الإلكتروني{% else %}Email{% endif %}</span>
                        <span style="font-weight:600;">{{ user.email or '—' }}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:0.75rem 0;border-bottom:1px solid var(--border-color,rgba(255,255,255,0.08));">
                        <span style="color:var(--text-muted,#94a3b8);">{{ txt.member_since }}</span>
                        <span style="font-weight:600;">{{ user.created_at[:10] if user.created_at else '—' }}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:0.75rem 0;">
                        <span style="color:var(--text-muted,#94a3b8);">{{ txt.total_documents }}</span>
                        <span style="font-weight:700;font-size:1.2rem;color:var(--accent,#6366f1);">{{ total_docs }}</span>
                    </div>
                </div>
            </div>

            <!-- Change Password Card -->
            <div class="stat-card" style="padding:2rem;grid-column:span 1;">
                <h3 style="margin-bottom:1.5rem;font-size:1.1rem;"><i class="fas fa-key"></i> {{ txt.change_password }}</h3>
                <form method="POST" action="{{ url_for('change_password') }}" style="display:flex;flex-direction:column;gap:1rem;">
                    <div>
                        <label style="font-size:0.85rem;color:var(--text-muted,#94a3b8);margin-bottom:0.3rem;display:block;">{{ txt.current_password }}</label>
                        <input type="password" name="current_password" required style="width:100%;padding:0.65rem 1rem;border-radius:8px;border:1px solid var(--border-color,rgba(255,255,255,0.1));background:var(--input-bg,rgba(255,255,255,0.05));color:var(--text-primary,#e2e8f0);font-size:0.95rem;">
                    </div>
                    <div>
                        <label style="font-size:0.85rem;color:var(--text-muted,#94a3b8);margin-bottom:0.3rem;display:block;">{{ txt.new_password }}</label>
                        <input type="password" name="new_password" required minlength="8" style="width:100%;padding:0.65rem 1rem;border-radius:8px;border:1px solid var(--border-color,rgba(255,255,255,0.1));background:var(--input-bg,rgba(255,255,255,0.05));color:var(--text-primary,#e2e8f0);font-size:0.95rem;">
                    </div>
                    <div>
                        <label style="font-size:0.85rem;color:var(--text-muted,#94a3b8);margin-bottom:0.3rem;display:block;">{{ txt.confirm_password }}</label>
                        <input type="password" name="confirm_password" required minlength="8" style="width:100%;padding:0.65rem 1rem;border-radius:8px;border:1px solid var(--border-color,rgba(255,255,255,0.1));background:var(--input-bg,rgba(255,255,255,0.05));color:var(--text-primary,#e2e8f0);font-size:0.95rem;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top:0.5rem;">
                        <i class="fas fa-save"></i> {{ txt.update_password }}
                    </button>
                </form>
            </div>
        </div>

        <!-- Usage Per Domain -->
        <div class="stat-card" style="padding:2rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
                <h3 style="font-size:1.1rem;"><i class="fas fa-chart-bar"></i> {{ txt.usage_summary }}</h3>
                <a href="{{ url_for('export_all_documents') }}" class="btn btn-secondary" style="font-size:0.85rem;">
                    <i class="fas fa-download"></i> {{ txt.export_all }}
                </a>
            </div>
            
            {% if domain_stats %}
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;">
                {% for domain, stats in domain_stats.items() %}
                <div style="padding:1.25rem;border-radius:12px;background:var(--input-bg,rgba(255,255,255,0.03));border:1px solid var(--border-color,rgba(255,255,255,0.08));">
                    <h4 style="font-size:0.95rem;margin-bottom:1rem;">{{ domain }}</h4>
                    
                    <div style="display:flex;flex-direction:column;gap:0.6rem;font-size:0.85rem;">
                        {% for label, key, limit_key in [
                            (txt.tabs[0], 'strategies', 'strategy_limit'),
                            (txt.tabs[1], 'policies', 'policy_limit'),
                            (txt.tabs[2] if txt.tabs|length > 2 else 'Audit', 'audits', 'audit_limit'),
                            (txt.tabs[3] if txt.tabs|length > 3 else 'Risk', 'risks', 'risk_limit')
                        ] %}
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span style="color:var(--text-muted,#94a3b8);">{{ label }}</span>
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <div style="width:80px;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;">
                                    <div style="height:100%;background:{% if stats[key] >= stats[limit_key] %}#ef4444{% else %}#6366f1{% endif %};border-radius:3px;width:{{ (stats[key] / stats[limit_key] * 100) if stats[limit_key] > 0 else 0 }}%;"></div>
                                </div>
                                <span style="font-weight:600;{% if stats[key] >= stats[limit_key] %}color:#ef4444;{% endif %}">{{ stats[key] }}/{{ stats[limit_key] }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="color:var(--text-muted,#94a3b8);text-align:center;padding:2rem;">
                {{ txt.no_data }}
            </p>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}
